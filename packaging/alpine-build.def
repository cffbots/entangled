Bootstrap: library
From: alpine:latest

%environment
    export PATH="${HOME}/.cabal/bin:${HOME}/.ghcup/bin:${PATH}"

%post
    apk update
    apk add curl gcc g++ gmp-dev ncurses-dev libffi-dev make xz tar perl \
            zlib-dev ncurses-static zlib-static coreutils bash patch guile

    mkdir -p ~/.ghcup/bin
    curl https://downloads.haskell.org/~ghcup/0.1.5/x86_64-linux-ghcup-0.1.5 > ~/.ghcup/bin/ghcup
    chmod +x ~/.ghcup/bin/ghcup
    export PATH="${HOME}/.cabal/bin:${HOME}/.ghcup/bin:${PATH}"
    ghcup install 8.6
    ghcup set 8.6
    ghcup install-cabal
    cabal update
    echo "split-sections: True" >> .cabal/config

%runscript
    cd /mnt
    rm -f cabal.project.local
    cabal configure --disable-executable-dynamic --disable-shared \
                    --ghc-option=-optl=-static --enable-split-sections
    make dist

%help
    This container should build a static binary distribution in Alpine
    linux. Run this image with `--no-home --bind .:/mnt --writable`.
    The distribution should end up as a .tar.xz file in dist-newstyle.
