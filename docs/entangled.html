<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Johan Hidding" />
  <title>Entangled, literate programming Swiss army knife</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  { color: #eeeeee; background-color: #303030; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffcfaf; } /* Alert */
code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #aadfff; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #aaffdf; font-weight: bold; } /* ControlFlow */
code span.ch { color: #dca3a3; } /* Char */
code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
code span.co { color: #7f9f7f; } /* Comment */
code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
code span.do { color: #7f9f7f; } /* Documentation */
code span.dt { color: #dfdfbf; } /* DataType */
code span.dv { color: #aaffdf; } /* DecVal */
code span.er { color: #c3bf9f; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #c0bed1; } /* Float */
code span.fu { color: #efef8f; } /* Function */
code span.im { } /* Import */
code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
code span.kw { color: #aaccef; font-weight: bold; } /* Keyword */
code span.op { color: #cceeff; } /* Operator */
code span.ot { color: #efef8f; } /* Other */
code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
code span.sc { color: #dca3a3; } /* SpecialChar */
code span.ss { color: #cc9393; } /* SpecialString */
code span.st { color: #aaffdf; font-style: italic; } /* String */
code span.va { } /* Variable */
code span.vs { color: #cc9393; } /* VerbatimString */
code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */
  </style>
  <link rel="stylesheet" href="nlesc.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>
 <div id="title-block-header">
<h1 class="title">Entangled, literate programming Swiss army knife</h1>
</div> 
<div id="topbar">
<p>&nbsp;</p>
</div>
 <div id="toc">
<ul>
<li><a href="#preliminaries">Preliminaries</a><ul>
<li><a href="#modules">Modules</a><ul>
<li><a href="#map">Map</a></li>
<li><a href="#set">Set</a></li>
</ul></li>
<li><a href="#text">Text</a><ul>
<li><a href="#textutils-module"><code>TextUtils</code> module</a></li>
<li><a href="#megaparsec">MegaParsec</a></li>
</ul></li>
<li><a href="#errors">Errors</a></li>
</ul></li>
<li><a href="#main-program">Main program</a><ul>
<li><a href="#encoding">Encoding</a></li>
<li><a href="#options">Options</a><ul>
<li><a href="#starting-the-daemon">Starting the daemon</a></li>
<li><a href="#printing-the-config">Printing the config</a></li>
<li><a href="#inserting-files-to-the-database">Inserting files to the database</a></li>
<li><a href="#tangling-a-single-reference">Tangling a single reference</a></li>
<li><a href="#stitching-a-markdown-source">Stitching a markdown source</a></li>
<li><a href="#listing-all-target-files">Listing all target files</a></li>
</ul></li>
<li><a href="#main">Main</a></li>
<li><a href="#generics">Generics</a><ul>
<li><a href="#create-the-empty-database">Create the empty database</a></li>
<li><a href="#simple-io-logger">Simple IO logger</a></li>
</ul></li>
<li><a href="#tangle">Tangle</a></li>
<li><a href="#stitch">Stitch</a></li>
<li><a href="#list">List</a></li>
<li><a href="#insert">Insert</a></li>
</ul></li>
<li><a href="#document-structure">Document structure</a><ul>
<li><a href="#structure">Structure</a><ul>
<li><a href="#reference-id">Reference Id</a></li>
<li><a href="#document">Document</a></li>
<li><a href="#accessors">Accessors</a></li>
<li><a href="#code-blocks">Code blocks</a></li>
</ul></li>
<li><a href="#conversion">Conversion</a></li>
</ul></li>
<li><a href="#database">Database</a><ul>
<li><a href="#types">Types</a></li>
<li><a href="#create-database">Create database</a></li>
<li><a href="#insertion">Insertion</a><ul>
<li><a href="#documents">Documents</a></li>
<li><a href="#codes">Codes</a></li>
<li><a href="#classes-and-attributes">Classes and attributes</a></li>
<li><a href="#content">Content</a></li>
<li><a href="#targets">Targets</a></li>
</ul></li>
<li><a href="#updating">Updating</a><ul>
<li><a href="#tangle-1">Tangle</a></li>
<li><a href="#stitch-1">Stitch</a></li>
</ul></li>
<li><a href="#queries">Queries</a><ul>
<li><a href="#references">References</a></li>
<li><a href="#document-1">Document</a></li>
</ul></li>
</ul></li>
<li><a href="#the-daemon">The Daemon</a><ul>
<li><a href="#strategy">Strategy</a><ul>
<li><a href="#fsnotify">FSNotify</a></li>
<li><a href="#transactions">Transactions</a></li>
<li><a href="#session">Session</a></li>
<li><a href="#file-io">File IO</a></li>
</ul></li>
<li><a href="#watching">Watching</a></li>
<li><a href="#loading">Loading</a></li>
<li><a href="#writing">Writing</a></li>
<li><a href="#main-loop">Main loop</a></li>
<li><a href="#initialisation">Initialisation</a></li>
</ul></li>
<li><a href="#configuration">Configuration</a><ul>
<li><a href="#defaults">Defaults</a><ul>
<li><a href="#reading-config-files">Reading config files</a></li>
</ul></li>
<li><a href="#processing">Processing</a></li>
</ul></li>
<li><a href="#logging">Logging</a></li>
<li><a href="#parsing-anything-with-megaparsec">Parsing anything with Megaparsec</a><ul>
<li><a href="#text-parser-tokens">Text-parser tokens</a></li>
<li><a href="#testing-on-lists">Testing on lists</a><ul>
<li><a href="#lists-of-integers">Lists of integers</a></li>
</ul></li>
</ul></li>
<li><a href="#untangling">Untangling</a><ul>
<li><a href="#the-stitch-function">The <code>stitch</code> function</a></li>
<li><a href="#imports">Imports</a></li>
</ul></li>
<li><a href="#tangling">Tangling</a><ul>
<li><a href="#css-attributes">CSS Attributes</a></li>
<li><a href="#quasi-parsing-markdown">Quasi-parsing Markdown</a><ul>
<li><a href="#parsing-code-blocks">Parsing code blocks</a></li>
<li><a href="#parsing-single-lines">Parsing single lines</a></li>
<li><a href="#extracting-data-from-a-list-of-codeproperty">Extracting data from a list of <code>CodeProperty</code></a></li>
<li><a href="#references-1">References</a></li>
<li><a href="#parsing-the-document">Parsing the document</a></li>
</ul></li>
<li><a href="#generating-output-files">Generating output files</a><ul>
<li><a href="#indentation">Indentation</a></li>
</ul></li>
<li><a href="#code-expansion">Code expansion</a></li>
<li><a href="#entangled-comments">Entangled comments</a><ul>
<li><a href="#parsing-comments">Parsing comments</a></li>
</ul></li>
<li><a href="#testing">Testing</a></li>
</ul></li>
</ul>
</div> 
<div id="content">
<p>Entangled makes writing literate programs easier by keeping code blocks in markdown up-to-date with generated source files. By monitoring the tangled source files, any change in the master document or source files is reflected in the other. In practice this means:</p>
<ul>
<li>Write well documented code using Markdown.</li>
<li>Use any programming language you like (or are forced to use).</li>
<li>Keep debugging and using other IDE features without change.</li>
<li>Generate a report in PDF or HTML from the same source (see examples on the right).</li>
</ul>
<h1 id="preliminaries">Preliminaries</h1>
<h2 id="modules">Modules</h2>
<p>Several modules have standard stature but have to be imported qualified due to clashes in the namespace.</p>
<h3 id="map">Map</h3>
<p>We use strict maps by default.</p>
<div class="annotated-code">
<p><span><em>«import-map»=</em></span></p>
<div class="sourceCode" id="import-map"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="import-map-1"><a href="#import-map-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Strict</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="import-map-2"><a href="#import-map-2"></a><span class="kw">import</span> <span class="dt">Data.Map.Strict</span> (<span class="dt">Map</span>)</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«import-lazy-map»=</em></span></p>
<div class="sourceCode" id="import-lazy-map"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="import-lazy-map-1"><a href="#import-lazy-map-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Lazy</span> <span class="kw">as</span> <span class="dt">LM</span></span></code></pre></div>
</div>
<h3 id="set">Set</h3>
<div class="annotated-code">
<p><span><em>«import-set»=</em></span></p>
<div class="sourceCode" id="import-set"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="import-set-1"><a href="#import-set-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Set</span> <span class="kw">as</span> <span class="dt">S</span></span>
<span id="import-set-2"><a href="#import-set-2"></a><span class="kw">import</span> <span class="dt">Data.Set</span> (<span class="dt">Set</span>)</span></code></pre></div>
</div>
<h2 id="text">Text</h2>
<p>We will be using the <code>Text</code> module everywhere.</p>
<div class="annotated-code">
<p><span><em>«import-text»=</em></span></p>
<div class="sourceCode" id="import-text"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="import-text-1"><a href="#import-text-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="import-text-2"><a href="#import-text-2"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span></code></pre></div>
</div>
<p>We need a version of <code>unlines</code> that doesn’t append a final newline. This also means changing <code>T.lines</code> a little.</p>
<div class="annotated-code">
<p><span><em>«unlines»=</em></span></p>
<div class="sourceCode" id="unlines"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="unlines-1"><a href="#unlines-1"></a><span class="ot">lines&#39; ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> [<span class="dt">Text</span>]</span>
<span id="unlines-2"><a href="#unlines-2"></a>lines&#39; text</span>
<span id="unlines-3"><a href="#unlines-3"></a>    <span class="op">|</span> text <span class="op">==</span> <span class="st">&quot;&quot;</span>               <span class="ot">=</span> [<span class="st">&quot;&quot;</span>]</span>
<span id="unlines-4"><a href="#unlines-4"></a>    <span class="op">|</span> <span class="st">&quot;\n&quot;</span> <span class="ot">`T.isSuffixOf`</span> text <span class="ot">=</span> T.lines text <span class="op">&lt;&gt;</span> [<span class="st">&quot;&quot;</span>]</span>
<span id="unlines-5"><a href="#unlines-5"></a>    <span class="op">|</span> <span class="fu">otherwise</span>                <span class="ot">=</span> T.lines text</span>
<span id="unlines-6"><a href="#unlines-6"></a></span>
<span id="unlines-7"><a href="#unlines-7"></a><span class="ot">unlines&#39; ::</span> [<span class="dt">Text</span>] <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="unlines-8"><a href="#unlines-8"></a>unlines&#39; <span class="ot">=</span> T.intercalate <span class="st">&quot;\n&quot;</span></span></code></pre></div>
</div>
<p>This way, <code>unlines'</code> has nicer properties. No single <code>Text</code> in Entangled ends in a newline, meaning the <code>unlines'</code> operation is associative:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a>unlines&#39; [unlines&#39; a, unlines&#39; b] <span class="ot">=</span> unlines&#39; (a <span class="op">&lt;&gt;</span> b)</span></code></pre></div>
<p>With the notable exception of empty lists. The <code>[Text]</code> type is a proper monoid, however when we consider <code>Text</code> itself in the context of an element of an <code>unlines</code>ed text, the zero element for <code>Text</code>, being <code>""</code> changes meaning. An empty line is something different than the absence of text. To preserve both associativity and make the <code>unlines . lines = id</code> property more strict we need to wrap <code>Text</code> in a <code>Maybe</code>.</p>
<div class="annotated-code">
<p><span><em>«maybe-unlines»=</em></span></p>
<div class="sourceCode" id="maybe-unlines"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="maybe-unlines-1"><a href="#maybe-unlines-1"></a><span class="ot">mLines ::</span> <span class="dt">Maybe</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> [<span class="dt">Text</span>]</span>
<span id="maybe-unlines-2"><a href="#maybe-unlines-2"></a>mLines <span class="dt">Nothing</span> <span class="ot">=</span> []</span>
<span id="maybe-unlines-3"><a href="#maybe-unlines-3"></a>mLines (<span class="dt">Just</span> text) <span class="ot">=</span> lines&#39; text</span>
<span id="maybe-unlines-4"><a href="#maybe-unlines-4"></a></span>
<span id="maybe-unlines-5"><a href="#maybe-unlines-5"></a><span class="ot">mUnlines ::</span> [<span class="dt">Text</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Text</span></span>
<span id="maybe-unlines-6"><a href="#maybe-unlines-6"></a>mUnlines [] <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="maybe-unlines-7"><a href="#maybe-unlines-7"></a>mUnlines ts <span class="ot">=</span> <span class="dt">Just</span> <span class="op">$</span> unlines&#39; ts</span></code></pre></div>
</div>
<p>Now we can test:</p>
<div class="annotated-code">
<p><span><em>«test-unlines-inverse»=</em></span></p>
<div class="sourceCode" id="test-unlines-inverse"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="test-unlines-inverse-1"><a href="#test-unlines-inverse-1"></a>t <span class="op">==</span> mUnlines (mLines t)</span></code></pre></div>
</div>
<p>and</p>
<div class="annotated-code">
<p><span><em>«test-unlines-associative»=</em></span></p>
<div class="sourceCode" id="test-unlines-associative"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="test-unlines-associative-1"><a href="#test-unlines-associative-1"></a>mUnlines (catMaybes [mUnlines a, mUnlines b]) <span class="op">==</span> mUnlines (a <span class="op">&lt;&gt;</span> b)</span></code></pre></div>
</div>
<p>Also composing <code>T.pack</code> and <code>show</code> as a usefule shorthand:</p>
<div class="annotated-code">
<p><span><em>«tshow»=</em></span></p>
<div class="sourceCode" id="tshow"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="tshow-1"><a href="#tshow-1"></a><span class="ot">tshow ::</span> (<span class="dt">Show</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="tshow-2"><a href="#tshow-2"></a>tshow <span class="ot">=</span> T.pack <span class="op">.</span> <span class="fu">show</span></span></code></pre></div>
</div>
<h3 id="textutils-module"><code>TextUtils</code> module</h3>
<div class="annotated-code">
<p><span><em>«src/TextUtil.hs»=</em></span></p>
<div class="sourceCode" id="cb2" data-file="src/TextUtil.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">module</span> <span class="dt">TextUtil</span> <span class="kw">where</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">import</span> <span class="dt">Data.Char</span> (isSpace)</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">import</span> <span class="dt">Data.Maybe</span> (isNothing, catMaybes)</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="op">&lt;&lt;</span>indent<span class="op">&gt;&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="op">&lt;&lt;</span>unindent<span class="op">&gt;&gt;</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="op">&lt;&lt;</span><span class="fu">unlines</span><span class="op">&gt;&gt;</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="op">&lt;&lt;</span><span class="fu">maybe</span><span class="op">-</span><span class="fu">unlines</span><span class="op">&gt;&gt;</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="op">&lt;&lt;</span>tshow<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«indent»=</em></span></p>
<div class="sourceCode" id="indent"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="indent-1"><a href="#indent-1"></a><span class="ot">indent ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="indent-2"><a href="#indent-2"></a>indent pre text</span>
<span id="indent-3"><a href="#indent-3"></a>    <span class="ot">=</span> unlines&#39; <span class="op">$</span> <span class="fu">map</span> indentLine <span class="op">$</span> lines&#39; text</span>
<span id="indent-4"><a href="#indent-4"></a>    <span class="kw">where</span> indentLine line</span>
<span id="indent-5"><a href="#indent-5"></a>            <span class="op">|</span> line <span class="op">==</span> <span class="st">&quot;&quot;</span> <span class="ot">=</span> line</span>
<span id="indent-6"><a href="#indent-6"></a>            <span class="op">|</span> <span class="fu">otherwise</span>  <span class="ot">=</span> pre <span class="op">&lt;&gt;</span> line</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«unindent»=</em></span></p>
<div class="sourceCode" id="unindent"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="unindent-1"><a href="#unindent-1"></a><span class="ot">unindent ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Text</span></span>
<span id="unindent-2"><a href="#unindent-2"></a>unindent prefix s</span>
<span id="unindent-3"><a href="#unindent-3"></a>    <span class="ot">=</span> unlines&#39; <span class="op">&lt;$&gt;</span> <span class="fu">sequence</span> (<span class="fu">map</span> unindentLine <span class="op">$</span> lines&#39; s)</span>
<span id="unindent-4"><a href="#unindent-4"></a>    <span class="kw">where</span> unindentLine t</span>
<span id="unindent-5"><a href="#unindent-5"></a>            <span class="op">|</span> T.all <span class="fu">isSpace</span> t <span class="ot">=</span> <span class="dt">Just</span> <span class="st">&quot;&quot;</span></span>
<span id="unindent-6"><a href="#unindent-6"></a>            <span class="op">|</span> <span class="fu">otherwise</span>       <span class="ot">=</span> T.stripPrefix prefix t</span></code></pre></div>
</div>
<h4 id="tests">Tests</h4>
<div class="annotated-code">
<p><span><em>«test/TextUtilSpec.hs»=</em></span></p>
<div class="sourceCode" id="cb3" data-file="test/TextUtilSpec.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">module</span> <span class="dt">TextUtilSpec</span> <span class="kw">where</span></span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">import</span> <span class="dt">Data.Maybe</span> (catMaybes, isJust)</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="kw">import</span> <span class="dt">Test.Hspec</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="kw">import</span> <span class="dt">Test.QuickCheck</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="kw">import</span> <span class="dt">Test.QuickCheck.Instances.Text</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="kw">import</span> <span class="dt">TextUtil</span></span>
<span id="cb3-10"><a href="#cb3-10"></a></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="ot">propUnlines ::</span> <span class="dt">Maybe</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>propUnlines t <span class="ot">=</span> </span>
<span id="cb3-13"><a href="#cb3-13"></a>    <span class="op">&lt;&lt;</span>test<span class="op">-</span><span class="fu">unlines</span><span class="op">-</span>inverse<span class="op">&gt;&gt;</span></span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="ot">propUnlineLists ::</span> ([<span class="dt">Text</span>], [<span class="dt">Text</span>]) <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>propUnlineLists (a, b) <span class="ot">=</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>    <span class="op">&lt;&lt;</span>test<span class="op">-</span><span class="fu">unlines</span><span class="op">-</span>associative<span class="op">&gt;&gt;</span></span>
<span id="cb3-18"><a href="#cb3-18"></a></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="ot">genLine ::</span> <span class="dt">Gen</span> <span class="dt">Text</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>genLine <span class="ot">=</span> T.pack <span class="op">&lt;$&gt;</span> (listOf <span class="op">$</span> elements [<span class="ch">&#39;!&#39;</span><span class="op">..</span><span class="ch">&#39;~&#39;</span>])</span>
<span id="cb3-21"><a href="#cb3-21"></a></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="ot">genText ::</span> <span class="dt">Gen</span> <span class="dt">Text</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>genText <span class="ot">=</span> unlines&#39; <span class="op">&lt;$&gt;</span> listOf genLine</span>
<span id="cb3-24"><a href="#cb3-24"></a></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="ot">genPair ::</span> <span class="dt">Gen</span> a <span class="ot">-&gt;</span> <span class="dt">Gen</span> b <span class="ot">-&gt;</span> <span class="dt">Gen</span> (a, b)</span>
<span id="cb3-26"><a href="#cb3-26"></a>genPair x y <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-27"><a href="#cb3-27"></a>    i <span class="ot">&lt;-</span> x</span>
<span id="cb3-28"><a href="#cb3-28"></a>    j <span class="ot">&lt;-</span> y</span>
<span id="cb3-29"><a href="#cb3-29"></a>    <span class="fu">return</span> (i, j)</span>
<span id="cb3-30"><a href="#cb3-30"></a></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="ot">propIndent ::</span> (<span class="dt">Text</span>, <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb3-32"><a href="#cb3-32"></a>propIndent (a, b) <span class="ot">=</span> unindent a (indent a b) <span class="op">==</span> <span class="dt">Just</span> b</span>
<span id="cb3-33"><a href="#cb3-33"></a></span>
<span id="cb3-34"><a href="#cb3-34"></a><span class="ot">propUnindentFail ::</span> (<span class="dt">Text</span>, <span class="dt">Text</span>) <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb3-35"><a href="#cb3-35"></a>propUnindentFail (a, b) <span class="ot">=</span> (isJust <span class="op">$</span> unindent a b) <span class="op">==</span> a <span class="ot">`T.isPrefixOf`</span> b</span>
<span id="cb3-36"><a href="#cb3-36"></a></span>
<span id="cb3-37"><a href="#cb3-37"></a><span class="ot">textUtilSpec ::</span> <span class="dt">Spec</span></span>
<span id="cb3-38"><a href="#cb3-38"></a>textUtilSpec <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>    describe <span class="st">&quot;property check&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb3-40"><a href="#cb3-40"></a>        it <span class="st">&quot;mUnlines inverses mLines&quot;</span> <span class="op">$</span></span>
<span id="cb3-41"><a href="#cb3-41"></a>            property <span class="op">$</span> propUnlines</span>
<span id="cb3-42"><a href="#cb3-42"></a>        it <span class="st">&quot;mUnlines can be nested (associativity)&quot;</span> <span class="op">$</span></span>
<span id="cb3-43"><a href="#cb3-43"></a>            property <span class="op">$</span> propUnlineLists</span>
<span id="cb3-44"><a href="#cb3-44"></a>        it <span class="st">&quot;unindent inverts indent&quot;</span> <span class="op">$</span></span>
<span id="cb3-45"><a href="#cb3-45"></a>            property <span class="op">$</span> forAll (genPair genLine genText)  propIndent</span>
<span id="cb3-46"><a href="#cb3-46"></a>        it <span class="st">&quot;unindent fails on wrong indent&quot;</span> <span class="op">$</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>            property <span class="op">$</span> forAll (genPair genLine genLine) propIndent</span></code></pre></div>
</div>
<h3 id="megaparsec">MegaParsec</h3>
<p>All parsing will be done through megaparsec.</p>
<div class="annotated-code">
<p><span><em>«import-megaparsec»=</em></span></p>
<div class="sourceCode" id="import-megaparsec"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="import-megaparsec-1"><a href="#import-megaparsec-1"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec</span></span>
<span id="import-megaparsec-2"><a href="#import-megaparsec-2"></a>    ( <span class="dt">MonadParsec</span>, <span class="dt">Parsec</span>, parse</span>
<span id="import-megaparsec-3"><a href="#import-megaparsec-3"></a>    , chunk, many, some, eof</span>
<span id="import-megaparsec-4"><a href="#import-megaparsec-4"></a>    , manyTill, anySingle, try, lookAhead, takeWhile1P, takeWhileP</span>
<span id="import-megaparsec-5"><a href="#import-megaparsec-5"></a>    , (<span class="op">&lt;|&gt;</span>), (<span class="op">&lt;?&gt;</span>) )</span>
<span id="import-megaparsec-6"><a href="#import-megaparsec-6"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec.Char</span></span>
<span id="import-megaparsec-7"><a href="#import-megaparsec-7"></a>    ( space )</span>
<span id="import-megaparsec-8"><a href="#import-megaparsec-8"></a><span class="kw">import</span> <span class="dt">Data.Void</span></span></code></pre></div>
</div>
<h2 id="errors">Errors</h2>
<div class="annotated-code">
<p><span><em>«src/Errors.hs»=</em></span></p>
<div class="sourceCode" id="cb4" data-file="src/Errors.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">module</span> <span class="dt">Errors</span> <span class="kw">where</span></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw">import</span> <span class="dt">Control.Exception</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">import</span> <span class="dt">Data.Typeable</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="kw">import</span> <span class="dt">TextUtil</span></span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="kw">data</span> <span class="dt">EntangledError</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="ot">=</span> <span class="dt">TangleError</span> <span class="dt">Text</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="op">|</span> <span class="dt">StitchError</span> <span class="dt">Text</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="op">|</span> <span class="dt">CyclicReference</span> <span class="dt">Text</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>    <span class="op">|</span> <span class="dt">UnknownLanguageClass</span> <span class="dt">Text</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>    <span class="op">|</span> <span class="dt">DatabaseError</span> <span class="dt">Text</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="op">|</span> <span class="dt">SystemError</span> <span class="dt">Text</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="op">|</span> <span class="dt">MissingLanguageClass</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>    <span class="op">|</span> <span class="dt">UnknownError</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>    <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Ord</span>, <span class="dt">Eq</span>, <span class="dt">Typeable</span>)</span>
<span id="cb4-19"><a href="#cb4-19"></a></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="ot">toEntangledError ::</span> (<span class="dt">Show</span> e)</span>
<span id="cb4-21"><a href="#cb4-21"></a>                 <span class="ot">=&gt;</span> (<span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">EntangledError</span>) <span class="ot">-&gt;</span> <span class="dt">Either</span> e a</span>
<span id="cb4-22"><a href="#cb4-22"></a>                 <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">EntangledError</span> a</span>
<span id="cb4-23"><a href="#cb4-23"></a>toEntangledError _ (<span class="dt">Right</span> x) <span class="ot">=</span> <span class="dt">Right</span> x</span>
<span id="cb4-24"><a href="#cb4-24"></a>toEntangledError f (<span class="dt">Left</span> x) <span class="ot">=</span> <span class="dt">Left</span> <span class="op">$</span> f <span class="op">$</span> tshow x</span>
<span id="cb4-25"><a href="#cb4-25"></a></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="kw">instance</span> <span class="dt">Exception</span> <span class="dt">EntangledError</span></span>
<span id="cb4-27"><a href="#cb4-27"></a></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="ot">formatError ::</span> <span class="dt">EntangledError</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>formatError (<span class="dt">TangleError</span> t) <span class="ot">=</span> <span class="st">&quot;tangling: &quot;</span> <span class="op">&lt;&gt;</span> t</span>
<span id="cb4-30"><a href="#cb4-30"></a>formatError (<span class="dt">StitchError</span> t) <span class="ot">=</span> <span class="st">&quot;stitching: &quot;</span> <span class="op">&lt;&gt;</span> t</span>
<span id="cb4-31"><a href="#cb4-31"></a>formatError x <span class="ot">=</span> tshow x</span></code></pre></div>
</div>
<h1 id="main-program">Main program</h1>
<p>The main program runs the daemon, but also provides a number of commands to inspect and manipulate the database.</p>
<div class="annotated-code">
<p><span><em>«main-imports»=</em></span></p>
<div class="sourceCode" id="main-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-imports-1"><a href="#main-imports-1"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="main-imports-2"><a href="#main-imports-2"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.IO</span> <span class="kw">as</span> <span class="dt">T.IO</span></span>
<span id="main-imports-3"><a href="#main-imports-3"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Lazy</span> <span class="kw">as</span> <span class="dt">LM</span></span>
<span id="main-imports-4"><a href="#main-imports-4"></a></span>
<span id="main-imports-5"><a href="#main-imports-5"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span></span>
<span id="main-imports-6"><a href="#main-imports-6"></a><span class="kw">import</span> <span class="dt">Control.Monad.Reader</span></span>
<span id="main-imports-7"><a href="#main-imports-7"></a><span class="kw">import</span> <span class="dt">Control.Monad.Writer</span></span>
<span id="main-imports-8"><a href="#main-imports-8"></a><span class="kw">import</span> <span class="dt">Control.Monad.Catch</span></span>
<span id="main-imports-9"><a href="#main-imports-9"></a><span class="kw">import</span> <span class="dt">System.Directory</span></span>
<span id="main-imports-10"><a href="#main-imports-10"></a><span class="kw">import</span> <span class="dt">System.FilePath</span></span></code></pre></div>
</div>
<h2 id="encoding">Encoding</h2>
<p>On linux consoles we use unicode bullet points (<code>•</code>). On Windows, those will just be asterisks (<code>*</code>). To facilitate this, we have to enable UTF-8 encoding.</p>
<div class="annotated-code">
<p><span><em>«main-imports»+</em></span></p>
<div class="sourceCode" id="main-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-imports-1"><a href="#main-imports-1"></a><span class="kw">import</span> <span class="dt">GHC.IO.Encoding</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«main-set-encoding»=</em></span></p>
<div class="sourceCode" id="main-set-encoding"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-set-encoding-1"><a href="#main-set-encoding-1"></a>setLocaleEncoding utf8</span></code></pre></div>
</div>
<h2 id="options">Options</h2>
<p>Options are parsed using <code>optparse-applicative</code>.</p>
<div class="annotated-code">
<p><span><em>«main-imports»+</em></span></p>
<div class="sourceCode" id="main-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-imports-1"><a href="#main-imports-1"></a><span class="kw">import</span> <span class="dt">Options.Applicative</span></span></code></pre></div>
</div>
<p>All true options are left to the sub-commands. We’re leaving <code>&lt;&lt;sub-commands&gt;&gt;</code> to be expanded.</p>
<div class="annotated-code">
<p><span><em>«main-options»=</em></span></p>
<div class="sourceCode" id="main-options"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-options-1"><a href="#main-options-1"></a><span class="kw">data</span> <span class="dt">Args</span> <span class="ot">=</span> <span class="dt">Args</span></span>
<span id="main-options-2"><a href="#main-options-2"></a>    {<span class="ot"> versionFlag ::</span> <span class="dt">Bool</span></span>
<span id="main-options-3"><a href="#main-options-3"></a>    ,<span class="ot"> subCommand ::</span> <span class="dt">SubCommand</span> }</span>
<span id="main-options-4"><a href="#main-options-4"></a></span>
<span id="main-options-5"><a href="#main-options-5"></a><span class="kw">data</span> <span class="dt">SubCommand</span></span>
<span id="main-options-6"><a href="#main-options-6"></a>    <span class="ot">=</span> <span class="dt">NoCommand</span></span>
<span id="main-options-7"><a href="#main-options-7"></a>    <span class="op">&lt;&lt;</span>sub<span class="op">-</span>commands<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>The same goes for the sub-command parsers, which are collected in <code>&lt;&lt;sub-parsers&gt;&gt;</code>.</p>
<div class="annotated-code">
<p><span><em>«main-options»+</em></span></p>
<div class="sourceCode" id="main-options"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-options-1"><a href="#main-options-1"></a><span class="ot">parseNoCommand ::</span> <span class="dt">Parser</span> <span class="dt">SubCommand</span></span>
<span id="main-options-2"><a href="#main-options-2"></a>parseNoCommand <span class="ot">=</span> <span class="fu">pure</span> <span class="dt">NoCommand</span></span>
<span id="main-options-3"><a href="#main-options-3"></a></span>
<span id="main-options-4"><a href="#main-options-4"></a><span class="ot">parseArgs ::</span> <span class="dt">Parser</span> <span class="dt">Args</span></span>
<span id="main-options-5"><a href="#main-options-5"></a>parseArgs <span class="ot">=</span> <span class="dt">Args</span></span>
<span id="main-options-6"><a href="#main-options-6"></a>    <span class="op">&lt;$&gt;</span> switch (long <span class="st">&quot;version&quot;</span> <span class="op">&lt;&gt;</span> short <span class="ch">&#39;v&#39;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;Show version information.&quot;</span>)</span>
<span id="main-options-7"><a href="#main-options-7"></a>    <span class="op">&lt;*&gt;</span> ( subparser ( <span class="fu">mempty</span></span>
<span id="main-options-8"><a href="#main-options-8"></a>          <span class="op">&lt;&lt;</span>sub<span class="op">-</span>parsers<span class="op">&gt;&gt;</span></span>
<span id="main-options-9"><a href="#main-options-9"></a>        ) <span class="op">&lt;|&gt;</span> parseNoCommand )</span></code></pre></div>
</div>
<p>And the runners.</p>
<div class="annotated-code">
<p><span><em>«main-imports»+</em></span></p>
<div class="sourceCode" id="main-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-imports-1"><a href="#main-imports-1"></a><span class="kw">import</span> <span class="dt">Config</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«main-run»=</em></span></p>
<div class="sourceCode" id="main-run"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-run-1"><a href="#main-run-1"></a><span class="ot">run ::</span> <span class="dt">Args</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="main-run-2"><a href="#main-run-2"></a>run <span class="dt">Args</span>{<span class="op">..</span>}</span>
<span id="main-run-3"><a href="#main-run-3"></a>    <span class="op">|</span> versionFlag       <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot;enTangleD 1.0.0&quot;</span></span>
<span id="main-run-4"><a href="#main-run-4"></a>    <span class="op">|</span> <span class="fu">otherwise</span>         <span class="ot">=</span> <span class="kw">do</span></span>
<span id="main-run-5"><a href="#main-run-5"></a>        config <span class="ot">&lt;-</span> configStack</span>
<span id="main-run-6"><a href="#main-run-6"></a>        <span class="kw">case</span> subCommand <span class="kw">of</span></span>
<span id="main-run-7"><a href="#main-run-7"></a>            <span class="dt">NoCommand</span> <span class="ot">-&gt;</span> <span class="fu">return</span> ()</span>
<span id="main-run-8"><a href="#main-run-8"></a>            <span class="op">&lt;&lt;</span>sub<span class="op">-</span>runners<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>This way we can add sub-commands independently in the following sections.</p>
<h3 id="starting-the-daemon">Starting the daemon</h3>
<div class="annotated-code">
<p><span><em>«main-imports»+</em></span></p>
<div class="sourceCode" id="main-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-imports-1"><a href="#main-imports-1"></a><span class="kw">import</span> <span class="dt">Daemon</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-commands»=</em></span></p>
<div class="sourceCode" id="sub-commands"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-commands-1"><a href="#sub-commands-1"></a><span class="op">|</span> <span class="dt">CommandDaemon</span> <span class="dt">DaemonArgs</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-parsers»=</em></span></p>
<div class="sourceCode" id="sub-parsers"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-parsers-1"><a href="#sub-parsers-1"></a><span class="op">&lt;&gt;</span>  command <span class="st">&quot;daemon&quot;</span> (info parseDaemonArgs ( progDesc <span class="st">&quot;Run the entangled daemon.&quot;</span> )) </span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«main-options»+</em></span></p>
<div class="sourceCode" id="main-options"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-options-1"><a href="#main-options-1"></a><span class="kw">data</span> <span class="dt">DaemonArgs</span> <span class="ot">=</span> <span class="dt">DaemonArgs</span></span>
<span id="main-options-2"><a href="#main-options-2"></a>    {<span class="ot"> inputFiles  ::</span> [<span class="dt">String</span>]</span>
<span id="main-options-3"><a href="#main-options-3"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="main-options-4"><a href="#main-options-4"></a></span>
<span id="main-options-5"><a href="#main-options-5"></a><span class="ot">parseDaemonArgs ::</span> <span class="dt">Parser</span> <span class="dt">SubCommand</span></span>
<span id="main-options-6"><a href="#main-options-6"></a>parseDaemonArgs <span class="ot">=</span> <span class="dt">CommandDaemon</span> <span class="op">&lt;$&gt;</span> <span class="dt">DaemonArgs</span></span>
<span id="main-options-7"><a href="#main-options-7"></a>    <span class="op">&lt;$&gt;</span> many (argument str (metavar <span class="st">&quot;FILES...&quot;</span>))</span>
<span id="main-options-8"><a href="#main-options-8"></a>    <span class="op">&lt;**&gt;</span> helper</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-runners»=</em></span></p>
<div class="sourceCode" id="sub-runners"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-runners-1"><a href="#sub-runners-1"></a><span class="dt">CommandDaemon</span> a <span class="ot">-&gt;</span> runSession config</span></code></pre></div>
</div>
<h3 id="printing-the-config">Printing the config</h3>
<div class="annotated-code">
<p><span><em>«main-imports»+</em></span></p>
<div class="sourceCode" id="main-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-imports-1"><a href="#main-imports-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Toml</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-commands»+</em></span></p>
<div class="sourceCode" id="sub-commands"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-commands-1"><a href="#sub-commands-1"></a><span class="op">|</span> <span class="dt">CommandConfig</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-parsers»+</em></span></p>
<div class="sourceCode" id="sub-parsers"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-parsers-1"><a href="#sub-parsers-1"></a><span class="op">&lt;&gt;</span> command <span class="st">&quot;config&quot;</span> (info (<span class="fu">pure</span> <span class="dt">CommandConfig</span> <span class="op">&lt;**&gt;</span> helper) </span>
<span id="sub-parsers-2"><a href="#sub-parsers-2"></a>                          (progDesc <span class="st">&quot;Print the default configuration.&quot;</span>))</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-runners»+</em></span></p>
<div class="sourceCode" id="sub-runners"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-runners-1"><a href="#sub-runners-1"></a><span class="dt">CommandConfig</span> <span class="ot">-&gt;</span> T.IO.putStrLn <span class="op">$</span> Toml.encode configCodec config</span></code></pre></div>
</div>
<h3 id="inserting-files-to-the-database">Inserting files to the database</h3>
<div class="annotated-code">
<p><span><em>«sub-commands»+</em></span></p>
<div class="sourceCode" id="sub-commands"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-commands-1"><a href="#sub-commands-1"></a><span class="op">|</span> <span class="dt">CommandInsert</span> <span class="dt">InsertArgs</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-parsers»+</em></span></p>
<div class="sourceCode" id="sub-parsers"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-parsers-1"><a href="#sub-parsers-1"></a><span class="op">&lt;&gt;</span> command <span class="st">&quot;insert&quot;</span> (info parseInsertArgs ( progDesc <span class="st">&quot;Insert markdown files into database.&quot;</span> ))</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«main-options»+</em></span></p>
<div class="sourceCode" id="main-options"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-options-1"><a href="#main-options-1"></a><span class="kw">data</span> <span class="dt">FileType</span> <span class="ot">=</span> <span class="dt">SourceFile</span> <span class="op">|</span> <span class="dt">TargetFile</span></span>
<span id="main-options-2"><a href="#main-options-2"></a></span>
<span id="main-options-3"><a href="#main-options-3"></a><span class="kw">data</span> <span class="dt">InsertArgs</span> <span class="ot">=</span> <span class="dt">InsertArgs</span></span>
<span id="main-options-4"><a href="#main-options-4"></a>    {<span class="ot"> insertType ::</span> <span class="dt">FileType</span></span>
<span id="main-options-5"><a href="#main-options-5"></a>    ,<span class="ot"> insertFiles ::</span> [<span class="dt">FilePath</span>] }</span>
<span id="main-options-6"><a href="#main-options-6"></a></span>
<span id="main-options-7"><a href="#main-options-7"></a><span class="ot">parseFileType ::</span> <span class="dt">Parser</span> <span class="dt">FileType</span></span>
<span id="main-options-8"><a href="#main-options-8"></a>parseFileType <span class="ot">=</span> (flag&#39; <span class="dt">SourceFile</span> <span class="op">$</span> long <span class="st">&quot;source&quot;</span> <span class="op">&lt;&gt;</span> short <span class="ch">&#39;s&#39;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;insert markdown source file&quot;</span>)</span>
<span id="main-options-9"><a href="#main-options-9"></a>            <span class="op">&lt;|&gt;</span> (flag&#39; <span class="dt">TargetFile</span> <span class="op">$</span> long <span class="st">&quot;target&quot;</span> <span class="op">&lt;&gt;</span> short <span class="ch">&#39;t&#39;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;insert target code file&quot;</span>)</span>
<span id="main-options-10"><a href="#main-options-10"></a></span>
<span id="main-options-11"><a href="#main-options-11"></a><span class="ot">parseInsertArgs ::</span> <span class="dt">Parser</span> <span class="dt">SubCommand</span></span>
<span id="main-options-12"><a href="#main-options-12"></a>parseInsertArgs <span class="ot">=</span> <span class="dt">CommandInsert</span> <span class="op">&lt;$&gt;</span> (<span class="dt">InsertArgs</span></span>
<span id="main-options-13"><a href="#main-options-13"></a>    <span class="op">&lt;$&gt;</span> parseFileType</span>
<span id="main-options-14"><a href="#main-options-14"></a>    <span class="op">&lt;*&gt;</span> many (argument str (metavar <span class="st">&quot;FILES...&quot;</span>))</span>
<span id="main-options-15"><a href="#main-options-15"></a>    <span class="op">&lt;**&gt;</span> helper)</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-runners»+</em></span></p>
<div class="sourceCode" id="sub-runners"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-runners-1"><a href="#sub-runners-1"></a><span class="dt">CommandInsert</span> (<span class="dt">InsertArgs</span> <span class="dt">SourceFile</span> fs) <span class="ot">-&gt;</span> printLogger <span class="op">$</span> runInsertSources config fs</span>
<span id="sub-runners-2"><a href="#sub-runners-2"></a><span class="dt">CommandInsert</span> (<span class="dt">InsertArgs</span> <span class="dt">TargetFile</span> fs) <span class="ot">-&gt;</span> printLogger <span class="op">$</span> runInsertTargets config fs</span></code></pre></div>
</div>
<h3 id="tangling-a-single-reference">Tangling a single reference</h3>
<div class="annotated-code">
<p><span><em>«sub-commands»+</em></span></p>
<div class="sourceCode" id="sub-commands"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-commands-1"><a href="#sub-commands-1"></a><span class="op">|</span> <span class="dt">CommandTangle</span> <span class="dt">TangleArgs</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-parsers»+</em></span></p>
<div class="sourceCode" id="sub-parsers"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-parsers-1"><a href="#sub-parsers-1"></a><span class="op">&lt;&gt;</span> command <span class="st">&quot;tangle&quot;</span> (info (<span class="dt">CommandTangle</span> <span class="op">&lt;$&gt;</span> parseTangleArgs) ( progDesc <span class="st">&quot;Retrieve tangled code.&quot;</span> ))</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«main-options»+</em></span></p>
<div class="sourceCode" id="main-options"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-options-1"><a href="#main-options-1"></a><span class="kw">data</span> <span class="dt">TangleQuery</span> <span class="ot">=</span> <span class="dt">TangleFile</span> <span class="dt">FilePath</span> <span class="op">|</span> <span class="dt">TangleRef</span> <span class="dt">Text</span> <span class="op">|</span> <span class="dt">TangleAll</span> <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="main-options-2"><a href="#main-options-2"></a></span>
<span id="main-options-3"><a href="#main-options-3"></a><span class="kw">data</span> <span class="dt">TangleArgs</span> <span class="ot">=</span> <span class="dt">TangleArgs</span></span>
<span id="main-options-4"><a href="#main-options-4"></a>    {<span class="ot"> tangleQuery ::</span> <span class="dt">TangleQuery</span></span>
<span id="main-options-5"><a href="#main-options-5"></a>    ,<span class="ot"> tangleDecorate ::</span> <span class="dt">Bool</span></span>
<span id="main-options-6"><a href="#main-options-6"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="main-options-7"><a href="#main-options-7"></a></span>
<span id="main-options-8"><a href="#main-options-8"></a><span class="ot">parseTangleArgs ::</span> <span class="dt">Parser</span> <span class="dt">TangleArgs</span></span>
<span id="main-options-9"><a href="#main-options-9"></a>parseTangleArgs <span class="ot">=</span> <span class="dt">TangleArgs</span></span>
<span id="main-options-10"><a href="#main-options-10"></a>    <span class="op">&lt;$&gt;</span> (   (<span class="dt">TangleFile</span> <span class="op">&lt;$&gt;</span> strOption ( long <span class="st">&quot;file&quot;</span> <span class="op">&lt;&gt;</span> short <span class="ch">&#39;f&#39;</span></span>
<span id="main-options-11"><a href="#main-options-11"></a>                                      <span class="op">&lt;&gt;</span> metavar <span class="st">&quot;TARGET&quot;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;file target&quot;</span> ))</span>
<span id="main-options-12"><a href="#main-options-12"></a>        <span class="op">&lt;|&gt;</span> (<span class="dt">TangleRef</span>  <span class="op">&lt;$&gt;</span> strOption ( long <span class="st">&quot;ref&quot;</span>  <span class="op">&lt;&gt;</span> short <span class="ch">&#39;r&#39;</span></span>
<span id="main-options-13"><a href="#main-options-13"></a>                                      <span class="op">&lt;&gt;</span> metavar <span class="st">&quot;TARGET&quot;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;reference target&quot;</span> ))</span>
<span id="main-options-14"><a href="#main-options-14"></a>        <span class="op">&lt;|&gt;</span> (flag&#39; <span class="dt">TangleAll</span> <span class="op">$</span> long <span class="st">&quot;all&quot;</span> <span class="op">&lt;&gt;</span> short <span class="ch">&#39;a&#39;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;tangle all and write to disk&quot;</span> ))</span>
<span id="main-options-15"><a href="#main-options-15"></a>    <span class="op">&lt;*&gt;</span> switch (long <span class="st">&quot;decorate&quot;</span> <span class="op">&lt;&gt;</span> short <span class="ch">&#39;d&#39;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;Decorate with stitching comments.&quot;</span>)</span>
<span id="main-options-16"><a href="#main-options-16"></a>    <span class="op">&lt;**&gt;</span> helper</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-runners»+</em></span></p>
<div class="sourceCode" id="sub-runners"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-runners-1"><a href="#sub-runners-1"></a><span class="dt">CommandTangle</span> a <span class="ot">-&gt;</span> printLogger <span class="op">$</span> runTangle config a</span></code></pre></div>
</div>
<h3 id="stitching-a-markdown-source">Stitching a markdown source</h3>
<div class="annotated-code">
<p><span><em>«sub-commands»+</em></span></p>
<div class="sourceCode" id="sub-commands"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-commands-1"><a href="#sub-commands-1"></a><span class="op">|</span> <span class="dt">CommandStitch</span> <span class="dt">StitchArgs</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-parsers»+</em></span></p>
<div class="sourceCode" id="sub-parsers"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-parsers-1"><a href="#sub-parsers-1"></a><span class="op">&lt;&gt;</span> command <span class="st">&quot;stitch&quot;</span> (info (<span class="dt">CommandStitch</span> <span class="op">&lt;$&gt;</span> parseStitchArgs) ( progDesc <span class="st">&quot;Retrieve stitched markdown.&quot;</span> ))</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«main-options»+</em></span></p>
<div class="sourceCode" id="main-options"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-options-1"><a href="#main-options-1"></a><span class="kw">data</span> <span class="dt">StitchArgs</span> <span class="ot">=</span> <span class="dt">StitchArgs</span></span>
<span id="main-options-2"><a href="#main-options-2"></a>    {<span class="ot"> stitchTarget ::</span> <span class="dt">FilePath</span></span>
<span id="main-options-3"><a href="#main-options-3"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="main-options-4"><a href="#main-options-4"></a></span>
<span id="main-options-5"><a href="#main-options-5"></a><span class="ot">parseStitchArgs ::</span> <span class="dt">Parser</span> <span class="dt">StitchArgs</span></span>
<span id="main-options-6"><a href="#main-options-6"></a>parseStitchArgs <span class="ot">=</span> <span class="dt">StitchArgs</span></span>
<span id="main-options-7"><a href="#main-options-7"></a>    <span class="op">&lt;$&gt;</span> argument str ( metavar <span class="st">&quot;TARGET&quot;</span> )</span>
<span id="main-options-8"><a href="#main-options-8"></a>    <span class="op">&lt;**&gt;</span> helper</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-runners»+</em></span></p>
<div class="sourceCode" id="sub-runners"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-runners-1"><a href="#sub-runners-1"></a><span class="dt">CommandStitch</span> a <span class="ot">-&gt;</span> printLogger <span class="op">$</span> runStitch config a</span></code></pre></div>
</div>
<h3 id="listing-all-target-files">Listing all target files</h3>
<div class="annotated-code">
<p><span><em>«sub-commands»+</em></span></p>
<div class="sourceCode" id="sub-commands"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-commands-1"><a href="#sub-commands-1"></a><span class="op">|</span> <span class="dt">CommandList</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-parsers»+</em></span></p>
<div class="sourceCode" id="sub-parsers"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-parsers-1"><a href="#sub-parsers-1"></a><span class="op">&lt;&gt;</span> command <span class="st">&quot;list&quot;</span> (info (<span class="fu">pure</span> <span class="dt">CommandList</span> <span class="op">&lt;**&gt;</span> helper) ( progDesc <span class="st">&quot;List generated code files.&quot;</span> ))</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«sub-runners»+</em></span></p>
<div class="sourceCode" id="sub-runners"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="sub-runners-1"><a href="#sub-runners-1"></a><span class="dt">CommandList</span> <span class="ot">-&gt;</span> printLogger <span class="op">$</span> runList config</span></code></pre></div>
</div>
<h2 id="main">Main</h2>
<div class="annotated-code">
<p><span><em>«app/Main.hs»=</em></span></p>
<div class="sourceCode" id="cb5" data-file="app/Main.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="op">&lt;&lt;</span>main<span class="op">-</span>imports<span class="op">&gt;&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="kw">import</span> <span class="dt">System.Exit</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="kw">import</span> <span class="dt">Document</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="kw">import</span> <span class="dt">Tangle</span> (parseMarkdown, expandedCode, annotateNaked)</span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="kw">import</span> <span class="dt">TextUtil</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="kw">import</span> <span class="dt">Comment</span></span>
<span id="cb5-10"><a href="#cb5-10"></a></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="op">&lt;&lt;</span>main<span class="op">-</span>options<span class="op">&gt;&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12"></a></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb5-14"><a href="#cb5-14"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>    <span class="op">&lt;&lt;</span>main<span class="op">-</span>set<span class="op">-</span>encoding<span class="op">&gt;&gt;</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>    run <span class="op">=&lt;&lt;</span> execParser args</span>
<span id="cb5-17"><a href="#cb5-17"></a>    <span class="kw">where</span> args <span class="ot">=</span> info (parseArgs <span class="op">&lt;**&gt;</span> helper)</span>
<span id="cb5-18"><a href="#cb5-18"></a>            (  fullDesc</span>
<span id="cb5-19"><a href="#cb5-19"></a>            <span class="op">&lt;&gt;</span> progDesc <span class="st">&quot;Automatically tangles and untangles &#39;FILES...&#39;.&quot;</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>            <span class="op">&lt;&gt;</span> header   <span class="st">&quot;enTangleD -- daemonised literate programming&quot;</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>            )</span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="op">&lt;&lt;</span>main<span class="op">-</span>run<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<h2 id="generics">Generics</h2>
<h3 id="create-the-empty-database">Create the empty database</h3>
<div class="annotated-code">
<p><span><em>«main-imports»+</em></span></p>
<div class="sourceCode" id="main-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-imports-1"><a href="#main-imports-1"></a><span class="kw">import</span> <span class="dt">Database</span></span>
<span id="main-imports-2"><a href="#main-imports-2"></a><span class="kw">import</span> <span class="dt">Database.SQLite.Simple</span></span></code></pre></div>
</div>
<h3 id="simple-io-logger">Simple IO logger</h3>
<div class="annotated-code">
<p><span><em>«main-imports»+</em></span></p>
<div class="sourceCode" id="main-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-imports-1"><a href="#main-imports-1"></a><span class="kw">import</span> <span class="dt">Logging</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«main-run»+</em></span></p>
<div class="sourceCode" id="main-run"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-run-1"><a href="#main-run-1"></a><span class="kw">newtype</span> <span class="dt">LoggerIO</span> a <span class="ot">=</span> <span class="dt">LoggerIO</span> {<span class="ot"> printLogger ::</span> (<span class="dt">IO</span> a) }</span>
<span id="main-run-2"><a href="#main-run-2"></a>    <span class="kw">deriving</span> ( <span class="dt">Applicative</span>, <span class="dt">Functor</span>, <span class="dt">Monad</span>, <span class="dt">MonadIO</span>, <span class="dt">MonadThrow</span> )</span>
<span id="main-run-3"><a href="#main-run-3"></a></span>
<span id="main-run-4"><a href="#main-run-4"></a><span class="kw">instance</span> <span class="dt">MonadLogger</span> <span class="dt">LoggerIO</span> <span class="kw">where</span></span>
<span id="main-run-5"><a href="#main-run-5"></a>    logEntry level x <span class="ot">=</span> liftIO <span class="op">$</span> T.IO.putStrLn <span class="op">$</span> tshow level <span class="op">&lt;&gt;</span> <span class="st">&quot;: &quot;</span> <span class="op">&lt;&gt;</span> x</span></code></pre></div>
</div>
<h2 id="tangle">Tangle</h2>
<div class="annotated-code">
<p><span><em>«main-run»+</em></span></p>
<div class="sourceCode" id="main-run"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-run-1"><a href="#main-run-1"></a><span class="ot">writeFile&#39; ::</span> (<span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> m ()</span>
<span id="main-run-2"><a href="#main-run-2"></a>writeFile&#39; filename text <span class="ot">=</span> liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="main-run-3"><a href="#main-run-3"></a>    createDirectoryIfMissing <span class="dt">True</span> (takeDirectory filename)</span>
<span id="main-run-4"><a href="#main-run-4"></a>    T.IO.writeFile filename text</span>
<span id="main-run-5"><a href="#main-run-5"></a></span>
<span id="main-run-6"><a href="#main-run-6"></a><span class="ot">runTangle ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">TangleArgs</span> <span class="ot">-&gt;</span> <span class="dt">LoggerIO</span> ()</span>
<span id="main-run-7"><a href="#main-run-7"></a>runTangle cfg <span class="dt">TangleArgs</span>{<span class="op">..</span>} <span class="ot">=</span> <span class="kw">do</span></span>
<span id="main-run-8"><a href="#main-run-8"></a>    dbPath <span class="ot">&lt;-</span> getDatabasePath cfg</span>
<span id="main-run-9"><a href="#main-run-9"></a>    withSQL dbPath <span class="op">$</span> <span class="kw">do</span> </span>
<span id="main-run-10"><a href="#main-run-10"></a>        createTables</span>
<span id="main-run-11"><a href="#main-run-11"></a>        refs <span class="ot">&lt;-</span> queryReferenceMap cfg</span>
<span id="main-run-12"><a href="#main-run-12"></a>        <span class="kw">let</span> annotate <span class="ot">=</span> <span class="kw">if</span> tangleDecorate <span class="kw">then</span> annotateComment <span class="kw">else</span> annotateNaked</span>
<span id="main-run-13"><a href="#main-run-13"></a>            codes <span class="ot">=</span> expandedCode annotate refs</span>
<span id="main-run-14"><a href="#main-run-14"></a>            tangleRef tgt <span class="ot">=</span> <span class="kw">case</span> codes <span class="op">LM.!?</span> tgt <span class="kw">of</span></span>
<span id="main-run-15"><a href="#main-run-15"></a>                <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throwM <span class="op">$</span> <span class="dt">TangleError</span> <span class="op">$</span> <span class="st">&quot;Reference `&quot;</span> <span class="op">&lt;&gt;</span> tshow tgt <span class="op">&lt;&gt;</span> <span class="st">&quot;` not found.&quot;</span></span>
<span id="main-run-16"><a href="#main-run-16"></a>                <span class="dt">Just</span> (<span class="dt">Left</span> e) <span class="ot">-&gt;</span> throwM <span class="op">$</span> <span class="dt">TangleError</span> <span class="op">$</span> tshow e</span>
<span id="main-run-17"><a href="#main-run-17"></a>                <span class="dt">Just</span> (<span class="dt">Right</span> t) <span class="ot">-&gt;</span> <span class="fu">return</span> t</span>
<span id="main-run-18"><a href="#main-run-18"></a>            tangleFile f <span class="ot">=</span> queryTargetRef f <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="main-run-19"><a href="#main-run-19"></a>                <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throwM <span class="op">$</span> <span class="dt">TangleError</span> <span class="op">$</span> <span class="st">&quot;Target `&quot;</span> <span class="op">&lt;&gt;</span> T.pack f <span class="op">&lt;&gt;</span> <span class="st">&quot;` not found.&quot;</span></span>
<span id="main-run-20"><a href="#main-run-20"></a>                <span class="dt">Just</span> ref <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="main-run-21"><a href="#main-run-21"></a>                    lang <span class="ot">&lt;-</span> codeLanguage&#39; refs ref</span>
<span id="main-run-22"><a href="#main-run-22"></a>                    content <span class="ot">&lt;-</span> tangleRef ref</span>
<span id="main-run-23"><a href="#main-run-23"></a>                    <span class="fu">return</span> <span class="op">$</span> unlines&#39; [headerComment lang f, content]</span>
<span id="main-run-24"><a href="#main-run-24"></a></span>
<span id="main-run-25"><a href="#main-run-25"></a>        <span class="kw">case</span> tangleQuery <span class="kw">of</span></span>
<span id="main-run-26"><a href="#main-run-26"></a>            <span class="dt">TangleRef</span> tgt <span class="ot">-&gt;</span> tangleRef (<span class="dt">ReferenceName</span> tgt) <span class="op">&gt;&gt;=</span> (\x <span class="ot">-&gt;</span> liftIO <span class="op">$</span> T.IO.putStrLn x)</span>
<span id="main-run-27"><a href="#main-run-27"></a>            <span class="dt">TangleFile</span> f  <span class="ot">-&gt;</span> tangleFile f <span class="op">&gt;&gt;=</span> (\x <span class="ot">-&gt;</span> liftIO <span class="op">$</span> T.IO.putStrLn x)</span>
<span id="main-run-28"><a href="#main-run-28"></a>            <span class="dt">TangleAll</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="main-run-29"><a href="#main-run-29"></a>                fs <span class="ot">&lt;-</span> listTargetFiles</span>
<span id="main-run-30"><a href="#main-run-30"></a>                <span class="fu">mapM_</span> (\f <span class="ot">-&gt;</span> tangleFile f <span class="op">&gt;&gt;=</span> writeFile&#39; f) fs </span></code></pre></div>
</div>
<h2 id="stitch">Stitch</h2>
<div class="annotated-code">
<p><span><em>«main-run»+</em></span></p>
<div class="sourceCode" id="main-run"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-run-1"><a href="#main-run-1"></a><span class="ot">runStitch ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">StitchArgs</span> <span class="ot">-&gt;</span> <span class="dt">LoggerIO</span> ()</span>
<span id="main-run-2"><a href="#main-run-2"></a>runStitch config <span class="dt">StitchArgs</span>{<span class="op">..</span>} <span class="ot">=</span> <span class="kw">do</span> </span>
<span id="main-run-3"><a href="#main-run-3"></a>    dbPath <span class="ot">&lt;-</span> getDatabasePath config</span>
<span id="main-run-4"><a href="#main-run-4"></a>    text <span class="ot">&lt;-</span> withSQL dbPath <span class="op">$</span> <span class="kw">do</span> </span>
<span id="main-run-5"><a href="#main-run-5"></a>        createTables</span>
<span id="main-run-6"><a href="#main-run-6"></a>        stitchDocument stitchTarget</span>
<span id="main-run-7"><a href="#main-run-7"></a>    liftIO <span class="op">$</span> T.IO.putStrLn text</span></code></pre></div>
</div>
<h2 id="list">List</h2>
<div class="annotated-code">
<p><span><em>«main-run»+</em></span></p>
<div class="sourceCode" id="main-run"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-run-1"><a href="#main-run-1"></a><span class="ot">runList ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">LoggerIO</span> ()</span>
<span id="main-run-2"><a href="#main-run-2"></a>runList cfg <span class="ot">=</span> <span class="kw">do</span></span>
<span id="main-run-3"><a href="#main-run-3"></a>    dbPath <span class="ot">&lt;-</span> getDatabasePath cfg</span>
<span id="main-run-4"><a href="#main-run-4"></a>    lst <span class="ot">&lt;-</span> withSQL dbPath <span class="op">$</span> <span class="kw">do</span> </span>
<span id="main-run-5"><a href="#main-run-5"></a>        createTables</span>
<span id="main-run-6"><a href="#main-run-6"></a>        listTargetFiles</span>
<span id="main-run-7"><a href="#main-run-7"></a>    liftIO <span class="op">$</span> T.IO.putStrLn <span class="op">$</span> T.unlines <span class="op">$</span> <span class="fu">map</span> T.pack lst</span></code></pre></div>
</div>
<h2 id="insert">Insert</h2>
<div class="annotated-code">
<p><span><em>«main-imports»+</em></span></p>
<div class="sourceCode" id="main-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-imports-1"><a href="#main-imports-1"></a><span class="kw">import</span> <span class="dt">Stitch</span> (stitch)</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«main-run»+</em></span></p>
<div class="sourceCode" id="main-run"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-run-1"><a href="#main-run-1"></a><span class="ot">runInsertSources ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">LoggerIO</span> ()</span>
<span id="main-run-2"><a href="#main-run-2"></a>runInsertSources cfg files <span class="ot">=</span> <span class="kw">do</span></span>
<span id="main-run-3"><a href="#main-run-3"></a>    dbPath <span class="ot">&lt;-</span> getDatabasePath cfg</span>
<span id="main-run-4"><a href="#main-run-4"></a>    logMessage <span class="op">$</span> <span class="st">&quot;inserting files: &quot;</span> <span class="op">&lt;&gt;</span> tshow files</span>
<span id="main-run-5"><a href="#main-run-5"></a>    withSQL dbPath <span class="op">$</span> createTables <span class="op">&gt;&gt;</span> <span class="fu">mapM_</span> readDoc files</span>
<span id="main-run-6"><a href="#main-run-6"></a>    <span class="kw">where</span> readDoc f <span class="ot">=</span> <span class="kw">do</span></span>
<span id="main-run-7"><a href="#main-run-7"></a>            doc <span class="ot">&lt;-</span> runReaderT (liftIO (T.IO.readFile f) <span class="op">&gt;&gt;=</span> parseMarkdown f) cfg</span>
<span id="main-run-8"><a href="#main-run-8"></a>            <span class="kw">case</span> doc <span class="kw">of</span></span>
<span id="main-run-9"><a href="#main-run-9"></a>                <span class="dt">Left</span> e <span class="ot">-&gt;</span> liftIO <span class="op">$</span> T.IO.putStrLn (<span class="st">&quot;warning: &quot;</span> <span class="op">&lt;&gt;</span> tshow e)</span>
<span id="main-run-10"><a href="#main-run-10"></a>                <span class="dt">Right</span> d <span class="ot">-&gt;</span> insertDocument f d</span>
<span id="main-run-11"><a href="#main-run-11"></a></span>
<span id="main-run-12"><a href="#main-run-12"></a><span class="ot">runInsertTargets ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">LoggerIO</span> ()</span>
<span id="main-run-13"><a href="#main-run-13"></a>runInsertTargets cfg files <span class="ot">=</span> <span class="kw">do</span></span>
<span id="main-run-14"><a href="#main-run-14"></a>    dbPath <span class="ot">&lt;-</span> getDatabasePath cfg</span>
<span id="main-run-15"><a href="#main-run-15"></a>    logMessage <span class="op">$</span> <span class="st">&quot;inserting files: &quot;</span> <span class="op">&lt;&gt;</span> tshow files</span>
<span id="main-run-16"><a href="#main-run-16"></a>    withSQL dbPath <span class="op">$</span> createTables <span class="op">&gt;&gt;</span> <span class="fu">mapM_</span> readTgt files</span>
<span id="main-run-17"><a href="#main-run-17"></a>    <span class="kw">where</span> readTgt f <span class="ot">=</span> <span class="kw">do</span></span>
<span id="main-run-18"><a href="#main-run-18"></a>            refs&#39; <span class="ot">&lt;-</span> runReaderT (liftIO (T.IO.readFile f) <span class="op">&gt;&gt;=</span> stitch f) cfg</span>
<span id="main-run-19"><a href="#main-run-19"></a>            <span class="kw">case</span> refs&#39; <span class="kw">of</span></span>
<span id="main-run-20"><a href="#main-run-20"></a>                <span class="dt">Left</span> err <span class="ot">-&gt;</span> logError <span class="op">$</span> <span class="st">&quot;Error loading &#39;&quot;</span> <span class="op">&lt;&gt;</span> T.pack f <span class="op">&lt;&gt;</span> <span class="st">&quot;&#39;: &quot;</span> <span class="op">&lt;&gt;</span> formatError err</span>
<span id="main-run-21"><a href="#main-run-21"></a>                <span class="dt">Right</span> refs <span class="ot">-&gt;</span> updateTarget refs</span></code></pre></div>
</div>
<h1 id="document-structure">Document structure</h1>
<div class="annotated-code">
<p><span><em>«src/Document.hs»=</em></span></p>
<div class="sourceCode" id="cb6" data-file="src/Document.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">module</span> <span class="dt">Document</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>    ( <span class="kw">module</span> <span class="dt">Document</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>    , <span class="kw">module</span> <span class="dt">Errors</span> ) <span class="kw">where</span></span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-map&gt;&gt;</span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-set&gt;&gt;</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="kw">import</span> <span class="dt">Data.Typeable</span> (<span class="dt">Typeable</span>)</span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="kw">import</span> <span class="dt">Data.List</span> (sort)</span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="kw">import</span> <span class="dt">Control.Monad.Catch</span></span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="kw">import</span> <span class="dt">Config</span> (<span class="dt">Language</span>)</span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="kw">import</span> <span class="dt">TextUtil</span> (tshow)</span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="kw">import</span> <span class="dt">Errors</span></span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="op">&lt;&lt;</span>document<span class="op">-</span>structure<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<h2 id="structure">Structure</h2>
<p>A document is modelled as a series of text and code blocks. A code block is delimited by two lines starting with three backtics:</p>
<pre><code> Normal text.

 ```
 print(&quot;this is a code block&quot;)
 ```</code></pre>
<p>Each code block that is of relevance to Entangled has a reference attached.</p>
<pre><code> ``` {.language #&lt;reference&gt;}
 ```</code></pre>
<p>and possibly, a filename.</p>
<pre><code> ``` {.language #&lt;reference&gt; file=&lt;path&gt;}
 ```</code></pre>
<p>An identifier may be repeated, in which case the code block is concatenated to the previous instances. Each instance will have an associated integer marking the place in the sequence.</p>
<h3 id="reference-id">Reference Id</h3>
<p>We define the type <code>ReferenceId</code>.</p>
<div class="annotated-code">
<p><span><em>«document-structure»=</em></span></p>
<div class="sourceCode" id="document-structure"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="document-structure-1"><a href="#document-structure-1"></a><span class="kw">newtype</span> <span class="dt">ReferenceName</span> <span class="ot">=</span> <span class="dt">ReferenceName</span></span>
<span id="document-structure-2"><a href="#document-structure-2"></a>    {<span class="ot"> unReferenceName ::</span> <span class="dt">Text</span></span>
<span id="document-structure-3"><a href="#document-structure-3"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>)</span>
<span id="document-structure-4"><a href="#document-structure-4"></a></span>
<span id="document-structure-5"><a href="#document-structure-5"></a><span class="kw">data</span> <span class="dt">ReferenceId</span> <span class="ot">=</span> <span class="dt">ReferenceId</span></span>
<span id="document-structure-6"><a href="#document-structure-6"></a>    {<span class="ot"> referenceName ::</span> <span class="dt">ReferenceName</span></span>
<span id="document-structure-7"><a href="#document-structure-7"></a>    ,<span class="ot"> referenceCount ::</span> <span class="dt">Int</span></span>
<span id="document-structure-8"><a href="#document-structure-8"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>)</span>
<span id="document-structure-9"><a href="#document-structure-9"></a></span>
<span id="document-structure-10"><a href="#document-structure-10"></a><span class="ot">showNowebReference ::</span> <span class="dt">ReferenceName</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="document-structure-11"><a href="#document-structure-11"></a>showNowebReference (<span class="dt">ReferenceName</span> x) <span class="ot">=</span> <span class="st">&quot;&lt;&lt;&quot;</span> <span class="op">&lt;&gt;</span> x <span class="op">&lt;&gt;</span> <span class="st">&quot;&gt;&gt;&quot;</span></span></code></pre></div>
</div>
<p>The type is deriving <code>Ord</code>, so that we can use it as an index for a <code>Map</code>.</p>
<h3 id="document">Document</h3>
<p>Using the <code>ReferenceId</code> type we can represent a text (or <code>Document</code>) as a sequence of plain <code>Text</code> or <code>ReferenceId</code>, paired up with a map linking each <code>ReferenceId</code> with a code block.</p>
<div class="annotated-code">
<p><span><em>«document-structure»+</em></span></p>
<div class="sourceCode" id="document-structure"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="document-structure-1"><a href="#document-structure-1"></a><span class="kw">data</span> <span class="dt">Content</span></span>
<span id="document-structure-2"><a href="#document-structure-2"></a>    <span class="ot">=</span> <span class="dt">PlainText</span> <span class="dt">Text</span></span>
<span id="document-structure-3"><a href="#document-structure-3"></a>    <span class="op">|</span> <span class="dt">Reference</span> <span class="dt">ReferenceId</span></span>
<span id="document-structure-4"><a href="#document-structure-4"></a>    <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="document-structure-5"><a href="#document-structure-5"></a></span>
<span id="document-structure-6"><a href="#document-structure-6"></a><span class="kw">type</span> <span class="dt">ReferencePair</span> <span class="ot">=</span> (<span class="dt">ReferenceId</span>, <span class="dt">CodeBlock</span>)</span>
<span id="document-structure-7"><a href="#document-structure-7"></a><span class="kw">type</span> <span class="dt">ReferenceMap</span> <span class="ot">=</span> <span class="dt">Map</span> <span class="dt">ReferenceId</span> <span class="dt">CodeBlock</span></span>
<span id="document-structure-8"><a href="#document-structure-8"></a><span class="kw">type</span> <span class="dt">FileMap</span> <span class="ot">=</span> <span class="dt">Map</span> <span class="dt">FilePath</span> <span class="dt">ReferenceName</span></span>
<span id="document-structure-9"><a href="#document-structure-9"></a></span>
<span id="document-structure-10"><a href="#document-structure-10"></a><span class="kw">data</span> <span class="dt">Document</span> <span class="ot">=</span> <span class="dt">Document</span></span>
<span id="document-structure-11"><a href="#document-structure-11"></a>    {<span class="ot"> references      ::</span> <span class="dt">ReferenceMap</span></span>
<span id="document-structure-12"><a href="#document-structure-12"></a>    ,<span class="ot"> documentContent ::</span> [<span class="dt">Content</span>]</span>
<span id="document-structure-13"><a href="#document-structure-13"></a>    ,<span class="ot"> documentTargets ::</span> <span class="dt">FileMap</span></span>
<span id="document-structure-14"><a href="#document-structure-14"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>)</span></code></pre></div>
</div>
<h3 id="accessors">Accessors</h3>
<div class="annotated-code">
<p><span><em>«document-structure»+</em></span></p>
<div class="sourceCode" id="document-structure"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="document-structure-1"><a href="#document-structure-1"></a><span class="ot">referenceNames ::</span> <span class="dt">ReferenceMap</span> <span class="ot">-&gt;</span> <span class="dt">Set</span> <span class="dt">ReferenceName</span></span>
<span id="document-structure-2"><a href="#document-structure-2"></a>referenceNames <span class="ot">=</span> S.fromList <span class="op">.</span> <span class="fu">map</span> referenceName <span class="op">.</span> M.keys</span>
<span id="document-structure-3"><a href="#document-structure-3"></a></span>
<span id="document-structure-4"><a href="#document-structure-4"></a><span class="ot">referencesByName ::</span> <span class="dt">ReferenceMap</span> <span class="ot">-&gt;</span> <span class="dt">ReferenceName</span> <span class="ot">-&gt;</span> [<span class="dt">ReferenceId</span>]</span>
<span id="document-structure-5"><a href="#document-structure-5"></a>referencesByName refs name</span>
<span id="document-structure-6"><a href="#document-structure-6"></a>    <span class="ot">=</span> (<span class="fu">sort</span> <span class="op">.</span> <span class="fu">filter</span> ((<span class="op">==</span> name) <span class="op">.</span> referenceName) <span class="op">.</span> M.keys) refs</span>
<span id="document-structure-7"><a href="#document-structure-7"></a></span>
<span id="document-structure-8"><a href="#document-structure-8"></a><span class="ot">codeBlocksByName ::</span> <span class="dt">ReferenceMap</span> <span class="ot">-&gt;</span> <span class="dt">ReferenceName</span> <span class="ot">-&gt;</span> [<span class="dt">CodeBlock</span>]</span>
<span id="document-structure-9"><a href="#document-structure-9"></a>codeBlocksByName refs name <span class="ot">=</span> <span class="fu">map</span> (refs <span class="op">M.!</span>) <span class="op">$</span> referencesByName refs name</span></code></pre></div>
</div>
<h3 id="code-blocks">Code blocks</h3>
<p>A code block can have all attributes that are normally associated in the context of CSS. The following markdown,</p>
<pre><code> ``` {.class #id attribute=value}
 source
 ```</code></pre>
<p>can be mapped to a list of <code>CodeProperty</code>.</p>
<div class="annotated-code">
<p><span><em>«document-structure»+</em></span></p>
<div class="sourceCode" id="document-structure"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="document-structure-1"><a href="#document-structure-1"></a><span class="kw">data</span> <span class="dt">CodeProperty</span></span>
<span id="document-structure-2"><a href="#document-structure-2"></a>    <span class="ot">=</span> <span class="dt">CodeId</span> <span class="dt">Text</span></span>
<span id="document-structure-3"><a href="#document-structure-3"></a>    <span class="op">|</span> <span class="dt">CodeAttribute</span> <span class="dt">Text</span> <span class="dt">Text</span></span>
<span id="document-structure-4"><a href="#document-structure-4"></a>    <span class="op">|</span> <span class="dt">CodeClass</span> <span class="dt">Text</span></span>
<span id="document-structure-5"><a href="#document-structure-5"></a>    <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)</span>
<span id="document-structure-6"><a href="#document-structure-6"></a></span>
<span id="document-structure-7"><a href="#document-structure-7"></a><span class="ot">getAttribute ::</span> [<span class="dt">CodeProperty</span>] <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Text</span></span>
<span id="document-structure-8"><a href="#document-structure-8"></a>getAttribute [] _ <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="document-structure-9"><a href="#document-structure-9"></a>getAttribute (<span class="dt">CodeAttribute</span> k v<span class="op">:</span>ps) l</span>
<span id="document-structure-10"><a href="#document-structure-10"></a>    <span class="op">|</span> k <span class="op">==</span> l    <span class="ot">=</span> <span class="dt">Just</span> v</span>
<span id="document-structure-11"><a href="#document-structure-11"></a>    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> getAttribute ps l</span>
<span id="document-structure-12"><a href="#document-structure-12"></a>getAttribute (_<span class="op">:</span>ps) l <span class="ot">=</span> getAttribute ps l</span></code></pre></div>
</div>
<p>In our case the <em>class</em> represents the code language or an abbreviation thereof.</p>
<div class="annotated-code">
<p><span><em>«document-structure»+</em></span></p>
<div class="sourceCode" id="document-structure"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="document-structure-1"><a href="#document-structure-1"></a><span class="kw">data</span> <span class="dt">CodeBlock</span> <span class="ot">=</span> <span class="dt">CodeBlock</span></span>
<span id="document-structure-2"><a href="#document-structure-2"></a>    {<span class="ot"> codeLanguage   ::</span> <span class="dt">ProgrammingLanguage</span></span>
<span id="document-structure-3"><a href="#document-structure-3"></a>    ,<span class="ot"> codeProperties ::</span> [<span class="dt">CodeProperty</span>]</span>
<span id="document-structure-4"><a href="#document-structure-4"></a>    ,<span class="ot"> codeSource     ::</span> <span class="dt">Text</span></span>
<span id="document-structure-5"><a href="#document-structure-5"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span></code></pre></div>
</div>
<p>A <code>ProgrammingLanguage</code> is either a known language (for which we know how to generate comments) an unknown (or misspelled) class identifier, or empty.</p>
<div class="annotated-code">
<p><span><em>«document-structure»+</em></span></p>
<div class="sourceCode" id="document-structure"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="document-structure-1"><a href="#document-structure-1"></a><span class="kw">data</span> <span class="dt">ProgrammingLanguage</span></span>
<span id="document-structure-2"><a href="#document-structure-2"></a>    <span class="ot">=</span> <span class="dt">KnownLanguage</span> <span class="dt">Language</span></span>
<span id="document-structure-3"><a href="#document-structure-3"></a>    <span class="op">|</span> <span class="dt">UnknownClass</span> <span class="dt">Text</span></span>
<span id="document-structure-4"><a href="#document-structure-4"></a>    <span class="op">|</span> <span class="dt">NoLanguage</span></span>
<span id="document-structure-5"><a href="#document-structure-5"></a>    <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span></code></pre></div>
</div>
<h4 id="extracting-attributes">Extracting attributes</h4>
<div class="annotated-code">
<p><span><em>«document-structure»+</em></span></p>
<div class="sourceCode" id="document-structure"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="document-structure-1"><a href="#document-structure-1"></a><span class="ot">getCodeClasses ::</span> <span class="dt">CodeBlock</span> <span class="ot">-&gt;</span> [<span class="dt">Text</span>]</span>
<span id="document-structure-2"><a href="#document-structure-2"></a>getCodeClasses <span class="dt">CodeBlock</span>{<span class="op">..</span>} <span class="ot">=</span> classes codeProperties</span>
<span id="document-structure-3"><a href="#document-structure-3"></a>    <span class="kw">where</span> classes [] <span class="ot">=</span> []</span>
<span id="document-structure-4"><a href="#document-structure-4"></a>          classes (<span class="dt">CodeClass</span> c <span class="op">:</span> cs) <span class="ot">=</span> c <span class="op">:</span> classes cs</span>
<span id="document-structure-5"><a href="#document-structure-5"></a>          classes (_ <span class="op">:</span> cs) <span class="ot">=</span> classes cs</span>
<span id="document-structure-6"><a href="#document-structure-6"></a></span>
<span id="document-structure-7"><a href="#document-structure-7"></a><span class="ot">getCodeAttributes ::</span> <span class="dt">CodeBlock</span> <span class="ot">-&gt;</span> [(<span class="dt">Text</span>, <span class="dt">Text</span>)]</span>
<span id="document-structure-8"><a href="#document-structure-8"></a>getCodeAttributes <span class="dt">CodeBlock</span>{<span class="op">..</span>} <span class="ot">=</span> attrs codeProperties</span>
<span id="document-structure-9"><a href="#document-structure-9"></a>    <span class="kw">where</span> attrs [] <span class="ot">=</span> []</span>
<span id="document-structure-10"><a href="#document-structure-10"></a>          attrs (<span class="dt">CodeAttribute</span> k v <span class="op">:</span> cs) <span class="ot">=</span> (k, v) <span class="op">:</span> attrs cs</span>
<span id="document-structure-11"><a href="#document-structure-11"></a>          attrs (_ <span class="op">:</span> cs) <span class="ot">=</span> attrs cs</span></code></pre></div>
</div>
<h2 id="conversion">Conversion</h2>
<p>We can convert a reference back to text by looking up the reference. If the code block is emtpy this returns <code>Nothing</code>. This is due to the choice not to include the final newline in the code block.</p>
<div class="annotated-code">
<p><span><em>«document-conversion»=</em></span></p>
<div class="sourceCode" id="document-conversion"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="document-conversion-1"><a href="#document-conversion-1"></a><span class="ot">contentToText ::</span> <span class="dt">ReferenceMap</span> <span class="ot">-&gt;</span> <span class="dt">Content</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Text</span></span>
<span id="document-conversion-2"><a href="#document-conversion-2"></a>contentToText ref (<span class="dt">PlainText</span> x) <span class="ot">=</span> <span class="dt">Just</span> x</span>
<span id="document-conversion-3"><a href="#document-conversion-3"></a>contentToText ref (<span class="dt">Reference</span> r) </span>
<span id="document-conversion-4"><a href="#document-conversion-4"></a>    <span class="op">|</span> code <span class="op">==</span> <span class="st">&quot;&quot;</span> <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="document-conversion-5"><a href="#document-conversion-5"></a>    <span class="op">|</span> <span class="fu">otherwise</span>  <span class="ot">=</span> <span class="dt">Just</span> code</span>
<span id="document-conversion-6"><a href="#document-conversion-6"></a>    <span class="kw">where</span> <span class="dt">CodeBlock</span> _ _ code <span class="ot">=</span> ref <span class="op">M.!</span> r</span></code></pre></div>
</div>
<p>Stitching text back together:</p>
<div class="annotated-code">
<p><span><em>«document-conversion»+</em></span></p>
<div class="sourceCode" id="document-conversion"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="document-conversion-1"><a href="#document-conversion-1"></a><span class="ot">stitchText ::</span> <span class="dt">Document</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="document-conversion-2"><a href="#document-conversion-2"></a>stitchText (<span class="dt">Document</span> refs c) <span class="ot">=</span> T.unlines <span class="op">$</span> mapMaybe (contentToText refs) c</span></code></pre></div>
</div>
<h1 id="database">Database</h1>
<p>We use an SQLite database to manage document content. Using SQL requires a remapping of the available data.</p>
<div class="annotated-code">
<p><span><em>«src/Database.hs»=</em></span></p>
<div class="sourceCode" id="cb11" data-file="src/Database.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="ot">{-# LANGUAGE DeriveGeneric, OverloadedLabels #-}</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">module</span> <span class="dt">Database</span> <span class="kw">where</span></span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="op">&lt;&lt;</span>database<span class="op">-</span>imports<span class="op">&gt;&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="op">&lt;&lt;</span>database<span class="op">-</span>types<span class="op">&gt;&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="op">&lt;&lt;</span>database<span class="op">-</span>create<span class="op">&gt;&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="op">&lt;&lt;</span>database<span class="op">-</span>insertion<span class="op">&gt;&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="op">&lt;&lt;</span>database<span class="op">-</span>update<span class="op">&gt;&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="op">&lt;&lt;</span>database<span class="op">-</span>queries<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<h2 id="types">Types</h2>
<p>We wrap all SQL interaction in a <code>SQL</code> monad, which stores the <code>Connection</code> object and a logger.</p>
<div class="annotated-code">
<p><span><em>«database-imports»=</em></span></p>
<div class="sourceCode" id="database-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-imports-1"><a href="#database-imports-1"></a><span class="kw">import</span> <span class="dt">Paths_entangled</span></span>
<span id="database-imports-2"><a href="#database-imports-2"></a></span>
<span id="database-imports-3"><a href="#database-imports-3"></a><span class="kw">import</span> <span class="dt">Logging</span></span>
<span id="database-imports-4"><a href="#database-imports-4"></a></span>
<span id="database-imports-5"><a href="#database-imports-5"></a><span class="kw">import</span> <span class="dt">Database.SQLite.Simple</span></span>
<span id="database-imports-6"><a href="#database-imports-6"></a><span class="kw">import</span> <span class="dt">Database.SQLite.Simple.FromRow</span></span>
<span id="database-imports-7"><a href="#database-imports-7"></a></span>
<span id="database-imports-8"><a href="#database-imports-8"></a><span class="kw">import</span> <span class="dt">Control.Monad.Reader</span></span>
<span id="database-imports-9"><a href="#database-imports-9"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span></span>
<span id="database-imports-10"><a href="#database-imports-10"></a><span class="kw">import</span> <span class="dt">Control.Monad.Catch</span></span>
<span id="database-imports-11"><a href="#database-imports-11"></a><span class="kw">import</span> <span class="dt">Control.Monad.Writer</span></span>
<span id="database-imports-12"><a href="#database-imports-12"></a></span>
<span id="database-imports-13"><a href="#database-imports-13"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="database-imports-14"><a href="#database-imports-14"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.IO</span> <span class="kw">as</span> <span class="dt">T.IO</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«database-types»=</em></span></p>
<div class="sourceCode" id="database-types"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-types-1"><a href="#database-types-1"></a><span class="kw">newtype</span> <span class="dt">SQL</span> a <span class="ot">=</span> <span class="dt">SQL</span> {<span class="ot"> unSQL ::</span> <span class="dt">WriterT</span> [(<span class="dt">LogLevel</span>, <span class="dt">Text</span>)] (<span class="dt">ReaderT</span> <span class="dt">Connection</span> <span class="dt">IO</span>) a }</span>
<span id="database-types-2"><a href="#database-types-2"></a>    <span class="kw">deriving</span> (<span class="dt">Applicative</span>, <span class="dt">Functor</span>, <span class="dt">Monad</span>, <span class="dt">MonadIO</span>, <span class="dt">MonadThrow</span>, <span class="dt">MonadLogger</span>)</span>
<span id="database-types-3"><a href="#database-types-3"></a></span>
<span id="database-types-4"><a href="#database-types-4"></a><span class="kw">class</span> (<span class="dt">MonadIO</span> m, <span class="dt">MonadThrow</span> m, <span class="dt">MonadLogger</span> m) <span class="ot">=&gt;</span> <span class="dt">MonadSQL</span> m <span class="kw">where</span></span>
<span id="database-types-5"><a href="#database-types-5"></a><span class="ot">    getConnection ::</span> m <span class="dt">Connection</span></span>
<span id="database-types-6"><a href="#database-types-6"></a><span class="ot">    runSQL ::</span> (<span class="dt">MonadIO</span> n, <span class="dt">MonadLogger</span> n) <span class="ot">=&gt;</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> m a <span class="ot">-&gt;</span> n a</span>
<span id="database-types-7"><a href="#database-types-7"></a></span>
<span id="database-types-8"><a href="#database-types-8"></a><span class="kw">instance</span> <span class="dt">MonadSQL</span> <span class="dt">SQL</span> <span class="kw">where</span></span>
<span id="database-types-9"><a href="#database-types-9"></a>    getConnection <span class="ot">=</span> <span class="dt">SQL</span> ask</span>
<span id="database-types-10"><a href="#database-types-10"></a>    runSQL conn (<span class="dt">SQL</span> x) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-types-11"><a href="#database-types-11"></a>        (x, msgs) <span class="ot">&lt;-</span> liftIO <span class="op">$</span> runReaderT (runWriterT x) conn</span>
<span id="database-types-12"><a href="#database-types-12"></a>        forwardEntries msgs</span>
<span id="database-types-13"><a href="#database-types-13"></a>        <span class="fu">return</span> x</span>
<span id="database-types-14"><a href="#database-types-14"></a></span>
<span id="database-types-15"><a href="#database-types-15"></a><span class="ot">withSQL ::</span> (<span class="dt">MonadIO</span> m, <span class="dt">MonadLogger</span> m) <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">SQL</span> a <span class="ot">-&gt;</span> m a</span>
<span id="database-types-16"><a href="#database-types-16"></a>withSQL p (<span class="dt">SQL</span> x) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-types-17"><a href="#database-types-17"></a>    (x, msgs) <span class="ot">&lt;-</span> liftIO <span class="op">$</span> withConnection p (liftIO <span class="op">.</span> runReaderT (runWriterT x))</span>
<span id="database-types-18"><a href="#database-types-18"></a>    forwardEntries msgs</span>
<span id="database-types-19"><a href="#database-types-19"></a>    <span class="fu">return</span> x</span></code></pre></div>
</div>
<p>The <code>SQLite.Simple</code> function <code>withTransaction</code> takes an <code>IO</code> action as argument. We somehow have to redirect logging information around the unpacking to <code>IO</code> and lifting back to <code>MonadSQL</code>. This is not the prettiest solution, and we see some repetition of the pattern where we unpack result and log, forward log to outer monad and return result pattern.</p>
<p>All the <code>RedirectLog</code> code is needed to aid the type checker, or it won’t know what to do.</p>
<div class="annotated-code">
<p><span><em>«database-types»+</em></span></p>
<div class="sourceCode" id="database-types"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-types-1"><a href="#database-types-1"></a><span class="kw">type</span> <span class="dt">RedirectLog</span> m a <span class="ot">=</span> <span class="dt">WriterT</span> [(<span class="dt">LogLevel</span>, <span class="dt">Text</span>)] m a</span>
<span id="database-types-2"><a href="#database-types-2"></a></span>
<span id="database-types-3"><a href="#database-types-3"></a><span class="ot">redirectLogger ::</span> (<span class="dt">MonadIO</span> m, <span class="dt">MonadSQL</span> n) <span class="ot">=&gt;</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> n a <span class="ot">-&gt;</span> <span class="dt">RedirectLog</span> m a</span>
<span id="database-types-4"><a href="#database-types-4"></a>redirectLogger conn x <span class="ot">=</span> runSQL conn x</span>
<span id="database-types-5"><a href="#database-types-5"></a></span>
<span id="database-types-6"><a href="#database-types-6"></a><span class="ot">withTransactionM ::</span> (<span class="dt">MonadSQL</span> m) <span class="ot">=&gt;</span> m a <span class="ot">-&gt;</span> m a</span>
<span id="database-types-7"><a href="#database-types-7"></a>withTransactionM t <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-types-8"><a href="#database-types-8"></a>    conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-types-9"><a href="#database-types-9"></a>    (x, msgs) <span class="ot">&lt;-</span> liftIO <span class="op">$</span> withTransaction conn <span class="op">$</span> runWriterT <span class="op">$</span> redirectLogger conn t</span>
<span id="database-types-10"><a href="#database-types-10"></a>    forwardEntries msgs</span>
<span id="database-types-11"><a href="#database-types-11"></a>    <span class="fu">return</span> x</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«database-imports»+</em></span></p>
<div class="sourceCode" id="database-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-imports-1"><a href="#database-imports-1"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-map&gt;&gt;</span>
<span id="database-imports-2"><a href="#database-imports-2"></a><span class="kw">import</span> <span class="dt">Data.Maybe</span> (catMaybes)</span>
<span id="database-imports-3"><a href="#database-imports-3"></a><span class="kw">import</span> <span class="dt">Data.Int</span> (<span class="dt">Int64</span>)</span>
<span id="database-imports-4"><a href="#database-imports-4"></a></span>
<span id="database-imports-5"><a href="#database-imports-5"></a><span class="kw">import</span> <span class="dt">Document</span></span>
<span id="database-imports-6"><a href="#database-imports-6"></a><span class="kw">import</span> <span class="dt">Config</span></span>
<span id="database-imports-7"><a href="#database-imports-7"></a><span class="kw">import</span> <span class="dt">TextUtil</span></span></code></pre></div>
</div>
<div class="note">
<p>use <code>pragma foreign_keys = true</code>.</p>
</div>
<p>A diagram for this schema, generated with <code>sqleton</code>. It would be awesome if the following would work.</p>
<p><code>{.make #-knit- .-hidden-} schema.svg: &lt;&lt;file|schema&gt;&gt;     cat $&lt; | sqlite3 database     sqleton -o $@ database -e -L circo</code></p>
<figure>
<img src="schema.svg" alt="" /><figcaption>Schema</figcaption>
</figure>
<p>In <code>SQLite.Simple</code> the above schema becomes</p>
<div class="annotated-code">
<p><span><em>«data/schema.sql»=</em></span></p>
<pre class="sqlite" data-file="data/schema.sql"><code>-- vim:ft=sqlite
pragma synchronous = off;
pragma journal_mode = memory;
pragma foreign_keys = on;

&lt;&lt;schema&gt;&gt;</code></pre>
</div>
<div class="TODO">
<p>Implement the interface in Selda.</p>
</div>
<h2 id="create-database">Create database</h2>
<div class="annotated-code">
<p><span><em>«database-create»=</em></span></p>
<div class="sourceCode" id="database-create"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-create-1"><a href="#database-create-1"></a><span class="ot">schema ::</span> <span class="dt">IO</span> [<span class="dt">Query</span>]</span>
<span id="database-create-2"><a href="#database-create-2"></a>schema <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-create-3"><a href="#database-create-3"></a>    schema_path <span class="ot">&lt;-</span> getDataFileName <span class="st">&quot;data/schema.sql&quot;</span></span>
<span id="database-create-4"><a href="#database-create-4"></a>    qs <span class="ot">&lt;-</span>  T.splitOn <span class="st">&quot;;&quot;</span> <span class="op">&lt;$&gt;</span> T.IO.readFile schema_path</span>
<span id="database-create-5"><a href="#database-create-5"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="fu">map</span> <span class="dt">Query</span> (<span class="fu">init</span> qs)</span>
<span id="database-create-6"><a href="#database-create-6"></a></span>
<span id="database-create-7"><a href="#database-create-7"></a><span class="ot">createTables ::</span> <span class="dt">SQL</span> ()</span>
<span id="database-create-8"><a href="#database-create-8"></a>createTables <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-create-9"><a href="#database-create-9"></a>    conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-create-10"><a href="#database-create-10"></a>    liftIO <span class="op">$</span> schema <span class="op">&gt;&gt;=</span> <span class="fu">mapM_</span> (execute_ conn)</span></code></pre></div>
</div>
<h2 id="insertion">Insertion</h2>
<h3 id="documents">Documents</h3>
<div class="annotated-code">
<p><span><em>«schema»=</em></span></p>
<pre id="schema" class="sqlite"><code>create table if not exists &quot;documents&quot;
    ( &quot;id&quot;        integer primary key autoincrement
    , &quot;filename&quot;  text not null
    , &quot;time&quot;      timestamp default current_timestamp not null
    );</code></pre>
</div>
<h3 id="codes">Codes</h3>
<p>The code table maps to a <code>ReferencePair</code> containing both <code>CodeBlock</code> and <code>ReferenceId</code>. I use the <code>name</code>, <code>ordinal</code> pair as primary key.</p>
<div class="annotated-code">
<p><span><em>«schema»+</em></span></p>
<pre id="schema" class="sqlite"><code>create table if not exists &quot;codes&quot;
    ( &quot;name&quot;      text not null
    , &quot;ordinal&quot;   integer not null
    , &quot;source&quot;    text not null
    , &quot;language&quot;  text not null
    , &quot;document&quot;  integer not null
    , primary key (&quot;name&quot;, &quot;ordinal&quot;)
    , foreign key (&quot;document&quot;) references &quot;documents&quot;(&quot;id&quot;) );</code></pre>
</div>
<div class="annotated-code">
<p><span><em>«database-insertion»=</em></span></p>
<div class="sourceCode" id="database-insertion"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-insertion-1"><a href="#database-insertion-1"></a><span class="ot">insertCodes ::</span> <span class="dt">Int64</span> <span class="ot">-&gt;</span> <span class="dt">ReferenceMap</span> <span class="ot">-&gt;</span> <span class="dt">SQL</span> ()</span>
<span id="database-insertion-2"><a href="#database-insertion-2"></a>insertCodes docId codes <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-insertion-3"><a href="#database-insertion-3"></a>        conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-insertion-4"><a href="#database-insertion-4"></a>        liftIO <span class="op">$</span> executeMany conn <span class="st">&quot;insert into `codes` values (?,?,?,?,?)&quot;</span> rows</span>
<span id="database-insertion-5"><a href="#database-insertion-5"></a>        liftIO <span class="op">$</span> executeMany conn <span class="st">&quot;insert into `classes` values (?,?,?)&quot;</span> classes</span>
<span id="database-insertion-6"><a href="#database-insertion-6"></a>    <span class="kw">where</span> codeRow ( (<span class="dt">ReferenceId</span> (<span class="dt">ReferenceName</span> name) count)</span>
<span id="database-insertion-7"><a href="#database-insertion-7"></a>                  , (<span class="dt">CodeBlock</span> (<span class="dt">KnownLanguage</span> <span class="dt">Language</span>{languageName}) _ source) )</span>
<span id="database-insertion-8"><a href="#database-insertion-8"></a>              <span class="ot">=</span> <span class="dt">Just</span> (name, count, source, languageName, docId)</span>
<span id="database-insertion-9"><a href="#database-insertion-9"></a>          codeRow _</span>
<span id="database-insertion-10"><a href="#database-insertion-10"></a>              <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="database-insertion-11"><a href="#database-insertion-11"></a>          rows <span class="ot">=</span> catMaybes <span class="op">$</span> <span class="fu">map</span> codeRow (M.toList codes)</span>
<span id="database-insertion-12"><a href="#database-insertion-12"></a>          classRows ( (<span class="dt">ReferenceId</span> (<span class="dt">ReferenceName</span> name) count)</span>
<span id="database-insertion-13"><a href="#database-insertion-13"></a>                    , block )</span>
<span id="database-insertion-14"><a href="#database-insertion-14"></a>              <span class="ot">=</span> <span class="fu">map</span> (\c <span class="ot">-&gt;</span> (c, name, count)) <span class="op">$</span> getCodeClasses block</span>
<span id="database-insertion-15"><a href="#database-insertion-15"></a>          classes <span class="ot">=</span> <span class="fu">concatMap</span> classRows (M.toList codes)</span></code></pre></div>
</div>
<p>A table that references specific code blocks should reference both the code name and the code ordinal.</p>
<div class="annotated-code">
<p><span><em>«reference-code»=</em></span></p>
<pre id="reference-code" class="sqlite"><code>, &quot;codeName&quot;    text not null
, &quot;codeOrdinal&quot; integer not null
, constraint &quot;rcode&quot; foreign key (&quot;codeName&quot;, &quot;codeOrdinal&quot;) references &quot;codes&quot;(&quot;name&quot;,&quot;ordinal&quot;) on delete cascade
-- , foreign key (&quot;codeName&quot;) references &quot;codes&quot;(&quot;name&quot;)
-- , foreign key (&quot;codeOrdinal&quot;) references &quot;codes&quot;(&quot;ordinal&quot;)</code></pre>
</div>
<h3 id="classes-and-attributes">Classes and attributes</h3>
<div class="annotated-code">
<p><span><em>«schema»+</em></span></p>
<pre id="schema" class="sqlite"><code>create table if not exists &quot;classes&quot;
    ( &quot;class&quot;       text not null
    &lt;&lt;reference-code&gt;&gt;
    );

create table if not exists &quot;attributes&quot;
    ( &quot;attribute&quot;   text not null
    , &quot;value&quot;       text not null
    &lt;&lt;reference-code&gt;&gt;
    );</code></pre>
</div>
<h3 id="content">Content</h3>
<div class="annotated-code">
<p><span><em>«schema»+</em></span></p>
<pre id="schema" class="sqlite"><code>create table if not exists &quot;content&quot;
    ( &quot;id&quot;          integer primary key autoincrement
    , &quot;document&quot;    integer not null
    , &quot;plain&quot;       text
    , &quot;codeName&quot;    text
    , &quot;codeOrdinal&quot; integer
    , foreign key (&quot;document&quot;) references &quot;documents&quot;(&quot;id&quot;)
    , foreign key (&quot;codeName&quot;, &quot;codeOrdinal&quot;) references &quot;codes&quot;(&quot;name&quot;,&quot;ordinal&quot;)
    );
    -- , check (&quot;plain&quot; is not null or (&quot;codeName&quot; is not null and &quot;codeOrdinal&quot; is not null)) )</code></pre>
</div>
<div class="annotated-code">
<p><span><em>«database-insertion»+</em></span></p>
<div class="sourceCode" id="database-insertion"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-insertion-1"><a href="#database-insertion-1"></a><span class="ot">insertContent ::</span> <span class="dt">Int64</span> <span class="ot">-&gt;</span> [<span class="dt">Content</span>] <span class="ot">-&gt;</span> <span class="dt">SQL</span> ()</span>
<span id="database-insertion-2"><a href="#database-insertion-2"></a>insertContent docId content <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-insertion-3"><a href="#database-insertion-3"></a>        conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-insertion-4"><a href="#database-insertion-4"></a>        liftIO <span class="op">$</span> executeMany conn <span class="st">&quot;insert into `content`(`document`,`plain`,`codeName`,`codeOrdinal`) values (?,?,?,?)&quot;</span> rows</span>
<span id="database-insertion-5"><a href="#database-insertion-5"></a>    <span class="kw">where</span> contentRow (<span class="dt">PlainText</span> text)</span>
<span id="database-insertion-6"><a href="#database-insertion-6"></a>              <span class="ot">=</span> (docId, <span class="dt">Just</span> text, <span class="dt">Nothing</span>, <span class="dt">Nothing</span>)</span>
<span id="database-insertion-7"><a href="#database-insertion-7"></a>          contentRow (<span class="dt">Reference</span> (<span class="dt">ReferenceId</span> (<span class="dt">ReferenceName</span> name) count))</span>
<span id="database-insertion-8"><a href="#database-insertion-8"></a>              <span class="ot">=</span> (docId, <span class="dt">Nothing</span>, <span class="dt">Just</span> name, <span class="dt">Just</span> count)</span>
<span id="database-insertion-9"><a href="#database-insertion-9"></a>          rows <span class="ot">=</span> <span class="fu">map</span> contentRow content</span></code></pre></div>
</div>
<h3 id="targets">Targets</h3>
<div class="annotated-code">
<p><span><em>«schema»+</em></span></p>
<pre id="schema" class="sqlite"><code>create table if not exists &quot;targets&quot;
    ( &quot;filename&quot;  text not null unique
    , &quot;codename&quot;  text not null
    , &quot;document&quot;  integer not null
    , &quot;time&quot;      timestamp default current_timestamp not null
    -- , foreign key (&quot;codename&quot;) references &quot;codes&quot;(&quot;name&quot;)
    , foreign key (&quot;document&quot;) references &quot;documents&quot;(&quot;id&quot;) );</code></pre>
</div>
<div class="annotated-code">
<p><span><em>«database-insertion»+</em></span></p>
<div class="sourceCode" id="database-insertion"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-insertion-1"><a href="#database-insertion-1"></a><span class="ot">insertTargets ::</span> <span class="dt">Int64</span> <span class="ot">-&gt;</span> <span class="dt">Map</span> <span class="dt">FilePath</span> <span class="dt">ReferenceName</span> <span class="ot">-&gt;</span> <span class="dt">SQL</span> ()</span>
<span id="database-insertion-2"><a href="#database-insertion-2"></a>insertTargets docId files <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-insertion-3"><a href="#database-insertion-3"></a>        conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-insertion-4"><a href="#database-insertion-4"></a>        liftIO <span class="op">$</span> <span class="fu">print</span> rows</span>
<span id="database-insertion-5"><a href="#database-insertion-5"></a>        liftIO <span class="op">$</span> executeMany conn <span class="st">&quot;insert into `targets`(`filename`,`codename`,`document`) values (?, ?, ?)&quot;</span> rows</span>
<span id="database-insertion-6"><a href="#database-insertion-6"></a>    <span class="kw">where</span> targetRow (path, <span class="dt">ReferenceName</span> name) <span class="ot">=</span> (path, name, docId)</span>
<span id="database-insertion-7"><a href="#database-insertion-7"></a>          rows <span class="ot">=</span> <span class="fu">map</span> targetRow (M.toList files)</span></code></pre></div>
</div>
<h2 id="updating">Updating</h2>
<h3 id="tangle-1">Tangle</h3>
<p>When a Markdown source is written to, we first remove all data that was inserted from that document and then reinsert the new data. This is to prevent that code blocks remain from older versions. This problem could also be solved by a separate garbage collection step.</p>
<div class="annotated-code">
<p><span><em>«database-update»=</em></span></p>
<div class="sourceCode" id="database-update"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-update-1"><a href="#database-update-1"></a><span class="ot">getDocumentId ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">SQL</span> (<span class="dt">Maybe</span> <span class="dt">Int64</span>)</span>
<span id="database-update-2"><a href="#database-update-2"></a>getDocumentId rel_path <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-update-3"><a href="#database-update-3"></a>    conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-update-4"><a href="#database-update-4"></a>    docId&#39; <span class="ot">&lt;-</span> liftIO <span class="op">$</span> query conn <span class="st">&quot;select `id` from `documents` where `filename` is ?&quot;</span> (<span class="dt">Only</span> rel_path)</span>
<span id="database-update-5"><a href="#database-update-5"></a>    <span class="kw">case</span> docId&#39; <span class="kw">of</span></span>
<span id="database-update-6"><a href="#database-update-6"></a>        []             <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="database-update-7"><a href="#database-update-7"></a>        [(<span class="dt">Only</span> docId)] <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> docId</span>
<span id="database-update-8"><a href="#database-update-8"></a>        _              <span class="ot">-&gt;</span> throwM <span class="op">$</span> <span class="dt">DatabaseError</span></span>
<span id="database-update-9"><a href="#database-update-9"></a>                                 <span class="op">$</span> <span class="st">&quot;file `&quot;</span> <span class="op">&lt;&gt;</span> T.pack rel_path <span class="op">&lt;&gt;</span> <span class="st">&quot;` has multiple entries.&quot;</span></span>
<span id="database-update-10"><a href="#database-update-10"></a></span>
<span id="database-update-11"><a href="#database-update-11"></a><span class="ot">removeDocumentData ::</span> <span class="dt">Int64</span> <span class="ot">-&gt;</span> <span class="dt">SQL</span> ()</span>
<span id="database-update-12"><a href="#database-update-12"></a>removeDocumentData docId <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-update-13"><a href="#database-update-13"></a>    conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-update-14"><a href="#database-update-14"></a>    liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="database-update-15"><a href="#database-update-15"></a>        execute conn <span class="st">&quot;delete from `targets` where `document` is ?&quot;</span> (<span class="dt">Only</span> docId)</span>
<span id="database-update-16"><a href="#database-update-16"></a>        execute conn <span class="st">&quot;delete from `content` where `document` is ?&quot;</span> (<span class="dt">Only</span> docId)</span>
<span id="database-update-17"><a href="#database-update-17"></a>        execute conn <span class="st">&quot;delete from `codes` where `document` is ?&quot;</span> (<span class="dt">Only</span> docId)</span>
<span id="database-update-18"><a href="#database-update-18"></a></span>
<span id="database-update-19"><a href="#database-update-19"></a><span class="ot">insertDocument ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Document</span> <span class="ot">-&gt;</span> <span class="dt">SQL</span> ()</span>
<span id="database-update-20"><a href="#database-update-20"></a>insertDocument rel_path <span class="dt">Document</span>{<span class="op">..</span>} <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-update-21"><a href="#database-update-21"></a>    conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-update-22"><a href="#database-update-22"></a>    docId&#39; <span class="ot">&lt;-</span> getDocumentId rel_path</span>
<span id="database-update-23"><a href="#database-update-23"></a>    docId <span class="ot">&lt;-</span> <span class="kw">case</span> docId&#39; <span class="kw">of</span></span>
<span id="database-update-24"><a href="#database-update-24"></a>        <span class="dt">Just</span> docId <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="database-update-25"><a href="#database-update-25"></a>            logMessage <span class="op">$</span> <span class="st">&quot;Replacing &#39;&quot;</span> <span class="op">&lt;&gt;</span> T.pack rel_path <span class="op">&lt;&gt;</span> <span class="st">&quot;&#39;.&quot;</span></span>
<span id="database-update-26"><a href="#database-update-26"></a>            removeDocumentData docId <span class="op">&gt;&gt;</span> <span class="fu">return</span> docId</span>
<span id="database-update-27"><a href="#database-update-27"></a>        <span class="dt">Nothing</span>    <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="database-update-28"><a href="#database-update-28"></a>            logMessage <span class="op">$</span> <span class="st">&quot;Inserting new &#39;&quot;</span> <span class="op">&lt;&gt;</span> T.pack rel_path <span class="op">&lt;&gt;</span> <span class="st">&quot;&#39;.&quot;</span></span>
<span id="database-update-29"><a href="#database-update-29"></a>            liftIO <span class="op">$</span> execute conn <span class="st">&quot;insert into `documents`(`filename`) values (?)&quot;</span> (<span class="dt">Only</span> rel_path)</span>
<span id="database-update-30"><a href="#database-update-30"></a>            liftIO <span class="op">$</span> lastInsertRowId conn</span>
<span id="database-update-31"><a href="#database-update-31"></a>    insertCodes docId references</span>
<span id="database-update-32"><a href="#database-update-32"></a>    insertContent docId documentContent</span>
<span id="database-update-33"><a href="#database-update-33"></a>    insertTargets docId documentTargets</span></code></pre></div>
</div>
<h3 id="stitch-1">Stitch</h3>
<div class="TODO">
<p>Make this update more efficient. See https://stackoverflow.com/questions/11563869/update-multiple-rows-with-different-values-in-a-single-sql-query for an example. Other performance related post: https://stackoverflow.com/questions/1711631/improve-insert-per-second-performance-of-sqlite</p>
</div>
<div class="annotated-code">
<p><span><em>«database-update»+</em></span></p>
<div class="sourceCode" id="database-update"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-update-1"><a href="#database-update-1"></a><span class="ot">updateTarget ::</span> [<span class="dt">ReferencePair</span>] <span class="ot">-&gt;</span> <span class="dt">SQL</span> () </span>
<span id="database-update-2"><a href="#database-update-2"></a>updateTarget refs <span class="ot">=</span> withTransactionM <span class="op">$</span> <span class="fu">mapM_</span> update refs</span>
<span id="database-update-3"><a href="#database-update-3"></a>    <span class="kw">where</span> update (<span class="dt">ReferenceId</span> (<span class="dt">ReferenceName</span> name) count, <span class="dt">CodeBlock</span>{codeSource}) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-update-4"><a href="#database-update-4"></a>              conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-update-5"><a href="#database-update-5"></a>              liftIO <span class="op">$</span> execute conn <span class="st">&quot;update `codes` set `source` = ? where `name` is ? and `ordinal` is ?&quot;</span></span>
<span id="database-update-6"><a href="#database-update-6"></a>                               (codeSource, name, count)</span></code></pre></div>
</div>
<h2 id="queries">Queries</h2>
<div class="annotated-code">
<p><span><em>«database-queries»=</em></span></p>
<div class="sourceCode" id="database-queries"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-queries-1"><a href="#database-queries-1"></a><span class="ot">listTargetFiles ::</span> <span class="dt">SQL</span> [<span class="dt">FilePath</span>]</span>
<span id="database-queries-2"><a href="#database-queries-2"></a>listTargetFiles <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-queries-3"><a href="#database-queries-3"></a>    conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-queries-4"><a href="#database-queries-4"></a>    <span class="fu">map</span> fromOnly <span class="op">&lt;$&gt;</span></span>
<span id="database-queries-5"><a href="#database-queries-5"></a>        liftIO (query_ conn <span class="st">&quot;select `filename` from `targets`&quot;</span><span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">Only</span> <span class="dt">FilePath</span>])</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«database-queries»+</em></span></p>
<div class="sourceCode" id="database-queries"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-queries-1"><a href="#database-queries-1"></a><span class="ot">listSourceFiles ::</span> <span class="dt">SQL</span> [<span class="dt">FilePath</span>]</span>
<span id="database-queries-2"><a href="#database-queries-2"></a>listSourceFiles <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-queries-3"><a href="#database-queries-3"></a>    conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-queries-4"><a href="#database-queries-4"></a>    <span class="fu">map</span> fromOnly <span class="op">&lt;$&gt;</span></span>
<span id="database-queries-5"><a href="#database-queries-5"></a>        liftIO (query_ conn <span class="st">&quot;select `filename` from `documents`&quot;</span><span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">Only</span> <span class="dt">FilePath</span>])</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«database-queries»+</em></span></p>
<div class="sourceCode" id="database-queries"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-queries-1"><a href="#database-queries-1"></a><span class="ot">queryTargetRef ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">SQL</span> (<span class="dt">Maybe</span> <span class="dt">ReferenceName</span>)</span>
<span id="database-queries-2"><a href="#database-queries-2"></a>queryTargetRef rel_path <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-queries-3"><a href="#database-queries-3"></a>    conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-queries-4"><a href="#database-queries-4"></a>    x&#39; <span class="ot">&lt;-</span> liftIO (query conn <span class="st">&quot;select `codename` from `targets` where `filename` is ?&quot;</span> (<span class="dt">Only</span> rel_path)<span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">Only</span> <span class="dt">Text</span>])</span>
<span id="database-queries-5"><a href="#database-queries-5"></a>    <span class="kw">case</span> x&#39; <span class="kw">of</span></span>
<span id="database-queries-6"><a href="#database-queries-6"></a>        []  <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="database-queries-7"><a href="#database-queries-7"></a>        [<span class="dt">Only</span> x] <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> (<span class="dt">ReferenceName</span> x)</span>
<span id="database-queries-8"><a href="#database-queries-8"></a>        _   <span class="ot">-&gt;</span> throwM <span class="op">$</span> <span class="dt">DatabaseError</span> <span class="op">$</span> <span class="st">&quot;target file `&quot;</span> <span class="op">&lt;&gt;</span> T.pack rel_path <span class="op">&lt;&gt;</span> <span class="st">&quot;` has multiple entries.&quot;</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«database-queries»+</em></span></p>
<div class="sourceCode" id="database-queries"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-queries-1"><a href="#database-queries-1"></a><span class="ot">stitchDocument ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">SQL</span> <span class="dt">Text</span></span>
<span id="database-queries-2"><a href="#database-queries-2"></a>stitchDocument rel_path <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-queries-3"><a href="#database-queries-3"></a>    conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-queries-4"><a href="#database-queries-4"></a>    docId <span class="ot">&lt;-</span> getDocumentId rel_path <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="database-queries-5"><a href="#database-queries-5"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throwM <span class="op">$</span> <span class="dt">StitchError</span> <span class="op">$</span> <span class="st">&quot;File `&quot;</span> <span class="op">&lt;&gt;</span> T.pack rel_path <span class="op">&lt;&gt;</span> <span class="st">&quot;` not in database.&quot;</span></span>
<span id="database-queries-6"><a href="#database-queries-6"></a>        <span class="dt">Just</span> x  <span class="ot">-&gt;</span> <span class="fu">return</span> x</span>
<span id="database-queries-7"><a href="#database-queries-7"></a>    result <span class="ot">&lt;-</span> liftIO (query conn <span class="st">&quot;select coalesce(`plain`,`codes`.`source`) from `content` \</span></span>
<span id="database-queries-8"><a href="#database-queries-8"></a><span class="st">                                 \  left outer join `codes` \</span></span>
<span id="database-queries-9"><a href="#database-queries-9"></a><span class="st">                                 \    on (`codeName`,`codeOrdinal`)=(`codes`.`name`,`codes`.`ordinal`) \</span></span>
<span id="database-queries-10"><a href="#database-queries-10"></a><span class="st">                                 \  where `content`.`document` is ?&quot;</span> (<span class="dt">Only</span> docId)<span class="ot"> ::</span> <span class="dt">IO</span> [<span class="dt">Only</span> <span class="dt">Text</span>])</span>
<span id="database-queries-11"><a href="#database-queries-11"></a>    <span class="fu">return</span> <span class="op">$</span> unlines&#39; <span class="op">$</span> <span class="fu">map</span> fromOnly result</span></code></pre></div>
</div>
<h3 id="references">References</h3>
<div class="annotated-code">
<p><span><em>«database-queries»+</em></span></p>
<div class="sourceCode" id="database-queries"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="database-queries-1"><a href="#database-queries-1"></a><span class="ot">queryReferenceMap ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">SQL</span> <span class="dt">ReferenceMap</span></span>
<span id="database-queries-2"><a href="#database-queries-2"></a>queryReferenceMap config <span class="ot">=</span> <span class="kw">do</span></span>
<span id="database-queries-3"><a href="#database-queries-3"></a>        conn <span class="ot">&lt;-</span> getConnection</span>
<span id="database-queries-4"><a href="#database-queries-4"></a>        rows <span class="ot">&lt;-</span> liftIO (query_ conn <span class="st">&quot;select `name`, `ordinal`, `source`, `language` from `codes`&quot;</span><span class="ot"> ::</span> <span class="dt">IO</span> [(<span class="dt">Text</span>, <span class="dt">Int</span>, <span class="dt">Text</span>, <span class="dt">Text</span>)])</span>
<span id="database-queries-5"><a href="#database-queries-5"></a>        M.fromList <span class="op">&lt;$&gt;</span> <span class="fu">mapM</span> (refpair config) rows</span>
<span id="database-queries-6"><a href="#database-queries-6"></a>    <span class="kw">where</span> refpair config (name, ordinal, source, lang) <span class="ot">=</span></span>
<span id="database-queries-7"><a href="#database-queries-7"></a>            <span class="kw">case</span> (languageFromName config lang) <span class="kw">of</span></span>
<span id="database-queries-8"><a href="#database-queries-8"></a>                <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throwM <span class="op">$</span> <span class="dt">DatabaseError</span> <span class="op">$</span> <span class="st">&quot;unknown language: &quot;</span> <span class="op">&lt;&gt;</span> lang</span>
<span id="database-queries-9"><a href="#database-queries-9"></a>                <span class="dt">Just</span> l  <span class="ot">-&gt;</span> <span class="fu">return</span> ( <span class="dt">ReferenceId</span> (<span class="dt">ReferenceName</span> name) ordinal</span>
<span id="database-queries-10"><a href="#database-queries-10"></a>                                  , <span class="dt">CodeBlock</span> (<span class="dt">KnownLanguage</span> l) [] source )</span></code></pre></div>
</div>
<h3 id="document-1">Document</h3>
<h1 id="the-daemon">The Daemon</h1>
<p>The Entangled daemon does the following:</p>
<ul>
<li>Never crash</li>
<li>Monitor markdown files, tangle when written to</li>
<li>Monitor target files, stitch when written to</li>
<li>Pretty print events</li>
</ul>
<div class="annotated-code">
<p><span><em>«src/Daemon.hs»=</em></span></p>
<div class="sourceCode" id="cb13" data-file="src/Daemon.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="op">&lt;&lt;</span>daemon<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<h2 id="strategy">Strategy</h2>
<div class="annotated-code">
<p><span><em>«daemon»=</em></span></p>
<div class="sourceCode" id="daemon"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-1"><a href="#daemon-1"></a><span class="kw">module</span> <span class="dt">Daemon</span> <span class="kw">where</span></span>
<span id="daemon-2"><a href="#daemon-2"></a></span>
<span id="daemon-3"><a href="#daemon-3"></a><span class="kw">import</span> <span class="dt">Prelude</span> <span class="kw">hiding</span> (writeFile, readFile)</span>
<span id="daemon-4"><a href="#daemon-4"></a></span>
<span id="daemon-5"><a href="#daemon-5"></a><span class="op">&lt;&lt;</span>daemon<span class="op">-</span>imports<span class="op">&gt;&gt;</span></span>
<span id="daemon-6"><a href="#daemon-6"></a><span class="op">&lt;&lt;</span>daemon<span class="op">-</span>events<span class="op">&gt;&gt;</span></span>
<span id="daemon-7"><a href="#daemon-7"></a><span class="op">&lt;&lt;</span>daemon<span class="op">-</span>transaction<span class="op">&gt;&gt;</span></span>
<span id="daemon-8"><a href="#daemon-8"></a><span class="op">&lt;&lt;</span>daemon<span class="op">-</span>session<span class="op">&gt;&gt;</span></span>
<span id="daemon-9"><a href="#daemon-9"></a><span class="op">&lt;&lt;</span>daemon<span class="op">-</span>user<span class="op">-</span>io<span class="op">&gt;&gt;</span></span>
<span id="daemon-10"><a href="#daemon-10"></a><span class="op">&lt;&lt;</span>daemon<span class="op">-</span>loading<span class="op">&gt;&gt;</span></span>
<span id="daemon-11"><a href="#daemon-11"></a><span class="op">&lt;&lt;</span>daemon<span class="op">-</span>writing<span class="op">&gt;&gt;</span></span>
<span id="daemon-12"><a href="#daemon-12"></a><span class="op">&lt;&lt;</span>daemon<span class="op">-</span>watches<span class="op">&gt;&gt;</span></span>
<span id="daemon-13"><a href="#daemon-13"></a><span class="op">&lt;&lt;</span>daemon<span class="op">-</span>main<span class="op">-</span>loop<span class="op">&gt;&gt;</span></span>
<span id="daemon-14"><a href="#daemon-14"></a><span class="op">&lt;&lt;</span>daemon<span class="op">-</span>start<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«daemon-imports»=</em></span></p>
<div class="sourceCode" id="daemon-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-imports-1"><a href="#daemon-imports-1"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="daemon-imports-2"><a href="#daemon-imports-2"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.IO</span> <span class="kw">as</span> <span class="dt">T.IO</span> </span>
<span id="daemon-imports-3"><a href="#daemon-imports-3"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-map&gt;&gt;</span>
<span id="daemon-imports-4"><a href="#daemon-imports-4"></a><span class="kw">import</span> <span class="dt">TextUtil</span> (tshow, unlines&#39;)</span></code></pre></div>
</div>
<p>Using lenses we build a <code>Session</code> record. In combination with the <code>State</code> monad (and a <code>Reader Config</code>, and <code>IO</code>) we can manage the Entangled Daemon.</p>
<h3 id="fsnotify">FSNotify</h3>
<p>We use <code>System.FSNotify</code> to setup watches on the files.</p>
<div class="annotated-code">
<p><span><em>«daemon-imports»+</em></span></p>
<div class="sourceCode" id="daemon-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-imports-1"><a href="#daemon-imports-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">System.FSNotify</span> <span class="kw">as</span> <span class="dt">FSNotify</span></span></code></pre></div>
</div>
<p>The watches are set to trigger events of type <code>Event</code>.</p>
<div class="annotated-code">
<p><span><em>«daemon-events»=</em></span></p>
<div class="sourceCode" id="daemon-events"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-events-1"><a href="#daemon-events-1"></a><span class="kw">data</span> <span class="dt">DaemonState</span></span>
<span id="daemon-events-2"><a href="#daemon-events-2"></a>    <span class="ot">=</span> <span class="dt">Idle</span></span>
<span id="daemon-events-3"><a href="#daemon-events-3"></a>    <span class="op">|</span> <span class="dt">Tangling</span></span>
<span id="daemon-events-4"><a href="#daemon-events-4"></a>    <span class="op">|</span> <span class="dt">Stitching</span></span>
<span id="daemon-events-5"><a href="#daemon-events-5"></a>    <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="daemon-events-6"><a href="#daemon-events-6"></a></span>
<span id="daemon-events-7"><a href="#daemon-events-7"></a><span class="kw">data</span> <span class="dt">Event</span></span>
<span id="daemon-events-8"><a href="#daemon-events-8"></a>    <span class="ot">=</span> <span class="dt">WriteSource</span> <span class="dt">FilePath</span></span>
<span id="daemon-events-9"><a href="#daemon-events-9"></a>    <span class="op">|</span> <span class="dt">WriteTarget</span> <span class="dt">FilePath</span></span>
<span id="daemon-events-10"><a href="#daemon-events-10"></a>    <span class="op">|</span> <span class="dt">DebugEvent</span> <span class="dt">Text</span></span>
<span id="daemon-events-11"><a href="#daemon-events-11"></a>    <span class="kw">deriving</span> (<span class="dt">Show</span>)</span></code></pre></div>
</div>
<h3 id="transactions">Transactions</h3>
<p>When an event happened we need to respond, usually by writing out several files. Since <code>IO</code> is a <code>Monoid</code>, we can append <code>IO</code> actions and keep track of describing the gathered events in a <code>Transaction</code>. There are some things that we may need to ask the user permission for, like overwriting files in dubious circumstances. Messaging is done through pretty-printed <code>Doc</code>.</p>
<div class="annotated-code">
<p><span><em>«daemon-imports»+</em></span></p>
<div class="sourceCode" id="daemon-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-imports-1"><a href="#daemon-imports-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.Prettyprint.Doc</span> <span class="kw">as</span> <span class="dt">P</span></span>
<span id="daemon-imports-2"><a href="#daemon-imports-2"></a><span class="kw">import</span> <span class="dt">Console</span> (<span class="dt">Doc</span>)</span>
<span id="daemon-imports-3"><a href="#daemon-imports-3"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Console</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«daemon-transaction»=</em></span></p>
<div class="sourceCode" id="daemon-transaction"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-transaction-1"><a href="#daemon-transaction-1"></a><span class="kw">data</span> <span class="dt">Transaction</span> <span class="ot">=</span> <span class="dt">Transaction</span></span>
<span id="daemon-transaction-2"><a href="#daemon-transaction-2"></a>  {<span class="ot"> action ::</span> <span class="dt">Maybe</span> (<span class="dt">IO</span> ())</span>
<span id="daemon-transaction-3"><a href="#daemon-transaction-3"></a>  ,<span class="ot"> description ::</span> <span class="dt">Doc</span></span>
<span id="daemon-transaction-4"><a href="#daemon-transaction-4"></a>  ,<span class="ot"> needConfirm ::</span> <span class="dt">Bool</span> }</span></code></pre></div>
</div>
<p>The <code>action</code> is wrapped in a <code>Maybe</code> so that we can tell if the <code>Transaction</code> does anything. A <code>Transaction</code> is a <code>Monoid</code>.</p>
<div class="annotated-code">
<p><span><em>«daemon-transaction»+</em></span></p>
<div class="sourceCode" id="daemon-transaction"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-transaction-1"><a href="#daemon-transaction-1"></a><span class="kw">instance</span> <span class="dt">Semigroup</span> <span class="dt">Transaction</span> <span class="kw">where</span></span>
<span id="daemon-transaction-2"><a href="#daemon-transaction-2"></a>    (<span class="dt">Transaction</span> al dl cl) <span class="op">&lt;&gt;</span> (<span class="dt">Transaction</span> ar dr cr)</span>
<span id="daemon-transaction-3"><a href="#daemon-transaction-3"></a>      <span class="ot">=</span> <span class="dt">Transaction</span> (al <span class="op">&lt;&gt;</span> ar) (dl <span class="op">&lt;&gt;</span> dr) (cl <span class="op">||</span> cr)</span>
<span id="daemon-transaction-4"><a href="#daemon-transaction-4"></a></span>
<span id="daemon-transaction-5"><a href="#daemon-transaction-5"></a><span class="kw">instance</span> <span class="dt">Monoid</span> <span class="dt">Transaction</span> <span class="kw">where</span></span>
<span id="daemon-transaction-6"><a href="#daemon-transaction-6"></a>    <span class="fu">mempty</span> <span class="ot">=</span> <span class="dt">Transaction</span> <span class="fu">mempty</span> <span class="fu">mempty</span> <span class="dt">False</span></span></code></pre></div>
</div>
<p>We can build <code>Transaction</code>s by appending elemental parts.</p>
<div class="annotated-code">
<p><span><em>«daemon-transaction»+</em></span></p>
<div class="sourceCode" id="daemon-transaction"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-transaction-1"><a href="#daemon-transaction-1"></a><span class="ot">plan ::</span> <span class="dt">IO</span> () <span class="ot">-&gt;</span> <span class="dt">Transaction</span></span>
<span id="daemon-transaction-2"><a href="#daemon-transaction-2"></a>plan action <span class="ot">=</span> <span class="dt">Transaction</span> (<span class="dt">Just</span> action) <span class="fu">mempty</span> <span class="dt">False</span></span>
<span id="daemon-transaction-3"><a href="#daemon-transaction-3"></a></span>
<span id="daemon-transaction-4"><a href="#daemon-transaction-4"></a><span class="ot">doc ::</span> <span class="dt">Doc</span> <span class="ot">-&gt;</span> <span class="dt">Transaction</span></span>
<span id="daemon-transaction-5"><a href="#daemon-transaction-5"></a>doc x <span class="ot">=</span> <span class="dt">Transaction</span> <span class="dt">Nothing</span> x <span class="dt">False</span></span>
<span id="daemon-transaction-6"><a href="#daemon-transaction-6"></a></span>
<span id="daemon-transaction-7"><a href="#daemon-transaction-7"></a><span class="ot">msg ::</span> <span class="dt">P.Pretty</span> a <span class="ot">=&gt;</span> <span class="dt">LogLevel</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Transaction</span></span>
<span id="daemon-transaction-8"><a href="#daemon-transaction-8"></a>msg level doc <span class="ot">=</span> <span class="dt">Transaction</span> <span class="dt">Nothing</span> (Console.msg level doc) <span class="dt">False</span></span>
<span id="daemon-transaction-9"><a href="#daemon-transaction-9"></a></span>
<span id="daemon-transaction-10"><a href="#daemon-transaction-10"></a><span class="ot">confirm ::</span> <span class="dt">Transaction</span></span>
<span id="daemon-transaction-11"><a href="#daemon-transaction-11"></a>confirm <span class="ot">=</span> <span class="dt">Transaction</span> <span class="fu">mempty</span> <span class="fu">mempty</span> <span class="dt">True</span></span></code></pre></div>
</div>
<p>In most of the program logic, <code>Transaction</code> will be available in terms of a <code>MonadWriter</code>.</p>
<div class="annotated-code">
<p><span><em>«daemon-transaction»+</em></span></p>
<div class="sourceCode" id="daemon-transaction"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-transaction-1"><a href="#daemon-transaction-1"></a><span class="ot">runTransaction ::</span> <span class="dt">Transaction</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="daemon-transaction-2"><a href="#daemon-transaction-2"></a>runTransaction (<span class="dt">Transaction</span> <span class="dt">Nothing</span> d _) <span class="ot">=</span> Console.putTerminal d</span>
<span id="daemon-transaction-3"><a href="#daemon-transaction-3"></a>runTransaction (<span class="dt">Transaction</span> (<span class="dt">Just</span> x) d c) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-transaction-4"><a href="#daemon-transaction-4"></a>    Console.putTerminal d</span>
<span id="daemon-transaction-5"><a href="#daemon-transaction-5"></a>    <span class="kw">if</span> c <span class="kw">then</span> <span class="kw">do</span></span>
<span id="daemon-transaction-6"><a href="#daemon-transaction-6"></a>        T.IO.putStr <span class="st">&quot;confirm? (y/n) &quot;</span></span>
<span id="daemon-transaction-7"><a href="#daemon-transaction-7"></a>        hFlush stdout</span>
<span id="daemon-transaction-8"><a href="#daemon-transaction-8"></a>        reply <span class="ot">&lt;-</span> <span class="fu">getLine</span></span>
<span id="daemon-transaction-9"><a href="#daemon-transaction-9"></a>        T.IO.putStrLn <span class="st">&quot;&quot;</span></span>
<span id="daemon-transaction-10"><a href="#daemon-transaction-10"></a>        when (reply <span class="op">==</span> <span class="st">&quot;y&quot;</span>) x</span>
<span id="daemon-transaction-11"><a href="#daemon-transaction-11"></a>    <span class="kw">else</span> x</span></code></pre></div>
</div>
<h3 id="session">Session</h3>
<div class="annotated-code">
<p><span><em>«daemon-imports»+</em></span></p>
<div class="sourceCode" id="daemon-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-imports-1"><a href="#daemon-imports-1"></a><span class="kw">import</span> <span class="dt">Database.SQLite.Simple</span></span>
<span id="daemon-imports-2"><a href="#daemon-imports-2"></a></span>
<span id="daemon-imports-3"><a href="#daemon-imports-3"></a><span class="kw">import</span> <span class="dt">Document</span></span>
<span id="daemon-imports-4"><a href="#daemon-imports-4"></a><span class="kw">import</span> <span class="dt">Config</span></span>
<span id="daemon-imports-5"><a href="#daemon-imports-5"></a><span class="kw">import</span> <span class="dt">Database</span></span>
<span id="daemon-imports-6"><a href="#daemon-imports-6"></a><span class="kw">import</span> <span class="dt">Logging</span></span>
<span id="daemon-imports-7"><a href="#daemon-imports-7"></a><span class="kw">import</span> <span class="dt">Tangle</span> (parseMarkdown, expandedCode)</span>
<span id="daemon-imports-8"><a href="#daemon-imports-8"></a><span class="kw">import</span> <span class="dt">Comment</span></span>
<span id="daemon-imports-9"><a href="#daemon-imports-9"></a><span class="kw">import</span> <span class="dt">Stitch</span> (stitch)</span>
<span id="daemon-imports-10"><a href="#daemon-imports-10"></a></span>
<span id="daemon-imports-11"><a href="#daemon-imports-11"></a><span class="kw">import</span> <span class="dt">Control.Concurrent.Chan</span></span>
<span id="daemon-imports-12"><a href="#daemon-imports-12"></a><span class="kw">import</span> <span class="dt">Control.Concurrent</span></span>
<span id="daemon-imports-13"><a href="#daemon-imports-13"></a><span class="kw">import</span> <span class="dt">Control.Monad.State</span></span>
<span id="daemon-imports-14"><a href="#daemon-imports-14"></a><span class="kw">import</span> <span class="dt">Control.Monad.Reader</span></span>
<span id="daemon-imports-15"><a href="#daemon-imports-15"></a><span class="kw">import</span> <span class="dt">Control.Monad.RWS</span></span>
<span id="daemon-imports-16"><a href="#daemon-imports-16"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span></span>
<span id="daemon-imports-17"><a href="#daemon-imports-17"></a><span class="kw">import</span> <span class="dt">Control.Monad.Writer</span></span>
<span id="daemon-imports-18"><a href="#daemon-imports-18"></a><span class="kw">import</span> <span class="dt">Control.Monad.Catch</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«daemon-session»=</em></span></p>
<div class="sourceCode" id="daemon-session"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-session-1"><a href="#daemon-session-1"></a><span class="kw">data</span> <span class="dt">Session</span> <span class="ot">=</span> <span class="dt">Session</span></span>
<span id="daemon-session-2"><a href="#daemon-session-2"></a>    {<span class="ot"> watches       ::</span> [<span class="dt">FSNotify.StopListening</span>]</span>
<span id="daemon-session-3"><a href="#daemon-session-3"></a>    ,<span class="ot"> manager       ::</span> <span class="dt">FSNotify.WatchManager</span></span>
<span id="daemon-session-4"><a href="#daemon-session-4"></a>    ,<span class="ot"> eventChannel  ::</span> <span class="dt">Chan</span> <span class="dt">Event</span></span>
<span id="daemon-session-5"><a href="#daemon-session-5"></a>    ,<span class="ot"> daemonState   ::</span> <span class="dt">MVar</span> <span class="dt">DaemonState</span></span>
<span id="daemon-session-6"><a href="#daemon-session-6"></a>    ,<span class="ot"> sqlite        ::</span> <span class="dt">Connection</span></span>
<span id="daemon-session-7"><a href="#daemon-session-7"></a>    }</span>
<span id="daemon-session-8"><a href="#daemon-session-8"></a></span>
<span id="daemon-session-9"><a href="#daemon-session-9"></a><span class="ot">db ::</span> ( <span class="dt">MonadIO</span> m, <span class="dt">MonadState</span> <span class="dt">Session</span> m, <span class="dt">MonadLogger</span> m )</span>
<span id="daemon-session-10"><a href="#daemon-session-10"></a>   <span class="ot">=&gt;</span> <span class="dt">SQL</span> a <span class="ot">-&gt;</span> m a</span>
<span id="daemon-session-11"><a href="#daemon-session-11"></a>db x <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-session-12"><a href="#daemon-session-12"></a>    conn <span class="ot">&lt;-</span> gets sqlite</span>
<span id="daemon-session-13"><a href="#daemon-session-13"></a>    runSQL conn x</span>
<span id="daemon-session-14"><a href="#daemon-session-14"></a></span>
<span id="daemon-session-15"><a href="#daemon-session-15"></a><span class="kw">newtype</span> <span class="dt">Daemon</span> a <span class="ot">=</span> <span class="dt">Daemon</span> {<span class="ot"> unDaemon ::</span> <span class="dt">RWST</span> <span class="dt">Config</span> <span class="dt">Transaction</span> <span class="dt">Session</span> <span class="dt">IO</span> a }</span>
<span id="daemon-session-16"><a href="#daemon-session-16"></a>    <span class="kw">deriving</span> ( <span class="dt">Applicative</span>, <span class="dt">Functor</span>, <span class="dt">Monad</span>, <span class="dt">MonadIO</span>, <span class="dt">MonadState</span> <span class="dt">Session</span></span>
<span id="daemon-session-17"><a href="#daemon-session-17"></a>             , <span class="dt">MonadReader</span> <span class="dt">Config</span>, <span class="dt">MonadWriter</span> <span class="dt">Transaction</span>, <span class="dt">MonadThrow</span> )</span>
<span id="daemon-session-18"><a href="#daemon-session-18"></a></span>
<span id="daemon-session-19"><a href="#daemon-session-19"></a><span class="kw">instance</span> <span class="dt">MonadLogger</span> <span class="dt">Daemon</span> <span class="kw">where</span></span>
<span id="daemon-session-20"><a href="#daemon-session-20"></a>    logEntry level x <span class="ot">=</span> tell (msg level x)</span></code></pre></div>
</div>
<p>Every time an event happens we send it to <code>_eventChannel</code>. When we tangle we change the <code>_daemonState</code> to <code>Tangling</code>. Write events to target files are then not triggering a stitch. The other way around, if the daemon is in <code>Stitching</code> state, write events to the markdown source do not trigger a tangle. Because these events will arrive asynchronously, we use an <code>MVar</code> to change the state.</p>
<p>Setting the state is a bit involved (a bit more than with an <code>IORef</code>), but it guarantees safe use in a multi-threaded environment. An <code>MVar</code> can only be set if it is first emptied, the combined action can be done with <code>modifyMVar_</code>.</p>
<div class="annotated-code">
<p><span><em>«daemon-session»+</em></span></p>
<div class="sourceCode" id="daemon-session"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-session-1"><a href="#daemon-session-1"></a><span class="ot">setDaemonState ::</span> ( <span class="dt">MonadIO</span> m</span>
<span id="daemon-session-2"><a href="#daemon-session-2"></a>                  , <span class="dt">MonadState</span> <span class="dt">Session</span> m )</span>
<span id="daemon-session-3"><a href="#daemon-session-3"></a>               <span class="ot">=&gt;</span> <span class="dt">DaemonState</span> <span class="ot">-&gt;</span> m ()</span>
<span id="daemon-session-4"><a href="#daemon-session-4"></a>setDaemonState s <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-session-5"><a href="#daemon-session-5"></a>    state <span class="ot">&lt;-</span> gets daemonState</span>
<span id="daemon-session-6"><a href="#daemon-session-6"></a>    liftIO <span class="op">$</span> modifyMVar_ state (<span class="fu">const</span> <span class="op">$</span> <span class="fu">return</span> s)</span></code></pre></div>
</div>
<h3 id="file-io">File IO</h3>
<div class="annotated-code">
<p><span><em>«daemon-imports»+</em></span></p>
<div class="sourceCode" id="daemon-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-imports-1"><a href="#daemon-imports-1"></a><span class="kw">import</span> <span class="dt">System.FilePath</span> (takeDirectory, equalFilePath)</span>
<span id="daemon-imports-2"><a href="#daemon-imports-2"></a><span class="kw">import</span> <span class="dt">System.Directory</span> </span>
<span id="daemon-imports-3"><a href="#daemon-imports-3"></a>    ( canonicalizePath</span>
<span id="daemon-imports-4"><a href="#daemon-imports-4"></a>    , doesFileExist</span>
<span id="daemon-imports-5"><a href="#daemon-imports-5"></a>    , removeFile</span>
<span id="daemon-imports-6"><a href="#daemon-imports-6"></a>    , createDirectoryIfMissing</span>
<span id="daemon-imports-7"><a href="#daemon-imports-7"></a>    , makeRelativeToCurrentDirectory )</span></code></pre></div>
</div>
<p>There is a limited set of IO file system actions that result from a tangle or stitch. We define a little language using a type class.</p>
<div class="annotated-code">
<p><span><em>«daemon-user-io»=</em></span></p>
<div class="sourceCode" id="daemon-user-io"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-user-io-1"><a href="#daemon-user-io-1"></a><span class="kw">class</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">MonadFileIO</span> m <span class="kw">where</span></span>
<span id="daemon-user-io-2"><a href="#daemon-user-io-2"></a><span class="ot">    writeFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> m ()</span>
<span id="daemon-user-io-3"><a href="#daemon-user-io-3"></a><span class="ot">    deleteFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> m ()</span>
<span id="daemon-user-io-4"><a href="#daemon-user-io-4"></a><span class="ot">    readFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> m <span class="dt">Text</span></span>
<span id="daemon-user-io-5"><a href="#daemon-user-io-5"></a></span>
<span id="daemon-user-io-6"><a href="#daemon-user-io-6"></a><span class="ot">tryReadFile ::</span> <span class="dt">MonadIO</span> m <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> m (<span class="dt">Maybe</span> <span class="dt">Text</span>)</span>
<span id="daemon-user-io-7"><a href="#daemon-user-io-7"></a>tryReadFile f <span class="ot">=</span> liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="daemon-user-io-8"><a href="#daemon-user-io-8"></a>    exists <span class="ot">&lt;-</span> doesFileExist f</span>
<span id="daemon-user-io-9"><a href="#daemon-user-io-9"></a>    <span class="kw">if</span> exists</span>
<span id="daemon-user-io-10"><a href="#daemon-user-io-10"></a>        <span class="kw">then</span> <span class="dt">Just</span> <span class="op">&lt;$&gt;</span> T.IO.readFile f</span>
<span id="daemon-user-io-11"><a href="#daemon-user-io-11"></a>        <span class="kw">else</span> <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="daemon-user-io-12"><a href="#daemon-user-io-12"></a></span>
<span id="daemon-user-io-13"><a href="#daemon-user-io-13"></a><span class="ot">changeFile ::</span> (<span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> m <span class="dt">Transaction</span></span>
<span id="daemon-user-io-14"><a href="#daemon-user-io-14"></a>changeFile filename text <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-user-io-15"><a href="#daemon-user-io-15"></a>    rel_path <span class="ot">&lt;-</span> liftIO <span class="op">$</span> makeRelativeToCurrentDirectory filename</span>
<span id="daemon-user-io-16"><a href="#daemon-user-io-16"></a>    liftIO <span class="op">$</span> createDirectoryIfMissing <span class="dt">True</span> (takeDirectory filename)</span>
<span id="daemon-user-io-17"><a href="#daemon-user-io-17"></a>    oldText <span class="ot">&lt;-</span> tryReadFile filename</span>
<span id="daemon-user-io-18"><a href="#daemon-user-io-18"></a>    <span class="kw">case</span> oldText <span class="kw">of</span></span>
<span id="daemon-user-io-19"><a href="#daemon-user-io-19"></a>        <span class="dt">Just</span> ot <span class="ot">-&gt;</span> <span class="kw">if</span> ot <span class="op">/=</span> text</span>
<span id="daemon-user-io-20"><a href="#daemon-user-io-20"></a>            <span class="kw">then</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Transaction</span> (<span class="dt">Just</span> <span class="op">$</span> T.IO.writeFile filename text)</span>
<span id="daemon-user-io-21"><a href="#daemon-user-io-21"></a>                                   (Console.msgOverwrite rel_path) <span class="dt">False</span></span>
<span id="daemon-user-io-22"><a href="#daemon-user-io-22"></a>            <span class="kw">else</span> <span class="fu">return</span> <span class="fu">mempty</span></span>
<span id="daemon-user-io-23"><a href="#daemon-user-io-23"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Transaction</span> (<span class="dt">Just</span> <span class="op">$</span> T.IO.writeFile filename text)</span>
<span id="daemon-user-io-24"><a href="#daemon-user-io-24"></a>                                     (Console.msgCreate rel_path) <span class="dt">False</span></span>
<span id="daemon-user-io-25"><a href="#daemon-user-io-25"></a></span>
<span id="daemon-user-io-26"><a href="#daemon-user-io-26"></a><span class="ot">removeIfExists ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Transaction</span></span>
<span id="daemon-user-io-27"><a href="#daemon-user-io-27"></a>removeIfExists f <span class="ot">=</span></span>
<span id="daemon-user-io-28"><a href="#daemon-user-io-28"></a>    plan (<span class="kw">do</span></span>
<span id="daemon-user-io-29"><a href="#daemon-user-io-29"></a>        fileExists <span class="ot">&lt;-</span> doesFileExist f</span>
<span id="daemon-user-io-30"><a href="#daemon-user-io-30"></a>        when fileExists <span class="op">$</span> removeFile f)</span>
<span id="daemon-user-io-31"><a href="#daemon-user-io-31"></a>    <span class="op">&lt;&gt;</span> doc (Console.msgDelete f)</span>
<span id="daemon-user-io-32"><a href="#daemon-user-io-32"></a></span>
<span id="daemon-user-io-33"><a href="#daemon-user-io-33"></a><span class="kw">instance</span> <span class="dt">MonadFileIO</span> <span class="dt">Daemon</span> <span class="kw">where</span></span>
<span id="daemon-user-io-34"><a href="#daemon-user-io-34"></a>    <span class="fu">writeFile</span> path text <span class="ot">=</span> tell <span class="op">=&lt;&lt;</span> changeFile path text</span>
<span id="daemon-user-io-35"><a href="#daemon-user-io-35"></a>    <span class="fu">readFile</span> path <span class="ot">=</span> liftIO <span class="op">$</span> T.IO.readFile path</span>
<span id="daemon-user-io-36"><a href="#daemon-user-io-36"></a>    deleteFile path <span class="ot">=</span> tell <span class="op">$</span> removeIfExists path</span></code></pre></div>
</div>
<p>These are IO actions that need logging, possible confirmation by the user and execution. Also, using this we can do some mock testing.</p>
<h2 id="watching">Watching</h2>
<div class="annotated-code">
<p><span><em>«daemon-imports»+</em></span></p>
<div class="sourceCode" id="daemon-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-imports-1"><a href="#daemon-imports-1"></a><span class="kw">import</span> <span class="dt">Data.List</span> (nub, (\\))</span>
<span id="daemon-imports-2"><a href="#daemon-imports-2"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (mapM)</span></code></pre></div>
</div>
<p>The <code>passEvent</code> function acts as the call-back for the FSNotify watcher. There are two strategies in which editors save files:</p>
<pre><code>* remove and create: Vim (by default), gedit and many more editors do this. Actually, the content is written to a temporary file, which is then renamed to the existing file. These operations are atomic so that no data is lost if the system crashes.
* modify: VS Code does this.</code></pre>
<p>We have to be flexible in how we interpret the incomming events. The most important bit is that we need to ignore the <code>delete</code> events.</p>
<p><code>FSNotify</code> lets us watch directories containing the files we’re interested in. In <code>passEvent</code> we need to check if the event is actually on an involved file.</p>
<div class="annotated-code">
<p><span><em>«daemon-watches»=</em></span></p>
<div class="sourceCode" id="daemon-watches"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-watches-1"><a href="#daemon-watches-1"></a><span class="ot">passEvent ::</span> <span class="dt">MVar</span> <span class="dt">DaemonState</span> <span class="ot">-&gt;</span> <span class="dt">Chan</span> <span class="dt">Event</span></span>
<span id="daemon-watches-2"><a href="#daemon-watches-2"></a>          <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">FSNotify.Event</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="daemon-watches-3"><a href="#daemon-watches-3"></a>passEvent _      _       _    _    <span class="dt">FSNotify.Removed</span> {} <span class="ot">=</span> <span class="fu">return</span> ()</span>
<span id="daemon-watches-4"><a href="#daemon-watches-4"></a>passEvent state&#39; channel srcs tgts fsEvent <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-watches-5"><a href="#daemon-watches-5"></a>    <span class="fu">putStrLn</span> <span class="op">$</span> <span class="fu">show</span> fsEvent</span>
<span id="daemon-watches-6"><a href="#daemon-watches-6"></a>    abs_path <span class="ot">&lt;-</span> canonicalizePath <span class="op">$</span> FSNotify.eventPath fsEvent</span>
<span id="daemon-watches-7"><a href="#daemon-watches-7"></a>    state    <span class="ot">&lt;-</span> readMVar state&#39;</span>
<span id="daemon-watches-8"><a href="#daemon-watches-8"></a></span>
<span id="daemon-watches-9"><a href="#daemon-watches-9"></a>    <span class="kw">let</span> isSourceFile <span class="ot">=</span> <span class="fu">any</span> (equalFilePath abs_path) srcs</span>
<span id="daemon-watches-10"><a href="#daemon-watches-10"></a>        isTargetFile <span class="ot">=</span> <span class="fu">any</span> (equalFilePath abs_path) tgts</span>
<span id="daemon-watches-11"><a href="#daemon-watches-11"></a>        pass         <span class="ot">=</span> <span class="kw">case</span> state <span class="kw">of</span></span>
<span id="daemon-watches-12"><a href="#daemon-watches-12"></a>                         <span class="dt">Idle</span>      <span class="ot">-&gt;</span> isSourceFile <span class="op">||</span> isTargetFile</span>
<span id="daemon-watches-13"><a href="#daemon-watches-13"></a>                         <span class="dt">Tangling</span>  <span class="ot">-&gt;</span> isSourceFile</span>
<span id="daemon-watches-14"><a href="#daemon-watches-14"></a>                         <span class="dt">Stitching</span> <span class="ot">-&gt;</span> isTargetFile</span>
<span id="daemon-watches-15"><a href="#daemon-watches-15"></a></span>
<span id="daemon-watches-16"><a href="#daemon-watches-16"></a>    when pass <span class="op">$</span> <span class="kw">do</span></span>
<span id="daemon-watches-17"><a href="#daemon-watches-17"></a>        <span class="kw">let</span> etype <span class="ot">=</span> <span class="kw">if</span> isSourceFile <span class="kw">then</span> <span class="dt">WriteSource</span> <span class="kw">else</span> <span class="dt">WriteTarget</span></span>
<span id="daemon-watches-18"><a href="#daemon-watches-18"></a>        writeChan channel (etype abs_path)</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«daemon-watches»+</em></span></p>
<div class="sourceCode" id="daemon-watches"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-watches-1"><a href="#daemon-watches-1"></a><span class="ot">setWatch ::</span> <span class="dt">Daemon</span> ()</span>
<span id="daemon-watches-2"><a href="#daemon-watches-2"></a>setWatch <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-watches-3"><a href="#daemon-watches-3"></a>    srcs <span class="ot">&lt;-</span> db listSourceFiles <span class="op">&gt;&gt;=</span> (liftIO <span class="op">.</span> <span class="fu">mapM</span> canonicalizePath)</span>
<span id="daemon-watches-4"><a href="#daemon-watches-4"></a>    tgts <span class="ot">&lt;-</span> db listTargetFiles <span class="op">&gt;&gt;=</span> (liftIO <span class="op">.</span> <span class="fu">mapM</span> canonicalizePath)</span>
<span id="daemon-watches-5"><a href="#daemon-watches-5"></a>    fsnotify <span class="ot">&lt;-</span> gets manager</span>
<span id="daemon-watches-6"><a href="#daemon-watches-6"></a>    channel  <span class="ot">&lt;-</span> gets eventChannel</span>
<span id="daemon-watches-7"><a href="#daemon-watches-7"></a></span>
<span id="daemon-watches-8"><a href="#daemon-watches-8"></a>    <span class="kw">let</span> abs_dirs <span class="ot">=</span> nub <span class="op">$</span> <span class="fu">map</span> takeDirectory (srcs <span class="op">&lt;&gt;</span> tgts)</span>
<span id="daemon-watches-9"><a href="#daemon-watches-9"></a>    rel_dirs <span class="ot">&lt;-</span> liftIO <span class="op">$</span> <span class="fu">mapM</span> makeRelativeToCurrentDirectory abs_dirs</span>
<span id="daemon-watches-10"><a href="#daemon-watches-10"></a></span>
<span id="daemon-watches-11"><a href="#daemon-watches-11"></a>    state <span class="ot">&lt;-</span> gets daemonState</span>
<span id="daemon-watches-12"><a href="#daemon-watches-12"></a>    stopActions <span class="ot">&lt;-</span> liftIO <span class="op">$</span> <span class="fu">mapM</span></span>
<span id="daemon-watches-13"><a href="#daemon-watches-13"></a>        (\dir <span class="ot">-&gt;</span> FSNotify.watchDir fsnotify dir (<span class="fu">const</span> <span class="dt">True</span>)</span>
<span id="daemon-watches-14"><a href="#daemon-watches-14"></a>                                   (passEvent state channel srcs tgts))</span>
<span id="daemon-watches-15"><a href="#daemon-watches-15"></a>        abs_dirs</span>
<span id="daemon-watches-16"><a href="#daemon-watches-16"></a>    modify (\s <span class="ot">-&gt;</span> s{ watches<span class="ot">=</span>stopActions })</span>
<span id="daemon-watches-17"><a href="#daemon-watches-17"></a></span>
<span id="daemon-watches-18"><a href="#daemon-watches-18"></a>    logMessage <span class="op">$</span> <span class="st">&quot;watching: &quot;</span> <span class="op">&lt;&gt;</span> tshow rel_dirs</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«daemon-watches»+</em></span></p>
<div class="sourceCode" id="daemon-watches"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-watches-1"><a href="#daemon-watches-1"></a><span class="ot">closeWatch ::</span> <span class="dt">Daemon</span> ()</span>
<span id="daemon-watches-2"><a href="#daemon-watches-2"></a>closeWatch <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-watches-3"><a href="#daemon-watches-3"></a>    stopActions <span class="ot">&lt;-</span> gets watches</span>
<span id="daemon-watches-4"><a href="#daemon-watches-4"></a>    liftIO <span class="op">$</span> <span class="fu">sequence_</span> stopActions</span>
<span id="daemon-watches-5"><a href="#daemon-watches-5"></a>    logMessage <span class="st">&quot;suspended watches&quot;</span></span></code></pre></div>
</div>
<h2 id="loading">Loading</h2>
<div class="annotated-code">
<p><span><em>«daemon-loading»=</em></span></p>
<div class="sourceCode" id="daemon-loading"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-loading-1"><a href="#daemon-loading-1"></a><span class="ot">loadSourceFile ::</span> ( <span class="dt">MonadFileIO</span> m, <span class="dt">MonadLogger</span> m</span>
<span id="daemon-loading-2"><a href="#daemon-loading-2"></a>                  , <span class="dt">MonadReader</span> <span class="dt">Config</span> m</span>
<span id="daemon-loading-3"><a href="#daemon-loading-3"></a>                  , <span class="dt">MonadState</span> <span class="dt">Session</span> m</span>
<span id="daemon-loading-4"><a href="#daemon-loading-4"></a>                  , <span class="dt">MonadIO</span> m )</span>
<span id="daemon-loading-5"><a href="#daemon-loading-5"></a>               <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> m ()</span>
<span id="daemon-loading-6"><a href="#daemon-loading-6"></a>loadSourceFile abs_path <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-loading-7"><a href="#daemon-loading-7"></a>    rel_path <span class="ot">&lt;-</span> liftIO <span class="op">$</span> makeRelativeToCurrentDirectory abs_path</span>
<span id="daemon-loading-8"><a href="#daemon-loading-8"></a>    doc&#39;     <span class="ot">&lt;-</span> <span class="fu">readFile</span> abs_path <span class="op">&gt;&gt;=</span> parseMarkdown rel_path</span>
<span id="daemon-loading-9"><a href="#daemon-loading-9"></a>    <span class="kw">case</span> doc&#39; <span class="kw">of</span></span>
<span id="daemon-loading-10"><a href="#daemon-loading-10"></a>        <span class="dt">Left</span> err <span class="ot">-&gt;</span></span>
<span id="daemon-loading-11"><a href="#daemon-loading-11"></a>            logError <span class="op">$</span> <span class="st">&quot;Error loading &#39;&quot;</span> <span class="op">&lt;&gt;</span> T.pack rel_path <span class="op">&lt;&gt;</span> <span class="st">&quot;&#39;: &quot;</span> <span class="op">&lt;&gt;</span> tshow err</span>
<span id="daemon-loading-12"><a href="#daemon-loading-12"></a>        <span class="dt">Right</span> doc <span class="ot">-&gt;</span></span>
<span id="daemon-loading-13"><a href="#daemon-loading-13"></a>            db <span class="op">$</span> insertDocument rel_path doc</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«daemon-loading»+</em></span></p>
<div class="sourceCode" id="daemon-loading"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-loading-1"><a href="#daemon-loading-1"></a><span class="ot">loadTargetFile ::</span> ( <span class="dt">MonadFileIO</span> m, <span class="dt">MonadLogger</span> m</span>
<span id="daemon-loading-2"><a href="#daemon-loading-2"></a>                  , <span class="dt">MonadReader</span> <span class="dt">Config</span> m</span>
<span id="daemon-loading-3"><a href="#daemon-loading-3"></a>                  , <span class="dt">MonadState</span> <span class="dt">Session</span> m</span>
<span id="daemon-loading-4"><a href="#daemon-loading-4"></a>                  , <span class="dt">MonadIO</span> m )</span>
<span id="daemon-loading-5"><a href="#daemon-loading-5"></a>               <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> m ()</span>
<span id="daemon-loading-6"><a href="#daemon-loading-6"></a>loadTargetFile abs_path <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-loading-7"><a href="#daemon-loading-7"></a>    rel_path <span class="ot">&lt;-</span> liftIO <span class="op">$</span> makeRelativeToCurrentDirectory abs_path</span>
<span id="daemon-loading-8"><a href="#daemon-loading-8"></a>    refs&#39; <span class="ot">&lt;-</span> <span class="fu">readFile</span> abs_path <span class="op">&gt;&gt;=</span> stitch rel_path</span>
<span id="daemon-loading-9"><a href="#daemon-loading-9"></a>    <span class="kw">case</span> refs&#39; <span class="kw">of</span></span>
<span id="daemon-loading-10"><a href="#daemon-loading-10"></a>        <span class="dt">Left</span> err <span class="ot">-&gt;</span></span>
<span id="daemon-loading-11"><a href="#daemon-loading-11"></a>            logError <span class="op">$</span> <span class="st">&quot;Error loading &#39;&quot;</span> <span class="op">&lt;&gt;</span> T.pack rel_path <span class="op">&lt;&gt;</span> <span class="st">&quot;&#39;:&quot;</span> <span class="op">&lt;&gt;</span> tshow err</span>
<span id="daemon-loading-12"><a href="#daemon-loading-12"></a>        <span class="dt">Right</span> refs <span class="ot">-&gt;</span></span>
<span id="daemon-loading-13"><a href="#daemon-loading-13"></a>            db <span class="op">$</span> updateTarget refs</span></code></pre></div>
</div>
<h2 id="writing">Writing</h2>
<div class="annotated-code">
<p><span><em>«daemon-imports»+</em></span></p>
<div class="sourceCode" id="daemon-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-imports-1"><a href="#daemon-imports-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Lazy</span> <span class="kw">as</span> <span class="dt">LM</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«daemon-writing»=</em></span></p>
<div class="sourceCode" id="daemon-writing"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-writing-1"><a href="#daemon-writing-1"></a><span class="ot">codeLanguage&#39; ::</span> (<span class="dt">MonadThrow</span> m) <span class="ot">=&gt;</span> <span class="dt">ReferenceMap</span> <span class="ot">-&gt;</span> <span class="dt">ReferenceName</span> <span class="ot">-&gt;</span> m <span class="dt">Language</span></span>
<span id="daemon-writing-2"><a href="#daemon-writing-2"></a>codeLanguage&#39; refs rname <span class="ot">=</span> <span class="kw">case</span> (codeLanguage <span class="op">$</span> refs <span class="op">M.!</span> (<span class="dt">ReferenceId</span> rname <span class="dv">0</span>)) <span class="kw">of</span></span>
<span id="daemon-writing-3"><a href="#daemon-writing-3"></a>    <span class="dt">KnownLanguage</span> lang <span class="ot">-&gt;</span> <span class="fu">return</span> lang</span>
<span id="daemon-writing-4"><a href="#daemon-writing-4"></a>    _                  <span class="ot">-&gt;</span> throwM <span class="op">$</span> <span class="dt">DatabaseError</span> <span class="op">$</span> <span class="st">&quot;Trying to tangle &quot;</span> <span class="op">&lt;&gt;</span> tshow rname <span class="op">&lt;&gt;</span> <span class="st">&quot; with no known language.&quot;</span></span>
<span id="daemon-writing-5"><a href="#daemon-writing-5"></a></span>
<span id="daemon-writing-6"><a href="#daemon-writing-6"></a><span class="ot">writeTargetFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Daemon</span> ()</span>
<span id="daemon-writing-7"><a href="#daemon-writing-7"></a>writeTargetFile rel_path <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-writing-8"><a href="#daemon-writing-8"></a>    cfg <span class="ot">&lt;-</span> ask</span>
<span id="daemon-writing-9"><a href="#daemon-writing-9"></a>    refs <span class="ot">&lt;-</span> db <span class="op">$</span> queryReferenceMap cfg</span>
<span id="daemon-writing-10"><a href="#daemon-writing-10"></a>    <span class="kw">let</span> codes <span class="ot">=</span> expandedCode annotateComment refs</span>
<span id="daemon-writing-11"><a href="#daemon-writing-11"></a>        tangleRef tgt lang <span class="ot">=</span> <span class="kw">case</span> codes <span class="op">LM.!?</span> tgt <span class="kw">of</span></span>
<span id="daemon-writing-12"><a href="#daemon-writing-12"></a>            <span class="dt">Nothing</span>        <span class="ot">-&gt;</span> logError <span class="op">$</span> <span class="st">&quot;Reference `&quot;</span> <span class="op">&lt;&gt;</span> tshow tgt <span class="op">&lt;&gt;</span> <span class="st">&quot;` not found.&quot;</span></span>
<span id="daemon-writing-13"><a href="#daemon-writing-13"></a>            <span class="dt">Just</span> (<span class="dt">Left</span> e)  <span class="ot">-&gt;</span> logError <span class="op">$</span> tshow e</span>
<span id="daemon-writing-14"><a href="#daemon-writing-14"></a>            <span class="dt">Just</span> (<span class="dt">Right</span> t) <span class="ot">-&gt;</span> <span class="fu">writeFile</span> rel_path <span class="op">$</span> unlines&#39; [headerComment lang rel_path, t]</span>
<span id="daemon-writing-15"><a href="#daemon-writing-15"></a></span>
<span id="daemon-writing-16"><a href="#daemon-writing-16"></a>    tgt&#39; <span class="ot">&lt;-</span> db <span class="op">$</span> queryTargetRef rel_path</span>
<span id="daemon-writing-17"><a href="#daemon-writing-17"></a>    <span class="kw">case</span> tgt&#39; <span class="kw">of</span></span>
<span id="daemon-writing-18"><a href="#daemon-writing-18"></a>        <span class="dt">Nothing</span>  <span class="ot">-&gt;</span> logError <span class="op">$</span> <span class="st">&quot;Target `&quot;</span> <span class="op">&lt;&gt;</span> T.pack rel_path <span class="op">&lt;&gt;</span> <span class="st">&quot;` not found.&quot;</span></span>
<span id="daemon-writing-19"><a href="#daemon-writing-19"></a>        <span class="dt">Just</span> tgt <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="daemon-writing-20"><a href="#daemon-writing-20"></a>                lang <span class="ot">&lt;-</span> codeLanguage&#39; refs tgt</span>
<span id="daemon-writing-21"><a href="#daemon-writing-21"></a>                tangleRef tgt lang</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«daemon-writing»+</em></span></p>
<div class="sourceCode" id="daemon-writing"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-writing-1"><a href="#daemon-writing-1"></a><span class="ot">writeSourceFile ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Daemon</span> ()</span>
<span id="daemon-writing-2"><a href="#daemon-writing-2"></a>writeSourceFile rel_path <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-writing-3"><a href="#daemon-writing-3"></a>    content <span class="ot">&lt;-</span> db <span class="op">$</span> stitchDocument rel_path</span>
<span id="daemon-writing-4"><a href="#daemon-writing-4"></a>    <span class="fu">writeFile</span> rel_path content</span></code></pre></div>
</div>
<h2 id="main-loop">Main loop</h2>
<div class="annotated-code">
<p><span><em>«daemon-imports»+</em></span></p>
<div class="sourceCode" id="daemon-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-imports-1"><a href="#daemon-imports-1"></a><span class="kw">import</span> <span class="dt">System.IO</span> (stdout, hFlush, hSetBuffering, <span class="dt">BufferMode</span>(..))</span></code></pre></div>
</div>
<p>The <code>mainLoop</code> is fed events and handles them.</p>
<div class="annotated-code">
<p><span><em>«daemon-main-loop»=</em></span></p>
<div class="sourceCode" id="daemon-main-loop"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-main-loop-1"><a href="#daemon-main-loop-1"></a><span class="ot">wait ::</span> <span class="dt">Daemon</span> ()</span>
<span id="daemon-main-loop-2"><a href="#daemon-main-loop-2"></a>wait <span class="ot">=</span> liftIO <span class="op">$</span> threadDelay <span class="dv">100000</span></span>
<span id="daemon-main-loop-3"><a href="#daemon-main-loop-3"></a></span>
<span id="daemon-main-loop-4"><a href="#daemon-main-loop-4"></a><span class="ot">mainLoop ::</span> <span class="dt">Event</span> <span class="ot">-&gt;</span> <span class="dt">Daemon</span> ()</span>
<span id="daemon-main-loop-5"><a href="#daemon-main-loop-5"></a><span class="op">&lt;&lt;</span>main<span class="op">-</span>loop<span class="op">-</span>cases<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>After the first event we need to wait a bit, there may be more comming.</p>
<div class="annotated-code">
<p><span><em>«main-loop-cases»=</em></span></p>
<div class="sourceCode" id="main-loop-cases"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="main-loop-cases-1"><a href="#main-loop-cases-1"></a>mainLoop (<span class="dt">WriteSource</span> abs_path) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="main-loop-cases-2"><a href="#main-loop-cases-2"></a>    rel_path <span class="ot">&lt;-</span> liftIO <span class="op">$</span> makeRelativeToCurrentDirectory abs_path</span>
<span id="main-loop-cases-3"><a href="#main-loop-cases-3"></a></span>
<span id="main-loop-cases-4"><a href="#main-loop-cases-4"></a>    wait</span>
<span id="main-loop-cases-5"><a href="#main-loop-cases-5"></a>    setDaemonState <span class="dt">Tangling</span></span>
<span id="main-loop-cases-6"><a href="#main-loop-cases-6"></a>    closeWatch</span>
<span id="main-loop-cases-7"><a href="#main-loop-cases-7"></a></span>
<span id="main-loop-cases-8"><a href="#main-loop-cases-8"></a>    old_tgts <span class="ot">&lt;-</span> db listTargetFiles</span>
<span id="main-loop-cases-9"><a href="#main-loop-cases-9"></a>    loadSourceFile abs_path</span>
<span id="main-loop-cases-10"><a href="#main-loop-cases-10"></a>    new_tgts <span class="ot">&lt;-</span> db listTargetFiles</span>
<span id="main-loop-cases-11"><a href="#main-loop-cases-11"></a>    <span class="fu">mapM_</span> deleteFile <span class="op">$</span> old_tgts \\ new_tgts</span>
<span id="main-loop-cases-12"><a href="#main-loop-cases-12"></a>    <span class="fu">mapM_</span> writeTargetFile new_tgts</span>
<span id="main-loop-cases-13"><a href="#main-loop-cases-13"></a></span>
<span id="main-loop-cases-14"><a href="#main-loop-cases-14"></a>    wait</span>
<span id="main-loop-cases-15"><a href="#main-loop-cases-15"></a>    setWatch</span>
<span id="main-loop-cases-16"><a href="#main-loop-cases-16"></a>    setDaemonState <span class="dt">Idle</span></span>
<span id="main-loop-cases-17"><a href="#main-loop-cases-17"></a></span>
<span id="main-loop-cases-18"><a href="#main-loop-cases-18"></a>mainLoop (<span class="dt">WriteTarget</span> abs_path) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="main-loop-cases-19"><a href="#main-loop-cases-19"></a>    rel_path <span class="ot">&lt;-</span> liftIO <span class="op">$</span> makeRelativeToCurrentDirectory abs_path</span>
<span id="main-loop-cases-20"><a href="#main-loop-cases-20"></a>    wait</span>
<span id="main-loop-cases-21"><a href="#main-loop-cases-21"></a>    setDaemonState <span class="dt">Stitching</span></span>
<span id="main-loop-cases-22"><a href="#main-loop-cases-22"></a>    closeWatch</span>
<span id="main-loop-cases-23"><a href="#main-loop-cases-23"></a>    loadTargetFile abs_path</span>
<span id="main-loop-cases-24"><a href="#main-loop-cases-24"></a>    srcs <span class="ot">&lt;-</span> db listSourceFiles</span>
<span id="main-loop-cases-25"><a href="#main-loop-cases-25"></a>    <span class="fu">mapM_</span> writeSourceFile srcs</span>
<span id="main-loop-cases-26"><a href="#main-loop-cases-26"></a>    wait</span>
<span id="main-loop-cases-27"><a href="#main-loop-cases-27"></a>    <span class="co">-- setDaemonState Tangling</span></span>
<span id="main-loop-cases-28"><a href="#main-loop-cases-28"></a>    <span class="co">-- tgts &lt;- db listTargetFiles</span></span>
<span id="main-loop-cases-29"><a href="#main-loop-cases-29"></a>    <span class="co">-- mapM_ writeTargetFile tgts</span></span>
<span id="main-loop-cases-30"><a href="#main-loop-cases-30"></a>    <span class="co">-- wait</span></span>
<span id="main-loop-cases-31"><a href="#main-loop-cases-31"></a>    setWatch</span>
<span id="main-loop-cases-32"><a href="#main-loop-cases-32"></a>    setDaemonState <span class="dt">Idle</span></span>
<span id="main-loop-cases-33"><a href="#main-loop-cases-33"></a></span>
<span id="main-loop-cases-34"><a href="#main-loop-cases-34"></a>mainLoop _ <span class="ot">=</span> <span class="fu">return</span> () </span></code></pre></div>
</div>
<h2 id="initialisation">Initialisation</h2>
<div class="annotated-code">
<p><span><em>«daemon-start»=</em></span></p>
<div class="sourceCode" id="daemon-start"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="daemon-start-1"><a href="#daemon-start-1"></a><span class="ot">printMsg ::</span> <span class="dt">Doc</span> <span class="ot">-&gt;</span> <span class="dt">Daemon</span> ()</span>
<span id="daemon-start-2"><a href="#daemon-start-2"></a>printMsg <span class="ot">=</span> liftIO <span class="op">.</span> Console.putTerminal</span>
<span id="daemon-start-3"><a href="#daemon-start-3"></a></span>
<span id="daemon-start-4"><a href="#daemon-start-4"></a><span class="ot">initSession ::</span> <span class="dt">Daemon</span> ()</span>
<span id="daemon-start-5"><a href="#daemon-start-5"></a>initSession <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-start-6"><a href="#daemon-start-6"></a>    config <span class="ot">&lt;-</span> ask</span>
<span id="daemon-start-7"><a href="#daemon-start-7"></a>    abs_paths <span class="ot">&lt;-</span> liftIO <span class="op">$</span> getInputFiles config</span>
<span id="daemon-start-8"><a href="#daemon-start-8"></a>    when (<span class="fu">null</span> abs_paths) <span class="op">$</span> throwM <span class="op">$</span> <span class="dt">SystemError</span> <span class="st">&quot;No input files.&quot;</span></span>
<span id="daemon-start-9"><a href="#daemon-start-9"></a>    rel_paths <span class="ot">&lt;-</span> liftIO <span class="op">$</span> <span class="fu">mapM</span> makeRelativeToCurrentDirectory abs_paths</span>
<span id="daemon-start-10"><a href="#daemon-start-10"></a></span>
<span id="daemon-start-11"><a href="#daemon-start-11"></a>    db createTables</span>
<span id="daemon-start-12"><a href="#daemon-start-12"></a></span>
<span id="daemon-start-13"><a href="#daemon-start-13"></a>    printMsg Console.banner</span>
<span id="daemon-start-14"><a href="#daemon-start-14"></a>    tell <span class="op">$</span> doc</span>
<span id="daemon-start-15"><a href="#daemon-start-15"></a>         <span class="op">$</span> (P.align <span class="op">$</span> P.vsep</span>
<span id="daemon-start-16"><a href="#daemon-start-16"></a>                   <span class="op">$</span> <span class="fu">map</span> (Console.bullet</span>
<span id="daemon-start-17"><a href="#daemon-start-17"></a>                         <span class="op">.</span> (P.pretty (<span class="st">&quot;Monitoring &quot;</span><span class="ot"> ::</span> <span class="dt">Text</span>) <span class="op">&lt;&gt;</span>)</span>
<span id="daemon-start-18"><a href="#daemon-start-18"></a>                         <span class="op">.</span> Console.fileRead)</span>
<span id="daemon-start-19"><a href="#daemon-start-19"></a>                           rel_paths)</span>
<span id="daemon-start-20"><a href="#daemon-start-20"></a>            <span class="op">&lt;&gt;</span> P.line</span>
<span id="daemon-start-21"><a href="#daemon-start-21"></a></span>
<span id="daemon-start-22"><a href="#daemon-start-22"></a>    <span class="fu">mapM_</span> loadSourceFile abs_paths </span>
<span id="daemon-start-23"><a href="#daemon-start-23"></a>    tgts <span class="ot">&lt;-</span> db listTargetFiles</span>
<span id="daemon-start-24"><a href="#daemon-start-24"></a>    <span class="fu">mapM_</span> writeTargetFile tgts</span>
<span id="daemon-start-25"><a href="#daemon-start-25"></a>    setWatch</span>
<span id="daemon-start-26"><a href="#daemon-start-26"></a></span>
<span id="daemon-start-27"><a href="#daemon-start-27"></a><span class="ot">foldx ::</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> (e <span class="ot">-&gt;</span> s <span class="ot">-&gt;</span> m s) <span class="ot">-&gt;</span> [e] <span class="ot">-&gt;</span> s <span class="ot">-&gt;</span> m ()</span>
<span id="daemon-start-28"><a href="#daemon-start-28"></a>foldx _ [] _ <span class="ot">=</span> <span class="fu">return</span> ()</span>
<span id="daemon-start-29"><a href="#daemon-start-29"></a>foldx f (e<span class="op">:</span>es) s <span class="ot">=</span> (f e s) <span class="op">&gt;&gt;=</span> (foldx f es)</span>
<span id="daemon-start-30"><a href="#daemon-start-30"></a></span>
<span id="daemon-start-31"><a href="#daemon-start-31"></a><span class="ot">runSession ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="daemon-start-32"><a href="#daemon-start-32"></a>runSession config <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-start-33"><a href="#daemon-start-33"></a>    hSetBuffering stdout <span class="dt">LineBuffering</span></span>
<span id="daemon-start-34"><a href="#daemon-start-34"></a>    fsnotify <span class="ot">&lt;-</span> FSNotify.startManager</span>
<span id="daemon-start-35"><a href="#daemon-start-35"></a>    channel <span class="ot">&lt;-</span> newChan</span>
<span id="daemon-start-36"><a href="#daemon-start-36"></a>    daemon_state <span class="ot">&lt;-</span> newMVar <span class="dt">Idle</span></span>
<span id="daemon-start-37"><a href="#daemon-start-37"></a>    db_path <span class="ot">&lt;-</span> getDatabasePath config</span>
<span id="daemon-start-38"><a href="#daemon-start-38"></a>    <span class="kw">let</span> dbRunner conn <span class="ot">=</span> <span class="kw">do</span></span>
<span id="daemon-start-39"><a href="#daemon-start-39"></a>                    <span class="kw">let</span> session <span class="ot">=</span> <span class="dt">Session</span> [] fsnotify channel daemon_state conn</span>
<span id="daemon-start-40"><a href="#daemon-start-40"></a>                    (x, session&#39;, action) <span class="ot">&lt;-</span> runRWST (unDaemon initSession) config session</span>
<span id="daemon-start-41"><a href="#daemon-start-41"></a>                    runTransaction action</span>
<span id="daemon-start-42"><a href="#daemon-start-42"></a>                    events <span class="ot">&lt;-</span> getChanContents channel</span>
<span id="daemon-start-43"><a href="#daemon-start-43"></a>                    foldx (\e s <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="daemon-start-44"><a href="#daemon-start-44"></a>                                      (_, s&#39;, a) <span class="ot">&lt;-</span> runRWST (unDaemon <span class="op">$</span> mainLoop e) config s</span>
<span id="daemon-start-45"><a href="#daemon-start-45"></a>                                      runTransaction a</span>
<span id="daemon-start-46"><a href="#daemon-start-46"></a>                                      <span class="fu">return</span> s&#39;) events session&#39;</span>
<span id="daemon-start-47"><a href="#daemon-start-47"></a>    liftIO <span class="op">$</span> withConnection db_path dbRunner</span>
<span id="daemon-start-48"><a href="#daemon-start-48"></a>    liftIO <span class="op">$</span> FSNotify.stopManager fsnotify</span></code></pre></div>
</div>
<h1 id="configuration">Configuration</h1>
<div class="annotated-code">
<p><span><em>«src/Config.hs»=</em></span></p>
<div class="sourceCode" id="cb15" data-file="src/Config.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">module</span> <span class="dt">Config</span> <span class="kw">where</span></span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="kw">import</span> <span class="dt">Logging</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="kw">import</span> <span class="dt">Errors</span></span>
<span id="cb15-5"><a href="#cb15-5"></a></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.IO</span> <span class="kw">as</span> <span class="dt">T.IO</span></span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="kw">import</span> <span class="dt">TextUtil</span></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-set&gt;&gt;</span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Toml</span></span>
<span id="cb15-12"><a href="#cb15-12"></a><span class="kw">import</span> <span class="dt">Toml</span> (<span class="dt">TomlCodec</span>, (.=))</span>
<span id="cb15-13"><a href="#cb15-13"></a><span class="kw">import</span> <span class="dt">Data.Function</span> (on)</span>
<span id="cb15-14"><a href="#cb15-14"></a><span class="kw">import</span> <span class="dt">Data.List</span> (find, scanl1)</span>
<span id="cb15-15"><a href="#cb15-15"></a><span class="kw">import</span> <span class="dt">Control.Applicative</span> ((&lt;|&gt;))</span>
<span id="cb15-16"><a href="#cb15-16"></a><span class="kw">import</span> <span class="dt">Control.Monad.Extra</span> (concatMapM)</span>
<span id="cb15-17"><a href="#cb15-17"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span></span>
<span id="cb15-18"><a href="#cb15-18"></a><span class="kw">import</span> <span class="dt">Control.Monad.Catch</span></span>
<span id="cb15-19"><a href="#cb15-19"></a><span class="kw">import</span> <span class="dt">System.FilePath.Glob</span> (glob)</span>
<span id="cb15-20"><a href="#cb15-20"></a><span class="kw">import</span> <span class="dt">System.Directory</span> </span>
<span id="cb15-21"><a href="#cb15-21"></a><span class="kw">import</span> <span class="dt">System.FilePath</span></span>
<span id="cb15-22"><a href="#cb15-22"></a></span>
<span id="cb15-23"><a href="#cb15-23"></a><span class="op">&lt;&lt;</span>config<span class="op">-</span>types<span class="op">&gt;&gt;</span></span>
<span id="cb15-24"><a href="#cb15-24"></a><span class="op">&lt;&lt;</span>config<span class="op">-</span>tomland<span class="op">&gt;&gt;</span></span>
<span id="cb15-25"><a href="#cb15-25"></a><span class="op">&lt;&lt;</span>config<span class="op">-</span>monoid<span class="op">&gt;&gt;</span></span>
<span id="cb15-26"><a href="#cb15-26"></a><span class="op">&lt;&lt;</span>config<span class="op">-</span>defaults<span class="op">&gt;&gt;</span></span>
<span id="cb15-27"><a href="#cb15-27"></a><span class="op">&lt;&lt;</span>config<span class="op">-</span>input<span class="op">&gt;&gt;</span></span>
<span id="cb15-28"><a href="#cb15-28"></a><span class="op">&lt;&lt;</span>config<span class="op">-</span>reader<span class="op">&gt;&gt;</span></span>
<span id="cb15-29"><a href="#cb15-29"></a></span>
<span id="cb15-30"><a href="#cb15-30"></a><span class="ot">getDatabasePath ::</span> (<span class="dt">MonadIO</span> m, <span class="dt">MonadThrow</span> m) <span class="ot">=&gt;</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> m <span class="dt">FilePath</span></span>
<span id="cb15-31"><a href="#cb15-31"></a>getDatabasePath cfg <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb15-32"><a href="#cb15-32"></a>    dbPath <span class="ot">&lt;-</span> <span class="kw">case</span> configEntangled cfg <span class="op">&gt;&gt;=</span> database <span class="kw">of</span></span>
<span id="cb15-33"><a href="#cb15-33"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throwM <span class="op">$</span> <span class="dt">SystemError</span> <span class="op">$</span> <span class="st">&quot;database not configured&quot;</span></span>
<span id="cb15-34"><a href="#cb15-34"></a>        <span class="dt">Just</span> db <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> T.unpack db</span>
<span id="cb15-35"><a href="#cb15-35"></a>    liftIO <span class="op">$</span> createDirectoryIfMissing <span class="dt">True</span> (takeDirectory dbPath)</span>
<span id="cb15-36"><a href="#cb15-36"></a>    <span class="fu">return</span> dbPath</span>
<span id="cb15-37"><a href="#cb15-37"></a></span>
<span id="cb15-38"><a href="#cb15-38"></a><span class="ot">getInputFiles ::</span> (<span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> m [<span class="dt">FilePath</span>]</span>
<span id="cb15-39"><a href="#cb15-39"></a>getInputFiles cfg <span class="ot">=</span> liftIO <span class="op">$</span> <span class="fu">maybe</span> <span class="fu">mempty</span></span>
<span id="cb15-40"><a href="#cb15-40"></a>        (concatMapM (glob <span class="op">.</span> T.unpack))</span>
<span id="cb15-41"><a href="#cb15-41"></a>        (watchList <span class="op">=&lt;&lt;</span> configEntangled cfg)</span></code></pre></div>
</div>
<p>Configuration can be stored in <code>${XDG_CONFIG_HOME}/entangled/config.toml</code>. Also the local directory or its parents may contain a <code>.entangled.toml</code> file. These override settings in the global configuration.</p>
<p>There are currently no customisation options for entangled, but I keep my options open: namespaces for references, enabling future features like git support, you name it. The one component that we do need to configure is adding languages to the mix. Entangled has to know how to generate comments in every language.</p>
<div class="annotated-code">
<p><span><em>«example-config»=</em></span></p>
<pre id="example-config" class="toml"><code>[entangled]
watch-list = [&quot;lit/*.md&quot;]   # list of glob-patterns
database = &quot;.entangled.sqlite&quot; # backend database
use-namespaces = true       # soon to be implemented
enable-git = false          # tbi somewhat less soon

[[languages]]
name = &quot;Bel&quot;
identifiers = [&quot;bel&quot;]       # case insensitive
start-comment = &quot;; -----&quot;   # used to insert tangle tags
                            # and also to parse them back!

[[languages]]
name = &quot;HTML&quot;
identifiers = [&quot;html&quot;]
start-comment = &quot;&lt;!--&quot;
close-comment = &quot;--&gt;&quot;       # some languages (HTML, CSS) only
                            # support block comments</code></pre>
</div>
<p>The Haskell definition of the <code>Config</code> data type is</p>
<div class="annotated-code">
<p><span><em>«config-types»=</em></span></p>
<div class="sourceCode" id="config-types"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="config-types-1"><a href="#config-types-1"></a><span class="kw">data</span> <span class="dt">Entangled</span> <span class="ot">=</span> <span class="dt">Entangled</span></span>
<span id="config-types-2"><a href="#config-types-2"></a>    {<span class="ot"> watchList ::</span> <span class="dt">Maybe</span> [<span class="dt">Text</span>]</span>
<span id="config-types-3"><a href="#config-types-3"></a>    ,<span class="ot"> database ::</span> <span class="dt">Maybe</span> <span class="dt">Text</span></span>
<span id="config-types-4"><a href="#config-types-4"></a>    ,<span class="ot"> useNamespaces ::</span> <span class="dt">Maybe</span> <span class="dt">Bool</span></span>
<span id="config-types-5"><a href="#config-types-5"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="config-types-6"><a href="#config-types-6"></a></span>
<span id="config-types-7"><a href="#config-types-7"></a><span class="kw">data</span> <span class="dt">Language</span> <span class="ot">=</span> <span class="dt">Language</span></span>
<span id="config-types-8"><a href="#config-types-8"></a>    {<span class="ot"> languageName ::</span> <span class="dt">Text</span></span>
<span id="config-types-9"><a href="#config-types-9"></a>    ,<span class="ot"> languageIdentifiers ::</span> [<span class="dt">Text</span>]</span>
<span id="config-types-10"><a href="#config-types-10"></a>    ,<span class="ot"> languageStartComment ::</span> <span class="dt">Text</span></span>
<span id="config-types-11"><a href="#config-types-11"></a>    ,<span class="ot"> languageCloseComment ::</span> <span class="dt">Maybe</span> <span class="dt">Text</span></span>
<span id="config-types-12"><a href="#config-types-12"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="config-types-13"><a href="#config-types-13"></a></span>
<span id="config-types-14"><a href="#config-types-14"></a><span class="kw">instance</span> <span class="dt">Eq</span> <span class="dt">Language</span> <span class="kw">where</span></span>
<span id="config-types-15"><a href="#config-types-15"></a>    (<span class="op">==</span>) <span class="ot">=</span> (<span class="op">==</span>) <span class="ot">`on`</span> languageName</span>
<span id="config-types-16"><a href="#config-types-16"></a></span>
<span id="config-types-17"><a href="#config-types-17"></a><span class="kw">instance</span> <span class="dt">Ord</span> <span class="dt">Language</span> <span class="kw">where</span></span>
<span id="config-types-18"><a href="#config-types-18"></a>    <span class="fu">compare</span> <span class="ot">=</span> <span class="fu">compare</span> <span class="ot">`on`</span> languageName</span>
<span id="config-types-19"><a href="#config-types-19"></a></span>
<span id="config-types-20"><a href="#config-types-20"></a><span class="kw">data</span> <span class="dt">Config</span> <span class="ot">=</span> <span class="dt">Config</span></span>
<span id="config-types-21"><a href="#config-types-21"></a>    {<span class="ot"> configEntangled ::</span> <span class="dt">Maybe</span> <span class="dt">Entangled</span></span>
<span id="config-types-22"><a href="#config-types-22"></a>    ,<span class="ot"> configLanguages ::</span> <span class="dt">Set</span> <span class="dt">Language</span></span>
<span id="config-types-23"><a href="#config-types-23"></a>    } <span class="kw">deriving</span> (<span class="dt">Show</span>)</span></code></pre></div>
</div>
<p>Serialisation to and from TOML:</p>
<div class="annotated-code">
<p><span><em>«config-tomland»=</em></span></p>
<div class="sourceCode" id="config-tomland"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="config-tomland-1"><a href="#config-tomland-1"></a><span class="ot">entangledCodec ::</span> <span class="dt">TomlCodec</span> <span class="dt">Entangled</span></span>
<span id="config-tomland-2"><a href="#config-tomland-2"></a>entangledCodec <span class="ot">=</span> <span class="dt">Entangled</span></span>
<span id="config-tomland-3"><a href="#config-tomland-3"></a>    <span class="op">&lt;$&gt;</span> Toml.dioptional (Toml.arrayOf Toml._Text <span class="st">&quot;watch-list&quot;</span>) <span class="op">.=</span> watchList</span>
<span id="config-tomland-4"><a href="#config-tomland-4"></a>    <span class="op">&lt;*&gt;</span> Toml.dioptional (Toml.text <span class="st">&quot;database&quot;</span>) <span class="op">.=</span> database</span>
<span id="config-tomland-5"><a href="#config-tomland-5"></a>    <span class="op">&lt;*&gt;</span> Toml.dioptional (Toml.bool <span class="st">&quot;use-namespaces&quot;</span>) <span class="op">.=</span> useNamespaces</span>
<span id="config-tomland-6"><a href="#config-tomland-6"></a></span>
<span id="config-tomland-7"><a href="#config-tomland-7"></a><span class="ot">languageCodec ::</span> <span class="dt">TomlCodec</span> <span class="dt">Language</span></span>
<span id="config-tomland-8"><a href="#config-tomland-8"></a>languageCodec <span class="ot">=</span> <span class="dt">Language</span></span>
<span id="config-tomland-9"><a href="#config-tomland-9"></a>    <span class="op">&lt;$&gt;</span> Toml.text <span class="st">&quot;name&quot;</span> <span class="op">.=</span> languageName</span>
<span id="config-tomland-10"><a href="#config-tomland-10"></a>    <span class="op">&lt;*&gt;</span> Toml.arrayOf Toml._Text <span class="st">&quot;identifiers&quot;</span> <span class="op">.=</span> languageIdentifiers</span>
<span id="config-tomland-11"><a href="#config-tomland-11"></a>    <span class="op">&lt;*&gt;</span> Toml.text <span class="st">&quot;start-comment&quot;</span> <span class="op">.=</span> languageStartComment</span>
<span id="config-tomland-12"><a href="#config-tomland-12"></a>    <span class="op">&lt;*&gt;</span> Toml.dioptional (Toml.text <span class="st">&quot;close-comment&quot;</span>) <span class="op">.=</span> languageCloseComment</span>
<span id="config-tomland-13"><a href="#config-tomland-13"></a></span>
<span id="config-tomland-14"><a href="#config-tomland-14"></a><span class="ot">configCodec ::</span> <span class="dt">TomlCodec</span> <span class="dt">Config</span></span>
<span id="config-tomland-15"><a href="#config-tomland-15"></a>configCodec <span class="ot">=</span> <span class="dt">Config</span></span>
<span id="config-tomland-16"><a href="#config-tomland-16"></a>    <span class="op">&lt;$&gt;</span> Toml.dioptional (Toml.table entangledCodec <span class="st">&quot;entangled&quot;</span>) <span class="op">.=</span> configEntangled</span>
<span id="config-tomland-17"><a href="#config-tomland-17"></a>    <span class="op">&lt;*&gt;</span> Toml.set languageCodec <span class="st">&quot;languages&quot;</span> <span class="op">.=</span> configLanguages</span></code></pre></div>
</div>
<p>We need to be able to stack configurations, so we implement <code>Monoid</code> on <code>Config</code>. There is a generic way of doing this using <code>GHC.Generic</code>, <code>DeriveGeneric</code> language extension and <code>Generic.Data</code> module. For the moment this would be a bit overkill.</p>
<blockquote>
<p>Tip from Merijn: put the maybes in a <code>First</code>/<code>Last</code>/<code>Alt</code> instance. This will enforce <code>&lt;|&gt;</code> behaviour on the monoid being used.</p>
</blockquote>
<div class="annotated-code">
<p><span><em>«config-monoid»=</em></span></p>
<div class="sourceCode" id="config-monoid"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="config-monoid-1"><a href="#config-monoid-1"></a><span class="kw">instance</span> <span class="dt">Semigroup</span> <span class="dt">Entangled</span> <span class="kw">where</span></span>
<span id="config-monoid-2"><a href="#config-monoid-2"></a>    a <span class="op">&lt;&gt;</span> b <span class="ot">=</span> <span class="dt">Entangled</span> (watchList a <span class="op">&lt;&gt;</span> watchList b)</span>
<span id="config-monoid-3"><a href="#config-monoid-3"></a>                       (database a <span class="op">&lt;|&gt;</span> database b)</span>
<span id="config-monoid-4"><a href="#config-monoid-4"></a>                       (useNamespaces a <span class="op">&lt;|&gt;</span> useNamespaces b)</span>
<span id="config-monoid-5"><a href="#config-monoid-5"></a></span>
<span id="config-monoid-6"><a href="#config-monoid-6"></a><span class="kw">instance</span> <span class="dt">Semigroup</span> <span class="dt">Config</span> <span class="kw">where</span></span>
<span id="config-monoid-7"><a href="#config-monoid-7"></a>    a <span class="op">&lt;&gt;</span> b <span class="ot">=</span> <span class="dt">Config</span> (configEntangled a <span class="op">&lt;&gt;</span> configEntangled b)</span>
<span id="config-monoid-8"><a href="#config-monoid-8"></a>                    (configLanguages a <span class="op">&lt;&gt;</span> configLanguages b)</span>
<span id="config-monoid-9"><a href="#config-monoid-9"></a></span>
<span id="config-monoid-10"><a href="#config-monoid-10"></a><span class="kw">instance</span> <span class="dt">Monoid</span> <span class="dt">Config</span> <span class="kw">where</span></span>
<span id="config-monoid-11"><a href="#config-monoid-11"></a>    <span class="fu">mempty</span> <span class="ot">=</span> <span class="dt">Config</span> <span class="fu">mempty</span> <span class="fu">mempty</span></span></code></pre></div>
</div>
<p>You can see this will grow out of hand as the configuration becomes a bigger thing. Note that the stacking prioritises the left most element. The complete config is then:</p>
<div class="annotated-code">
<p><span><em>«config-monoid»+</em></span></p>
<div class="sourceCode" id="config-monoid"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="config-monoid-1"><a href="#config-monoid-1"></a><span class="ot">configStack ::</span> <span class="dt">IO</span> <span class="dt">Config</span></span>
<span id="config-monoid-2"><a href="#config-monoid-2"></a>configStack <span class="ot">=</span> <span class="kw">do</span></span>
<span id="config-monoid-3"><a href="#config-monoid-3"></a>    localConfig <span class="ot">&lt;-</span> readLocalConfig</span>
<span id="config-monoid-4"><a href="#config-monoid-4"></a>    globalConfig <span class="ot">&lt;-</span> readGlobalConfig</span>
<span id="config-monoid-5"><a href="#config-monoid-5"></a>    <span class="fu">return</span> <span class="op">$</span> localConfig <span class="op">&lt;&gt;</span> globalConfig <span class="op">&lt;&gt;</span> defaultConfig</span></code></pre></div>
</div>
<h2 id="defaults">Defaults</h2>
<p>A somewhat biased list of languages: I don’t know half of you half as well as I should like; and I like less than half of you half as well as you deserve.</p>
<div class="annotated-code">
<p><span><em>«config-defaults»=</em></span></p>
<div class="sourceCode" id="config-defaults"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="config-defaults-1"><a href="#config-defaults-1"></a><span class="ot">defaultLanguages ::</span> <span class="dt">Set</span> <span class="dt">Language</span></span>
<span id="config-defaults-2"><a href="#config-defaults-2"></a>defaultLanguages <span class="ot">=</span> S.fromList</span>
<span id="config-defaults-3"><a href="#config-defaults-3"></a>    [ <span class="dt">Language</span> <span class="st">&quot;C++&quot;</span>         [<span class="st">&quot;cpp&quot;</span>, <span class="st">&quot;c++&quot;</span>]               <span class="st">&quot;//&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-4"><a href="#config-defaults-4"></a>    , <span class="dt">Language</span> <span class="st">&quot;C&quot;</span>           [<span class="st">&quot;c&quot;</span>]                        <span class="st">&quot;//&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-5"><a href="#config-defaults-5"></a>    , <span class="dt">Language</span> <span class="st">&quot;Rust&quot;</span>        [<span class="st">&quot;rust&quot;</span>]                     <span class="st">&quot;//&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-6"><a href="#config-defaults-6"></a>    , <span class="dt">Language</span> <span class="st">&quot;Haskell&quot;</span>     [<span class="st">&quot;hs&quot;</span>, <span class="st">&quot;haskell&quot;</span>]            <span class="st">&quot;--&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-7"><a href="#config-defaults-7"></a>    , <span class="dt">Language</span> <span class="st">&quot;Python&quot;</span>      [<span class="st">&quot;py&quot;</span>, <span class="st">&quot;python&quot;</span>, <span class="st">&quot;python3&quot;</span>]  <span class="st">&quot;##&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-8"><a href="#config-defaults-8"></a>    , <span class="dt">Language</span> <span class="st">&quot;Julia&quot;</span>       [<span class="st">&quot;jl&quot;</span>, <span class="st">&quot;julia&quot;</span>]              <span class="st">&quot;##&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-9"><a href="#config-defaults-9"></a>    , <span class="dt">Language</span> <span class="st">&quot;JavaScript&quot;</span>  [<span class="st">&quot;js&quot;</span>, <span class="st">&quot;javascript&quot;</span>, <span class="st">&quot;ecma&quot;</span>] <span class="st">&quot;//&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-10"><a href="#config-defaults-10"></a>    , <span class="dt">Language</span> <span class="st">&quot;Scheme&quot;</span>      [<span class="st">&quot;scm&quot;</span>, <span class="st">&quot;scheme&quot;</span>]            <span class="st">&quot;;;&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-11"><a href="#config-defaults-11"></a>    , <span class="dt">Language</span> <span class="st">&quot;R&quot;</span>           [<span class="st">&quot;r&quot;</span>]                        <span class="st">&quot;##&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-12"><a href="#config-defaults-12"></a>    , <span class="dt">Language</span> <span class="st">&quot;YAML&quot;</span>        [<span class="st">&quot;yaml&quot;</span>]                     <span class="st">&quot;##&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-13"><a href="#config-defaults-13"></a>    , <span class="dt">Language</span> <span class="st">&quot;Gnuplot&quot;</span>     [<span class="st">&quot;gnuplot&quot;</span>]                  <span class="st">&quot;##&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-14"><a href="#config-defaults-14"></a>    , <span class="dt">Language</span> <span class="st">&quot;Make&quot;</span>        [<span class="st">&quot;make&quot;</span>, <span class="st">&quot;makefile&quot;</span>]         <span class="st">&quot;##&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-15"><a href="#config-defaults-15"></a>    , <span class="dt">Language</span> <span class="st">&quot;Elm&quot;</span>         [<span class="st">&quot;elm&quot;</span>]                      <span class="st">&quot;--&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-16"><a href="#config-defaults-16"></a>    , <span class="dt">Language</span> <span class="st">&quot;HTML&quot;</span>        [<span class="st">&quot;html&quot;</span>]                     <span class="st">&quot;&lt;!--&quot;</span> (<span class="dt">Just</span> <span class="st">&quot;--&gt;&quot;</span>)</span>
<span id="config-defaults-17"><a href="#config-defaults-17"></a>    , <span class="dt">Language</span> <span class="st">&quot;CSS&quot;</span>         [<span class="st">&quot;css&quot;</span>]                      <span class="st">&quot;/*&quot;</span> (<span class="dt">Just</span> <span class="st">&quot;*/&quot;</span>)</span>
<span id="config-defaults-18"><a href="#config-defaults-18"></a>    , <span class="dt">Language</span> <span class="st">&quot;Awk&quot;</span>         [<span class="st">&quot;awk&quot;</span>]                      <span class="st">&quot;##&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-19"><a href="#config-defaults-19"></a>    , <span class="dt">Language</span> <span class="st">&quot;OCaml&quot;</span>       [<span class="st">&quot;ocaml&quot;</span>]                    <span class="st">&quot;(*&quot;</span> (<span class="dt">Just</span> <span class="st">&quot;*)&quot;</span>)</span>
<span id="config-defaults-20"><a href="#config-defaults-20"></a>    , <span class="dt">Language</span> <span class="st">&quot;LaTeX&quot;</span>       [<span class="st">&quot;latex&quot;</span>]                    <span class="st">&quot;%%&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-21"><a href="#config-defaults-21"></a>    , <span class="dt">Language</span> <span class="st">&quot;Lua&quot;</span>         [<span class="st">&quot;lua&quot;</span>]                      <span class="st">&quot;--&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-22"><a href="#config-defaults-22"></a>    , <span class="dt">Language</span> <span class="st">&quot;OpenCL&quot;</span>      [<span class="st">&quot;opencl&quot;</span>]                   <span class="st">&quot;//&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-23"><a href="#config-defaults-23"></a>    , <span class="dt">Language</span> <span class="st">&quot;SQLite&quot;</span>      [<span class="st">&quot;sqlite&quot;</span>]                   <span class="st">&quot;--&quot;</span> <span class="dt">Nothing</span></span>
<span id="config-defaults-24"><a href="#config-defaults-24"></a>    ]</span>
<span id="config-defaults-25"><a href="#config-defaults-25"></a></span>
<span id="config-defaults-26"><a href="#config-defaults-26"></a><span class="ot">defaultConfig ::</span> <span class="dt">Config</span></span>
<span id="config-defaults-27"><a href="#config-defaults-27"></a>defaultConfig <span class="ot">=</span> <span class="dt">Config</span></span>
<span id="config-defaults-28"><a href="#config-defaults-28"></a>    { configEntangled <span class="ot">=</span> <span class="dt">Just</span> <span class="op">$</span></span>
<span id="config-defaults-29"><a href="#config-defaults-29"></a>          <span class="dt">Entangled</span> { useNamespaces<span class="ot">=</span><span class="dt">Just</span> <span class="dt">False</span></span>
<span id="config-defaults-30"><a href="#config-defaults-30"></a>                    , database<span class="ot">=</span><span class="dt">Just</span> <span class="st">&quot;.entangled/db.sqlite&quot;</span></span>
<span id="config-defaults-31"><a href="#config-defaults-31"></a>                    , watchList<span class="ot">=</span><span class="dt">Nothing</span></span>
<span id="config-defaults-32"><a href="#config-defaults-32"></a>                    }</span>
<span id="config-defaults-33"><a href="#config-defaults-33"></a>    , configLanguages <span class="ot">=</span> defaultLanguages</span>
<span id="config-defaults-34"><a href="#config-defaults-34"></a>    }</span></code></pre></div>
</div>
<h3 id="reading-config-files">Reading config files</h3>
<div class="TODO">
<p>NYI</p>
</div>
<div class="annotated-code">
<p><span><em>«config-input»=</em></span></p>
<div class="sourceCode" id="config-input"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="config-input-1"><a href="#config-input-1"></a><span class="ot">findFileAscending ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">FilePath</span>)</span>
<span id="config-input-2"><a href="#config-input-2"></a>findFileAscending filename <span class="ot">=</span> <span class="kw">do</span></span>
<span id="config-input-3"><a href="#config-input-3"></a>    path <span class="ot">&lt;-</span> dropTrailingPathSeparator <span class="op">&lt;$&gt;</span> getCurrentDirectory</span>
<span id="config-input-4"><a href="#config-input-4"></a>    <span class="kw">let</span> parents <span class="ot">=</span> <span class="fu">reverse</span> <span class="op">$</span> <span class="fu">scanl1</span> (<span class="op">&lt;/&gt;</span>) <span class="op">$</span> splitDirectories path</span>
<span id="config-input-5"><a href="#config-input-5"></a>    findFile parents filename</span>
<span id="config-input-6"><a href="#config-input-6"></a></span>
<span id="config-input-7"><a href="#config-input-7"></a><span class="ot">readLocalConfig ::</span> <span class="dt">IO</span> <span class="dt">Config</span></span>
<span id="config-input-8"><a href="#config-input-8"></a>readLocalConfig <span class="ot">=</span> <span class="kw">do</span></span>
<span id="config-input-9"><a href="#config-input-9"></a>    cfg_path <span class="ot">&lt;-</span> <span class="fu">maybe</span> (throwM <span class="op">$</span> <span class="dt">SystemError</span> <span class="st">&quot;no config found.&quot;</span>) <span class="fu">id</span> <span class="op">&lt;$&gt;</span> findFileAscending <span class="st">&quot;entangled.toml&quot;</span></span>
<span id="config-input-10"><a href="#config-input-10"></a>    cfg_toml <span class="ot">&lt;-</span> T.IO.readFile cfg_path</span>
<span id="config-input-11"><a href="#config-input-11"></a>    <span class="fu">either</span> (throwM <span class="op">.</span> <span class="dt">SystemError</span> <span class="op">.</span> tshow) <span class="fu">return</span> <span class="op">$</span> Toml.decode configCodec cfg_toml</span>
<span id="config-input-12"><a href="#config-input-12"></a></span>
<span id="config-input-13"><a href="#config-input-13"></a><span class="ot">readGlobalConfig ::</span> <span class="dt">IO</span> <span class="dt">Config</span></span>
<span id="config-input-14"><a href="#config-input-14"></a>readGlobalConfig <span class="ot">=</span> <span class="fu">mempty</span></span></code></pre></div>
</div>
<h2 id="processing">Processing</h2>
<div class="annotated-code">
<p><span><em>«config-reader»=</em></span></p>
<div class="sourceCode" id="config-reader"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="config-reader-1"><a href="#config-reader-1"></a><span class="ot">lookupLanguage ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Language</span></span>
<span id="config-reader-2"><a href="#config-reader-2"></a>lookupLanguage cfg x</span>
<span id="config-reader-3"><a href="#config-reader-3"></a>    <span class="ot">=</span> find (<span class="fu">elem</span> x <span class="op">.</span> languageIdentifiers) </span>
<span id="config-reader-4"><a href="#config-reader-4"></a>    <span class="op">$</span> configLanguages cfg</span>
<span id="config-reader-5"><a href="#config-reader-5"></a></span>
<span id="config-reader-6"><a href="#config-reader-6"></a><span class="ot">languageFromName ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Language</span></span>
<span id="config-reader-7"><a href="#config-reader-7"></a>languageFromName cfg x</span>
<span id="config-reader-8"><a href="#config-reader-8"></a>    <span class="ot">=</span> find ((<span class="op">==</span> x) <span class="op">.</span> languageName)</span>
<span id="config-reader-9"><a href="#config-reader-9"></a>    <span class="op">$</span> configLanguages cfg</span></code></pre></div>
</div>
<h1 id="logging">Logging</h1>
<p>A logging type class.</p>
<div class="annotated-code">
<p><span><em>«src/Logging.hs»=</em></span></p>
<div class="sourceCode" id="cb16" data-file="src/Logging.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">module</span> <span class="dt">Logging</span> <span class="kw">where</span></span>
<span id="cb16-2"><a href="#cb16-2"></a></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="kw">import</span> <span class="dt">Control.Monad.Writer</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="cb16-6"><a href="#cb16-6"></a></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="kw">data</span> <span class="dt">LogLevel</span> <span class="ot">=</span> <span class="dt">Error</span> <span class="op">|</span> <span class="dt">Warning</span> <span class="op">|</span> <span class="dt">Message</span> <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb16-8"><a href="#cb16-8"></a></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="kw">class</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">MonadLogger</span> m <span class="kw">where</span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="ot">    logEntry ::</span> <span class="dt">LogLevel</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> m ()</span>
<span id="cb16-11"><a href="#cb16-11"></a></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="kw">instance</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">MonadLogger</span> (<span class="dt">WriterT</span> [(<span class="dt">LogLevel</span>, <span class="dt">Text</span>)] m) <span class="kw">where</span></span>
<span id="cb16-13"><a href="#cb16-13"></a>    logEntry level msg <span class="ot">=</span> tell <span class="op">$</span> <span class="fu">pure</span> (level, msg)</span>
<span id="cb16-14"><a href="#cb16-14"></a></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="ot">logError ::</span> (<span class="dt">MonadLogger</span> m) <span class="ot">=&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> m ()</span>
<span id="cb16-16"><a href="#cb16-16"></a>logError <span class="ot">=</span> logEntry <span class="dt">Error</span></span>
<span id="cb16-17"><a href="#cb16-17"></a></span>
<span id="cb16-18"><a href="#cb16-18"></a><span class="ot">logWarning ::</span> (<span class="dt">MonadLogger</span> m) <span class="ot">=&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> m ()</span>
<span id="cb16-19"><a href="#cb16-19"></a>logWarning <span class="ot">=</span> logEntry <span class="dt">Warning</span></span>
<span id="cb16-20"><a href="#cb16-20"></a></span>
<span id="cb16-21"><a href="#cb16-21"></a><span class="ot">logMessage ::</span> (<span class="dt">MonadLogger</span> m) <span class="ot">=&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> m ()</span>
<span id="cb16-22"><a href="#cb16-22"></a>logMessage <span class="ot">=</span> logEntry <span class="dt">Message</span></span>
<span id="cb16-23"><a href="#cb16-23"></a></span>
<span id="cb16-24"><a href="#cb16-24"></a><span class="ot">forwardEntries ::</span> (<span class="dt">MonadLogger</span> m, <span class="dt">Foldable</span> t) <span class="ot">=&gt;</span> t (<span class="dt">LogLevel</span>, <span class="dt">Text</span>) <span class="ot">-&gt;</span> m ()</span>
<span id="cb16-25"><a href="#cb16-25"></a>forwardEntries <span class="ot">=</span> <span class="fu">mapM_</span> (<span class="fu">uncurry</span> logEntry)</span></code></pre></div>
</div>
<h1 id="parsing-anything-with-megaparsec">Parsing anything with Megaparsec</h1>
<p>Megaparsec is considered to be preferable over older Parsec. It is a bit more work to parse different things than strings though. We will be parsing lists of items.</p>
<div class="annotated-code">
<p><span><em>«src/ListStream.hs»=</em></span></p>
<div class="sourceCode" id="cb17" data-file="src/ListStream.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">module</span> <span class="dt">ListStream</span> <span class="kw">where</span></span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec</span> (<span class="dt">Parsec</span>, <span class="dt">MonadParsec</span>, token, parse)</span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec</span> (<span class="dt">Stream</span> (..), <span class="dt">PosState</span> (..), <span class="dt">SourcePos</span> (..), mkPos, unPos)</span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="kw">import</span> <span class="dt">Data.Proxy</span> (<span class="dt">Proxy</span> (..))</span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="kw">import</span> <span class="dt">Data.Void</span> (<span class="dt">Void</span>)</span>
<span id="cb17-8"><a href="#cb17-8"></a></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="op">&lt;&lt;</span><span class="kw">instance</span><span class="op">-</span>list<span class="op">-</span>stream<span class="op">&gt;&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10"></a></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="op">&lt;&lt;</span>list<span class="op">-</span>stream<span class="op">-</span>helpers<span class="op">&gt;&gt;</span></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="op">&lt;&lt;</span>line<span class="op">-</span>parser<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>The minimal definition of a stream must define <code>tokensToChunk</code>, <code>chunkToTokens</code>, <code>chunkLength</code>, <code>take1_</code>, <code>takeN_</code>, <code>takeWhile_</code>, <code>showTokens</code> and <code>reachOffset</code>.</p>
<p>Because our instance will overlap with that of <code>[Char] = String</code> we’ll have to wrap the <code>ListStream</code> in a <code>newtype</code>.</p>
<div class="annotated-code">
<p><span><em>«instance-list-stream»=</em></span></p>
<div class="sourceCode" id="instance-list-stream"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="instance-list-stream-1"><a href="#instance-list-stream-1"></a><span class="kw">newtype</span> <span class="dt">ListStream</span> a <span class="ot">=</span> <span class="dt">ListStream</span> {<span class="ot"> unListStream ::</span> [a] }</span>
<span id="instance-list-stream-2"><a href="#instance-list-stream-2"></a>    <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Foldable</span>, <span class="dt">Semigroup</span>, <span class="dt">Monoid</span>, <span class="dt">Functor</span>, <span class="dt">Applicative</span>, <span class="dt">Monad</span>)</span>
<span id="instance-list-stream-3"><a href="#instance-list-stream-3"></a></span>
<span id="instance-list-stream-4"><a href="#instance-list-stream-4"></a><span class="kw">instance</span> (<span class="dt">Eq</span> a, <span class="dt">Ord</span> a, <span class="dt">Show</span> a) <span class="ot">=&gt;</span> <span class="dt">Stream</span> (<span class="dt">ListStream</span> a) <span class="kw">where</span></span>
<span id="instance-list-stream-5"><a href="#instance-list-stream-5"></a>    <span class="op">&lt;&lt;</span>list<span class="op">-</span>stream<span class="op">-</span>associated<span class="op">-</span>types<span class="op">&gt;&gt;</span></span>
<span id="instance-list-stream-6"><a href="#instance-list-stream-6"></a>    <span class="op">&lt;&lt;</span>list<span class="op">-</span>stream<span class="op">-</span>methods<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«list-stream-associated-types»=</em></span></p>
<div class="sourceCode" id="list-stream-associated-types"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="list-stream-associated-types-1"><a href="#list-stream-associated-types-1"></a><span class="kw">type</span> <span class="dt">Token</span> (<span class="dt">ListStream</span> a) <span class="ot">=</span> a</span>
<span id="list-stream-associated-types-2"><a href="#list-stream-associated-types-2"></a><span class="kw">type</span> <span class="dt">Tokens</span> (<span class="dt">ListStream</span> a) <span class="ot">=</span> [a]</span></code></pre></div>
</div>
<p>Converting a token to a chunk is just <code>pure</code>.</p>
<div class="annotated-code">
<p><span><em>«list-stream-methods»=</em></span></p>
<div class="sourceCode" id="list-stream-methods"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="list-stream-methods-1"><a href="#list-stream-methods-1"></a>tokenToChunk <span class="dt">Proxy</span> <span class="ot">=</span> <span class="fu">pure</span></span></code></pre></div>
</div>
<p>Tokens to chunk or even chunk to tokens are both the identity function</p>
<div class="annotated-code">
<p><span><em>«list-stream-methods»+</em></span></p>
<div class="sourceCode" id="list-stream-methods"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="list-stream-methods-1"><a href="#list-stream-methods-1"></a>tokensToChunk <span class="dt">Proxy</span> <span class="ot">=</span> <span class="fu">id</span></span>
<span id="list-stream-methods-2"><a href="#list-stream-methods-2"></a>chunkToTokens <span class="dt">Proxy</span> <span class="ot">=</span> <span class="fu">id</span></span>
<span id="list-stream-methods-3"><a href="#list-stream-methods-3"></a>chunkLength <span class="dt">Proxy</span> <span class="ot">=</span> <span class="fu">length</span></span>
<span id="list-stream-methods-4"><a href="#list-stream-methods-4"></a>chunkEmpty <span class="dt">Proxy</span> <span class="ot">=</span> <span class="fu">null</span></span></code></pre></div>
</div>
<p>In fact, these definitions are identical to those in the instance definition for <code>Stream String</code> in Megaparsec.</p>
<div class="annotated-code">
<p><span><em>«list-stream-methods»+</em></span></p>
<div class="sourceCode" id="list-stream-methods"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="list-stream-methods-1"><a href="#list-stream-methods-1"></a>take1_ (<span class="dt">ListStream</span> [])     <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="list-stream-methods-2"><a href="#list-stream-methods-2"></a>take1_ (<span class="dt">ListStream</span> (x<span class="op">:</span>xs)) <span class="ot">=</span> <span class="dt">Just</span> (x, <span class="dt">ListStream</span> xs)</span>
<span id="list-stream-methods-3"><a href="#list-stream-methods-3"></a>takeN_ n (<span class="dt">ListStream</span> xs)</span>
<span id="list-stream-methods-4"><a href="#list-stream-methods-4"></a>    <span class="op">|</span> n <span class="op">&lt;=</span> <span class="dv">0</span>    <span class="ot">=</span> <span class="dt">Just</span> ([], <span class="dt">ListStream</span> xs)</span>
<span id="list-stream-methods-5"><a href="#list-stream-methods-5"></a>    <span class="op">|</span> <span class="fu">null</span> xs   <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="list-stream-methods-6"><a href="#list-stream-methods-6"></a>    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">=</span> <span class="dt">Just</span> (h, <span class="dt">ListStream</span> t) <span class="kw">where</span> (h, t) <span class="ot">=</span> <span class="fu">splitAt</span> n xs</span>
<span id="list-stream-methods-7"><a href="#list-stream-methods-7"></a>takeWhile_ p (<span class="dt">ListStream</span> xs) <span class="ot">=</span> (t, <span class="dt">ListStream</span> h) <span class="kw">where</span> (h, t) <span class="ot">=</span> <span class="fu">break</span> p xs</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«list-stream-methods»+</em></span></p>
<div class="sourceCode" id="list-stream-methods"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="list-stream-methods-1"><a href="#list-stream-methods-1"></a>showTokens <span class="dt">Proxy</span> <span class="ot">=</span> <span class="fu">show</span></span></code></pre></div>
</div>
<p>Here’s where things get different. Offsets are lines in a source file. Therefore, <code>sourceColumn</code> is always 1. The precise working of <code>reachOffset</code> is a bit guesswork.</p>
<div class="annotated-code">
<p><span><em>«list-stream-helpers»=</em></span></p>
<div class="sourceCode" id="list-stream-helpers"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="list-stream-helpers-1"><a href="#list-stream-helpers-1"></a>offsetSourcePos offset sourcePos<span class="op">@</span><span class="dt">SourcePos</span>{<span class="op">..</span>}</span>
<span id="list-stream-helpers-2"><a href="#list-stream-helpers-2"></a>    <span class="ot">=</span> sourcePos { sourceLine <span class="ot">=</span> mkPos (unPos sourceLine <span class="op">+</span> offset) }</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«list-stream-methods»+</em></span></p>
<div class="sourceCode" id="list-stream-methods"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="list-stream-methods-1"><a href="#list-stream-methods-1"></a>reachOffset offset state<span class="op">@</span><span class="dt">PosState</span>{<span class="op">..</span>} <span class="ot">=</span> (sourcePos, repr, state&#39;)</span>
<span id="list-stream-methods-2"><a href="#list-stream-methods-2"></a>    <span class="kw">where</span> sourcePos <span class="ot">=</span> offsetSourcePos (offset <span class="op">-</span> pstateOffset) pstateSourcePos</span>
<span id="list-stream-methods-3"><a href="#list-stream-methods-3"></a>          input     <span class="ot">=</span> <span class="dt">ListStream</span> <span class="op">$</span> <span class="fu">drop</span> (offset <span class="op">-</span> pstateOffset) (unListStream pstateInput)</span>
<span id="list-stream-methods-4"><a href="#list-stream-methods-4"></a>          repr      <span class="ot">=</span> <span class="kw">if</span> <span class="fu">null</span> input <span class="kw">then</span> <span class="st">&quot;&lt;end of stream&gt;&quot;</span> <span class="kw">else</span> <span class="fu">show</span> (<span class="fu">head</span> <span class="op">$</span> unListStream input)</span>
<span id="list-stream-methods-5"><a href="#list-stream-methods-5"></a>          state&#39;    <span class="ot">=</span> state</span>
<span id="list-stream-methods-6"><a href="#list-stream-methods-6"></a>                    { pstateInput <span class="ot">=</span> input</span>
<span id="list-stream-methods-7"><a href="#list-stream-methods-7"></a>                    , pstateOffset <span class="ot">=</span> offset</span>
<span id="list-stream-methods-8"><a href="#list-stream-methods-8"></a>                    , pstateSourcePos <span class="ot">=</span> sourcePos }</span></code></pre></div>
</div>
<h2 id="text-parser-tokens">Text-parser tokens</h2>
<div class="annotated-code">
<p><span><em>«line-parser»=</em></span></p>
<div class="sourceCode" id="line-parser"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="line-parser-1"><a href="#line-parser-1"></a><span class="kw">type</span> <span class="dt">LineParser</span> <span class="ot">=</span> <span class="dt">Parsec</span> <span class="dt">Void</span> <span class="dt">Text</span></span>
<span id="line-parser-2"><a href="#line-parser-2"></a></span>
<span id="line-parser-3"><a href="#line-parser-3"></a><span class="ot">parseLine ::</span> <span class="dt">LineParser</span> a <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> (a, <span class="dt">Text</span>)</span>
<span id="line-parser-4"><a href="#line-parser-4"></a>parseLine p t <span class="ot">=</span> <span class="fu">either</span> (<span class="fu">const</span> <span class="dt">Nothing</span>) (\x <span class="ot">-&gt;</span> <span class="dt">Just</span> (x, t))</span>
<span id="line-parser-5"><a href="#line-parser-5"></a>              <span class="op">$</span> parse p <span class="st">&quot;&quot;</span> t</span>
<span id="line-parser-6"><a href="#line-parser-6"></a></span>
<span id="line-parser-7"><a href="#line-parser-7"></a><span class="ot">parseLineNot ::</span> <span class="dt">LineParser</span> a <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Text</span></span>
<span id="line-parser-8"><a href="#line-parser-8"></a>parseLineNot p t <span class="ot">=</span> <span class="fu">either</span> (<span class="fu">const</span> <span class="op">$</span> <span class="dt">Just</span> t) (<span class="fu">const</span> <span class="dt">Nothing</span>)</span>
<span id="line-parser-9"><a href="#line-parser-9"></a>                 <span class="op">$</span> parse p <span class="st">&quot;&quot;</span> t</span>
<span id="line-parser-10"><a href="#line-parser-10"></a></span>
<span id="line-parser-11"><a href="#line-parser-11"></a><span class="ot">tokenLine ::</span> ( <span class="dt">MonadParsec</span> e (<span class="dt">ListStream</span> <span class="dt">Text</span>) m )</span>
<span id="line-parser-12"><a href="#line-parser-12"></a>          <span class="ot">=&gt;</span> (<span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a) <span class="ot">-&gt;</span> m a</span>
<span id="line-parser-13"><a href="#line-parser-13"></a>tokenLine f <span class="ot">=</span> token f <span class="fu">mempty</span></span>
<span id="line-parser-14"><a href="#line-parser-14"></a></span>
<span id="line-parser-15"><a href="#line-parser-15"></a><span class="ot">tokenP ::</span> ( <span class="dt">MonadParsec</span> e (<span class="dt">ListStream</span> <span class="dt">Text</span>) m )</span>
<span id="line-parser-16"><a href="#line-parser-16"></a>       <span class="ot">=&gt;</span> <span class="dt">LineParser</span> a <span class="ot">-&gt;</span> m (a, <span class="dt">Text</span>)</span>
<span id="line-parser-17"><a href="#line-parser-17"></a>tokenP <span class="ot">=</span> tokenLine <span class="op">.</span> parseLine</span>
<span id="line-parser-18"><a href="#line-parser-18"></a></span>
<span id="line-parser-19"><a href="#line-parser-19"></a><span class="ot">tokenNotP ::</span> ( <span class="dt">MonadParsec</span> e (<span class="dt">ListStream</span> <span class="dt">Text</span>) m )</span>
<span id="line-parser-20"><a href="#line-parser-20"></a>       <span class="ot">=&gt;</span> <span class="dt">LineParser</span> a <span class="ot">-&gt;</span> m <span class="dt">Text</span></span>
<span id="line-parser-21"><a href="#line-parser-21"></a>tokenNotP <span class="ot">=</span> tokenLine <span class="op">.</span> parseLineNot</span></code></pre></div>
</div>
<h2 id="testing-on-lists">Testing on lists</h2>
<div class="annotated-code">
<p><span><em>«test/ListStreamSpec.hs»=</em></span></p>
<div class="sourceCode" id="cb18" data-file="test/ListStreamSpec.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">module</span> <span class="dt">ListStreamSpec</span> <span class="kw">where</span></span>
<span id="cb18-2"><a href="#cb18-2"></a></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="kw">import</span> <span class="dt">Test.Hspec</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="kw">import</span> <span class="dt">Test.QuickCheck</span></span>
<span id="cb18-5"><a href="#cb18-5"></a></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="kw">import</span> <span class="dt">Data.Void</span></span>
<span id="cb18-8"><a href="#cb18-8"></a></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="kw">import</span> <span class="dt">ListStream</span></span>
<span id="cb18-10"><a href="#cb18-10"></a></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="op">&lt;&lt;</span>list<span class="op">-</span>stream<span class="op">-</span>props<span class="op">&gt;&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12"></a></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="ot">listStreamSpec ::</span> <span class="dt">Spec</span></span>
<span id="cb18-14"><a href="#cb18-14"></a>listStreamSpec <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb18-15"><a href="#cb18-15"></a>    <span class="op">&lt;&lt;</span>list<span class="op">-</span>stream<span class="op">-</span>spec<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<h3 id="lists-of-integers">Lists of integers</h3>
<div class="annotated-code">
<p><span><em>«list-stream-props»=</em></span></p>
<div class="sourceCode" id="list-stream-props"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="list-stream-props-1"><a href="#list-stream-props-1"></a><span class="ot">prop_parser ::</span> (<span class="dt">Eq</span> a) <span class="ot">=&gt;</span> <span class="dt">Parsec</span> e s a <span class="ot">-&gt;</span> s <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="list-stream-props-2"><a href="#list-stream-props-2"></a>prop_parser p input expected <span class="ot">=</span> success (parse p <span class="st">&quot;&quot;</span> input)</span>
<span id="list-stream-props-3"><a href="#list-stream-props-3"></a>    <span class="kw">where</span> success (<span class="dt">Left</span> err) <span class="ot">=</span> <span class="dt">False</span></span>
<span id="list-stream-props-4"><a href="#list-stream-props-4"></a>          success (<span class="dt">Right</span> x) <span class="ot">=</span> x <span class="op">==</span> expected</span>
<span id="list-stream-props-5"><a href="#list-stream-props-5"></a></span>
<span id="list-stream-props-6"><a href="#list-stream-props-6"></a><span class="ot">parseAny ::</span> (<span class="dt">Show</span> a, <span class="dt">Ord</span> a, <span class="dt">Eq</span> a) <span class="ot">=&gt;</span> <span class="dt">Parsec</span> <span class="dt">Void</span> (<span class="dt">ListStream</span> a) [a]</span>
<span id="list-stream-props-7"><a href="#list-stream-props-7"></a>parseAny <span class="ot">=</span> takeWhileP <span class="dt">Nothing</span> (<span class="fu">const</span> <span class="dt">True</span>)</span>
<span id="list-stream-props-8"><a href="#list-stream-props-8"></a></span>
<span id="list-stream-props-9"><a href="#list-stream-props-9"></a><span class="ot">prop_tokens ::</span> [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="list-stream-props-10"><a href="#list-stream-props-10"></a>prop_tokens xs <span class="ot">=</span> prop_parser parseAny (<span class="dt">ListStream</span> xs) xs</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«list-stream-spec»=</em></span></p>
<div class="sourceCode" id="list-stream-spec"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="list-stream-spec-1"><a href="#list-stream-spec-1"></a>describe <span class="st">&quot;Parsing integers&quot;</span> <span class="op">$</span></span>
<span id="list-stream-spec-2"><a href="#list-stream-spec-2"></a>    it <span class="st">&quot;takeWhileP yield input&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="list-stream-spec-3"><a href="#list-stream-spec-3"></a>        property prop_tokens</span></code></pre></div>
</div>
<h1 id="untangling">Untangling</h1>
<div class="annotated-code">
<p><span><em>«src/Stitch.hs»=</em></span></p>
<div class="sourceCode" id="cb19" data-file="src/Stitch.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">module</span> <span class="dt">Stitch</span> <span class="kw">where</span></span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="op">&lt;&lt;</span>stitch<span class="op">-</span>imports<span class="op">&gt;&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="op">&lt;&lt;</span>source<span class="op">-</span>parser<span class="op">&gt;&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="op">&lt;&lt;</span>stitch<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>Untangling starts with reading the top line to identify the file and language. Following that should be one series of referenced code block items.</p>
<p>The result is a list of <code>ReferencePair</code> giving all the content of the code blocks as it is given in the source file. We don’t yet make it a <code>ReferenceMap</code>, since there may be duplicate conflicting entries. In this case we want to get the entry that is different from the one that we already know of.</p>
<div class="annotated-code">
<p><span><em>«source-parser»=</em></span></p>
<div class="sourceCode" id="source-parser"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="source-parser-1"><a href="#source-parser-1"></a><span class="ot">sourceDocument ::</span> ( <span class="dt">MonadParsec</span> e (<span class="dt">ListStream</span> <span class="dt">Text</span>) m</span>
<span id="source-parser-2"><a href="#source-parser-2"></a>                  , <span class="dt">MonadReader</span> <span class="dt">Config</span> m )</span>
<span id="source-parser-3"><a href="#source-parser-3"></a>               <span class="ot">=&gt;</span> m [<span class="dt">ReferencePair</span>]</span>
<span id="source-parser-4"><a href="#source-parser-4"></a>sourceDocument <span class="ot">=</span> <span class="kw">do</span></span>
<span id="source-parser-5"><a href="#source-parser-5"></a>    config <span class="ot">&lt;-</span> ask</span>
<span id="source-parser-6"><a href="#source-parser-6"></a>    (prop, _) <span class="ot">&lt;-</span> tokenP topHeader</span>
<span id="source-parser-7"><a href="#source-parser-7"></a>    lang <span class="ot">&lt;-</span> <span class="fu">maybe</span> (<span class="fu">fail</span> <span class="st">&quot;No valid language found in header.&quot;</span>) <span class="fu">return</span></span>
<span id="source-parser-8"><a href="#source-parser-8"></a>                  <span class="op">$</span> getAttribute prop <span class="st">&quot;language&quot;</span> <span class="op">&gt;&gt;=</span> languageFromName config</span>
<span id="source-parser-9"><a href="#source-parser-9"></a>    (_, refs) <span class="ot">&lt;-</span> <span class="fu">mconcat</span> <span class="op">&lt;$&gt;</span> some (sourceBlock lang)</span>
<span id="source-parser-10"><a href="#source-parser-10"></a>    <span class="fu">return</span> refs</span></code></pre></div>
</div>
<p>A <code>sourceBlock</code> starts with a <em>begin</em> marker, then has many lines of plain source or nested <code>sourceBlock</code>s. Both <code>sourceBlock</code> and <code>sourceLine</code> return pairs of texts and references. The content of these pairs are concatenated. If a <code>sourceBlock</code> is the first in a series (index 0), the noweb reference is generated with the correct indentation.</p>
<div class="annotated-code">
<p><span><em>«source-parser»+</em></span></p>
<div class="sourceCode" id="source-parser"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="source-parser-1"><a href="#source-parser-1"></a><span class="ot">sourceBlock ::</span> ( <span class="dt">MonadParsec</span> e (<span class="dt">ListStream</span> <span class="dt">Text</span>) m )</span>
<span id="source-parser-2"><a href="#source-parser-2"></a>            <span class="ot">=&gt;</span> <span class="dt">Language</span> <span class="ot">-&gt;</span> m ([<span class="dt">Text</span>], [<span class="dt">ReferencePair</span>])</span>
<span id="source-parser-3"><a href="#source-parser-3"></a>sourceBlock lang <span class="ot">=</span> <span class="kw">do</span></span>
<span id="source-parser-4"><a href="#source-parser-4"></a>    ((ref, beginIndent), _) <span class="ot">&lt;-</span> tokenP (commented lang beginBlock)</span>
<span id="source-parser-5"><a href="#source-parser-5"></a>    (<span class="fu">lines</span>, refpairs) <span class="ot">&lt;-</span> <span class="fu">mconcat</span> <span class="op">&lt;$&gt;</span> manyTill </span>
<span id="source-parser-6"><a href="#source-parser-6"></a>                (sourceBlock lang <span class="op">&lt;|&gt;</span> sourceLine)</span>
<span id="source-parser-7"><a href="#source-parser-7"></a>                (tokenP (commented lang endBlock))</span>
<span id="source-parser-8"><a href="#source-parser-8"></a>    <span class="kw">let</span> unindentedLines <span class="ot">=</span> <span class="fu">map</span> (unindent beginIndent) <span class="fu">lines</span></span>
<span id="source-parser-9"><a href="#source-parser-9"></a>    when (<span class="fu">any</span> isNothing unindentedLines) <span class="op">$</span> <span class="fu">fail</span> <span class="st">&quot;Indentation error&quot;</span></span>
<span id="source-parser-10"><a href="#source-parser-10"></a>    <span class="kw">let</span> content <span class="ot">=</span> unlines&#39; <span class="op">$</span> catMaybes unindentedLines</span>
<span id="source-parser-11"><a href="#source-parser-11"></a>    <span class="fu">return</span> ( <span class="kw">if</span> referenceCount ref <span class="op">==</span> <span class="dv">0</span></span>
<span id="source-parser-12"><a href="#source-parser-12"></a>                 <span class="kw">then</span> [(indent beginIndent <span class="op">$</span> showNowebReference <span class="op">$</span> referenceName ref)]</span>
<span id="source-parser-13"><a href="#source-parser-13"></a>                 <span class="kw">else</span> []</span>
<span id="source-parser-14"><a href="#source-parser-14"></a>           , (ref, <span class="dt">CodeBlock</span> (<span class="dt">KnownLanguage</span> lang) [] content)<span class="op">:</span>refpairs )</span>
<span id="source-parser-15"><a href="#source-parser-15"></a></span>
<span id="source-parser-16"><a href="#source-parser-16"></a><span class="ot">sourceLine ::</span> ( <span class="dt">MonadParsec</span> e (<span class="dt">ListStream</span> <span class="dt">Text</span>) m )</span>
<span id="source-parser-17"><a href="#source-parser-17"></a>           <span class="ot">=&gt;</span> m ([<span class="dt">Text</span>], [<span class="dt">ReferencePair</span>])</span>
<span id="source-parser-18"><a href="#source-parser-18"></a>sourceLine <span class="ot">=</span> <span class="kw">do</span></span>
<span id="source-parser-19"><a href="#source-parser-19"></a>    x <span class="ot">&lt;-</span> anySingle</span>
<span id="source-parser-20"><a href="#source-parser-20"></a>    <span class="fu">return</span> ([x], [])</span></code></pre></div>
</div>
<h2 id="the-stitch-function">The <code>stitch</code> function</h2>
<p>In the <code>stitch</code> function we take out the <code>Config</code> from the anonymous <code>MonadReader</code> and put it in a <code>SourceParser</code> monad. This transformation is the <code>asks . runReaderT</code> combo. It seems silly that we can’t “inherit” the outer monad here. I tried turning the transformers around like: <code>ParsecT Void (ListStream Text) m</code>, but type deduction fails on that one.</p>
<div class="annotated-code">
<p><span><em>«stitch»=</em></span></p>
<div class="sourceCode" id="stitch"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="stitch-1"><a href="#stitch-1"></a><span class="kw">type</span> <span class="dt">SourceParser</span> <span class="ot">=</span> <span class="dt">ReaderT</span> <span class="dt">Config</span> (<span class="dt">Parsec</span> <span class="dt">Void</span> (<span class="dt">ListStream</span> <span class="dt">Text</span>))</span>
<span id="stitch-2"><a href="#stitch-2"></a></span>
<span id="stitch-3"><a href="#stitch-3"></a><span class="ot">stitch ::</span> ( <span class="dt">MonadReader</span> <span class="dt">Config</span> m )</span>
<span id="stitch-4"><a href="#stitch-4"></a>         <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="stitch-5"><a href="#stitch-5"></a>         <span class="ot">-&gt;</span> m (<span class="dt">Either</span> <span class="dt">EntangledError</span> [<span class="dt">ReferencePair</span>])</span>
<span id="stitch-6"><a href="#stitch-6"></a>stitch filename text <span class="ot">=</span> <span class="kw">do</span></span>
<span id="stitch-7"><a href="#stitch-7"></a>    p <span class="ot">&lt;-</span> asks <span class="op">$</span> runReaderT (<span class="ot">sourceDocument ::</span> <span class="dt">SourceParser</span> [<span class="dt">ReferencePair</span>])</span>
<span id="stitch-8"><a href="#stitch-8"></a>    <span class="kw">let</span> refs <span class="ot">=</span> parse p filename <span class="op">$</span> <span class="dt">ListStream</span> (T.lines text)</span>
<span id="stitch-9"><a href="#stitch-9"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="fu">either</span> (\e <span class="ot">-&gt;</span> <span class="dt">Left</span> <span class="op">$</span> <span class="dt">StitchError</span> <span class="op">$</span> T.pack <span class="op">$</span> errorBundlePretty e)</span>
<span id="stitch-10"><a href="#stitch-10"></a>                    <span class="dt">Right</span> refs</span></code></pre></div>
</div>
<h2 id="imports">Imports</h2>
<div class="annotated-code">
<p><span><em>«stitch-imports»=</em></span></p>
<div class="sourceCode" id="stitch-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="stitch-imports-1"><a href="#stitch-imports-1"></a><span class="kw">import</span> <span class="dt">ListStream</span> (<span class="dt">ListStream</span>(..), tokenP)</span>
<span id="stitch-imports-2"><a href="#stitch-imports-2"></a><span class="kw">import</span> <span class="dt">Document</span></span>
<span id="stitch-imports-3"><a href="#stitch-imports-3"></a><span class="kw">import</span> <span class="dt">Config</span> (<span class="dt">Config</span>, languageFromName, <span class="dt">Language</span>)</span>
<span id="stitch-imports-4"><a href="#stitch-imports-4"></a><span class="kw">import</span> <span class="dt">Comment</span> (topHeader, beginBlock, endBlock, commented)</span>
<span id="stitch-imports-5"><a href="#stitch-imports-5"></a><span class="kw">import</span> <span class="dt">TextUtil</span> (indent, unindent, unlines&#39;)</span>
<span id="stitch-imports-6"><a href="#stitch-imports-6"></a></span>
<span id="stitch-imports-7"><a href="#stitch-imports-7"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec</span></span>
<span id="stitch-imports-8"><a href="#stitch-imports-8"></a>    ( <span class="dt">MonadParsec</span>, <span class="dt">Parsec</span>, parse, anySingle, manyTill, (<span class="op">&lt;|&gt;</span>)</span>
<span id="stitch-imports-9"><a href="#stitch-imports-9"></a>    , many, some, errorBundlePretty )</span>
<span id="stitch-imports-10"><a href="#stitch-imports-10"></a><span class="kw">import</span> <span class="dt">Data.Void</span> (<span class="dt">Void</span>)</span>
<span id="stitch-imports-11"><a href="#stitch-imports-11"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="stitch-imports-12"><a href="#stitch-imports-12"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Strict</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="stitch-imports-13"><a href="#stitch-imports-13"></a><span class="kw">import</span> <span class="dt">Control.Monad.Reader</span> (<span class="dt">MonadReader</span>, ask, asks, <span class="dt">ReaderT</span>, runReaderT)</span>
<span id="stitch-imports-14"><a href="#stitch-imports-14"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (when)</span>
<span id="stitch-imports-15"><a href="#stitch-imports-15"></a><span class="kw">import</span> <span class="dt">Data.Maybe</span> (isNothing, catMaybes)</span></code></pre></div>
</div>
<h1 id="tangling">Tangling</h1>
<div class="annotated-code">
<p><span><em>«src/Tangle.hs»=</em></span></p>
<div class="sourceCode" id="cb20" data-file="src/Tangle.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">module</span> <span class="dt">Tangle</span> <span class="kw">where</span></span>
<span id="cb20-2"><a href="#cb20-2"></a></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-map&gt;&gt;</span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-lazy-map&gt;&gt;</span>
<span id="cb20-6"><a href="#cb20-6"></a></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-megaparsec&gt;&gt;</span>
<span id="cb20-8"><a href="#cb20-8"></a></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="kw">import</span> <span class="dt">Control.Monad.Reader</span> (<span class="dt">MonadReader</span>, reader, <span class="dt">ReaderT</span>, ask, runReaderT)</span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="kw">import</span> <span class="dt">Control.Monad.State</span> (<span class="dt">MonadState</span>, gets, modify, <span class="dt">StateT</span>, evalStateT)</span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> ((&gt;=&gt;))</span>
<span id="cb20-12"><a href="#cb20-12"></a></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="kw">import</span> <span class="dt">Data.Maybe</span> (catMaybes)</span>
<span id="cb20-14"><a href="#cb20-14"></a></span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="kw">import</span> <span class="dt">ListStream</span> (<span class="dt">ListStream</span> (..))</span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="kw">import</span> <span class="dt">Document</span></span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="kw">import</span> <span class="dt">Config</span> (<span class="dt">Config</span>, lookupLanguage)</span>
<span id="cb20-18"><a href="#cb20-18"></a></span>
<span id="cb20-19"><a href="#cb20-19"></a><span class="op">&lt;&lt;</span>tangle<span class="op">-</span>imports<span class="op">&gt;&gt;</span></span>
<span id="cb20-20"><a href="#cb20-20"></a></span>
<span id="cb20-21"><a href="#cb20-21"></a><span class="op">&lt;&lt;</span>parse<span class="op">-</span>markdown<span class="op">&gt;&gt;</span></span>
<span id="cb20-22"><a href="#cb20-22"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>code<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<p>The task of tangling means:</p>
<ul>
<li>Parse the markdown to a <code>Document</code></li>
<li>Generate annotated source files.</li>
</ul>
<p>Parsing the markdown is done on a line per line basis. We don’t try to parse the markdown itself, rather we try to detect lines that start and end code-blocks.</p>
<p>Remember the golden rule:</p>
<blockquote>
<p>Untangling from a generated source returns the same markdown <strong>to the byte</strong>.</p>
</blockquote>
<p>We will be adding unit tests to check exactly this property.</p>
<h2 id="css-attributes">CSS Attributes</h2>
<p>We’ll reuse the attribute parser later on, so we put it in a separate module.</p>
<div class="annotated-code">
<p><span><em>«tangle-imports»=</em></span></p>
<div class="sourceCode" id="tangle-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="tangle-imports-1"><a href="#tangle-imports-1"></a><span class="kw">import</span> <span class="dt">Attributes</span> (attributes)</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«src/Attributes.hs»=</em></span></p>
<div class="sourceCode" id="cb21" data-file="src/Attributes.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">module</span> <span class="dt">Attributes</span> <span class="kw">where</span></span>
<span id="cb21-2"><a href="#cb21-2"></a></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="op">&lt;&lt;</span>attributes<span class="op">-</span>imports<span class="op">&gt;&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="op">&lt;&lt;</span>parse<span class="op">-</span>attributes<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«attributes-imports»=</em></span></p>
<div class="sourceCode" id="attributes-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="attributes-imports-1"><a href="#attributes-imports-1"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="attributes-imports-2"><a href="#attributes-imports-2"></a><span class="kw">import</span> <span class="dt">Document</span> (<span class="dt">CodeProperty</span>(..))</span>
<span id="attributes-imports-3"><a href="#attributes-imports-3"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec</span></span>
<span id="attributes-imports-4"><a href="#attributes-imports-4"></a>    ( <span class="dt">MonadParsec</span>, takeWhile1P, takeWhileP, chunk, endBy, (<span class="op">&lt;|&gt;</span>) )</span>
<span id="attributes-imports-5"><a href="#attributes-imports-5"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec.Char</span></span>
<span id="attributes-imports-6"><a href="#attributes-imports-6"></a>    ( space )</span></code></pre></div>
</div>
<p>The one function that we will use is the <code>attributes</code> parser.</p>
<div class="annotated-code">
<p><span><em>«parse-attributes»=</em></span></p>
<div class="sourceCode" id="parse-attributes"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-attributes-1"><a href="#parse-attributes-1"></a><span class="ot">attributes ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-attributes-2"><a href="#parse-attributes-2"></a>           <span class="ot">=&gt;</span> m [<span class="dt">CodeProperty</span>]</span>
<span id="parse-attributes-3"><a href="#parse-attributes-3"></a>attributes <span class="ot">=</span> (  codeClass</span>
<span id="parse-attributes-4"><a href="#parse-attributes-4"></a>            <span class="op">&lt;|&gt;</span> codeId</span>
<span id="parse-attributes-5"><a href="#parse-attributes-5"></a>            <span class="op">&lt;|&gt;</span> codeAttribute</span>
<span id="parse-attributes-6"><a href="#parse-attributes-6"></a>             ) <span class="ot">`endBy`</span> space</span></code></pre></div>
</div>
<h4 id="identifiers-and-values">Identifiers and values</h4>
<p>Anything goes, as long as it doesn’t conflict with a space separated curly braces delimited list.</p>
<div class="annotated-code">
<p><span><em>«parse-attributes»+</em></span></p>
<div class="sourceCode" id="parse-attributes"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-attributes-1"><a href="#parse-attributes-1"></a><span class="ot">cssIdentifier ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-attributes-2"><a href="#parse-attributes-2"></a>              <span class="ot">=&gt;</span> m <span class="dt">Text</span></span>
<span id="parse-attributes-3"><a href="#parse-attributes-3"></a>cssIdentifier <span class="ot">=</span> takeWhile1P (<span class="dt">Just</span> <span class="st">&quot;identifier&quot;</span>)</span>
<span id="parse-attributes-4"><a href="#parse-attributes-4"></a>                            (\c <span class="ot">-&gt;</span> <span class="fu">notElem</span> c (<span class="st">&quot; {}=&lt;&gt;&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>))</span>
<span id="parse-attributes-5"><a href="#parse-attributes-5"></a></span>
<span id="parse-attributes-6"><a href="#parse-attributes-6"></a><span class="ot">cssValue ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-attributes-7"><a href="#parse-attributes-7"></a>         <span class="ot">=&gt;</span> m <span class="dt">Text</span></span>
<span id="parse-attributes-8"><a href="#parse-attributes-8"></a>cssValue <span class="ot">=</span> takeWhileP (<span class="dt">Just</span> <span class="st">&quot;value&quot;</span>)</span>
<span id="parse-attributes-9"><a href="#parse-attributes-9"></a>                      (\c <span class="ot">-&gt;</span> <span class="fu">notElem</span> c (<span class="st">&quot; {}=&lt;&gt;&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>))</span></code></pre></div>
</div>
<h4 id="class">class</h4>
<p>A class starts with a period (<code>.</code>), and cannot contain spaces or curly braces.</p>
<div class="annotated-code">
<p><span><em>«parse-attributes»+</em></span></p>
<div class="sourceCode" id="parse-attributes"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-attributes-1"><a href="#parse-attributes-1"></a><span class="ot">codeClass ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-attributes-2"><a href="#parse-attributes-2"></a>          <span class="ot">=&gt;</span> m <span class="dt">CodeProperty</span></span>
<span id="parse-attributes-3"><a href="#parse-attributes-3"></a>codeClass <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-attributes-4"><a href="#parse-attributes-4"></a>    chunk <span class="st">&quot;.&quot;</span></span>
<span id="parse-attributes-5"><a href="#parse-attributes-5"></a>    <span class="dt">CodeClass</span> <span class="op">&lt;$&gt;</span> cssIdentifier</span></code></pre></div>
</div>
<h4 id="id">id</h4>
<p>An id starts with a hash (<code>#</code>), and cannot contain spaces or curly braces.</p>
<div class="annotated-code">
<p><span><em>«parse-attributes»+</em></span></p>
<div class="sourceCode" id="parse-attributes"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-attributes-1"><a href="#parse-attributes-1"></a><span class="ot">codeId ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-attributes-2"><a href="#parse-attributes-2"></a>       <span class="ot">=&gt;</span> m <span class="dt">CodeProperty</span></span>
<span id="parse-attributes-3"><a href="#parse-attributes-3"></a>codeId <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-attributes-4"><a href="#parse-attributes-4"></a>    chunk <span class="st">&quot;#&quot;</span></span>
<span id="parse-attributes-5"><a href="#parse-attributes-5"></a>    <span class="dt">CodeId</span> <span class="op">&lt;$&gt;</span> cssIdentifier</span></code></pre></div>
</div>
<h4 id="attribute">attribute</h4>
<p>An generic attribute is written as key-value-pair, separated by an equals sign (<code>=</code>). Again no spaces or curly braces are allowed inside.</p>
<div class="annotated-code">
<p><span><em>«parse-attributes»+</em></span></p>
<div class="sourceCode" id="parse-attributes"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-attributes-1"><a href="#parse-attributes-1"></a><span class="ot">codeAttribute ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-attributes-2"><a href="#parse-attributes-2"></a>              <span class="ot">=&gt;</span> m <span class="dt">CodeProperty</span></span>
<span id="parse-attributes-3"><a href="#parse-attributes-3"></a>codeAttribute <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-attributes-4"><a href="#parse-attributes-4"></a>    key <span class="ot">&lt;-</span> cssIdentifier</span>
<span id="parse-attributes-5"><a href="#parse-attributes-5"></a>    chunk <span class="st">&quot;=&quot;</span></span>
<span id="parse-attributes-6"><a href="#parse-attributes-6"></a>    value <span class="ot">&lt;-</span> cssValue</span>
<span id="parse-attributes-7"><a href="#parse-attributes-7"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="dt">CodeAttribute</span> key value</span></code></pre></div>
</div>
<h2 id="quasi-parsing-markdown">Quasi-parsing Markdown</h2>
<p>Parsing the markdown using MegaParsec,</p>
<h3 id="parsing-code-blocks">Parsing code blocks</h3>
<div class="TODO">
<p>Add Wirth Syntax Notation with all the parsers.</p>
</div>
<p>Code blocks are delimited with three back-quotes, and again closed with three back-quotes. Pandoc allows for any number larger than three, and using other symbols like tildes. The only form Entangled reacts to is the following <strong>unindented</strong> template:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb22-1"><a href="#cb22-1"></a> <span class="bn">``` {[#&lt;reference&gt;|.&lt;language&gt;|&lt;key&gt;=&lt;value&gt;] ...}</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="bn"> &lt;code&gt; ...</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="bn"> ```</span></span></code></pre></div>
<p>Any code block is one of the following:</p>
<ul>
<li>A <strong>referable</strong> block: has exactly one <strong>reference id</strong> (<code>#&lt;reference&gt;</code>) and exactly one class giving the <strong>language</strong> of the code block (<code>.&lt;language&gt;</code>). Example:</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1"></a> <span class="bn">``` {.rust #hello-rust}</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="bn"> println!(&quot;Hello, Rust!&quot;);</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="bn"> ```</span></span></code></pre></div>
<ul>
<li>A <strong>file</strong> block: has a key-value pair giving the path to the file (<code>file=&lt;path&gt;</code>), absolute or relative to the directory in which <code>entangled</code> runs. Again, there should be exactly one class giving the <strong>language</strong> of the block (<code>.&lt;language&gt;</code>). Example:</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1"></a> <span class="bn">``` {.rust #main-function file=src/main.rs}</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="bn"> fn main() {</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="bn">    &lt;&lt;hello-rust&gt;&gt;</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="bn"> }</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="bn"> ```</span></span></code></pre></div>
<ul>
<li>An <strong>ignored</strong> block: anything not matching the previous two.</li>
</ul>
<h3 id="parsing-single-lines">Parsing single lines</h3>
<p>Written using parser combinators.</p>
<div class="annotated-code">
<p><span><em>«parse-markdown»=</em></span></p>
<div class="sourceCode" id="parse-markdown"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-markdown-1"><a href="#parse-markdown-1"></a><span class="ot">codeHeader ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-markdown-2"><a href="#parse-markdown-2"></a>           <span class="ot">=&gt;</span> m [<span class="dt">CodeProperty</span>]</span>
<span id="parse-markdown-3"><a href="#parse-markdown-3"></a>codeHeader <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-markdown-4"><a href="#parse-markdown-4"></a>    chunk <span class="st">&quot;```&quot;</span> <span class="op">&gt;&gt;</span> space <span class="op">&gt;&gt;</span> chunk <span class="st">&quot;{&quot;</span> <span class="op">&gt;&gt;</span> space</span>
<span id="parse-markdown-5"><a href="#parse-markdown-5"></a>    props <span class="ot">&lt;-</span> attributes</span>
<span id="parse-markdown-6"><a href="#parse-markdown-6"></a>    chunk <span class="st">&quot;}&quot;</span> <span class="op">&gt;&gt;</span> space <span class="op">&gt;&gt;</span> eof</span>
<span id="parse-markdown-7"><a href="#parse-markdown-7"></a>    <span class="fu">return</span> props </span>
<span id="parse-markdown-8"><a href="#parse-markdown-8"></a></span>
<span id="parse-markdown-9"><a href="#parse-markdown-9"></a><span class="ot">codeFooter ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-markdown-10"><a href="#parse-markdown-10"></a>           <span class="ot">=&gt;</span> m ()</span>
<span id="parse-markdown-11"><a href="#parse-markdown-11"></a>codeFooter <span class="ot">=</span> chunk <span class="st">&quot;```&quot;</span> <span class="op">&gt;&gt;</span> space <span class="op">&gt;&gt;</span> eof</span></code></pre></div>
</div>
<h3 id="extracting-data-from-a-list-of-codeproperty">Extracting data from a list of <code>CodeProperty</code></h3>
<p>In case the language is not given, or is misspelled, the system should be aware of that, so we can give an error message or warning.</p>
<div class="annotated-code">
<p><span><em>«parse-markdown»+</em></span></p>
<div class="sourceCode" id="parse-markdown"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-markdown-1"><a href="#parse-markdown-1"></a><span class="ot">getLanguage ::</span> ( <span class="dt">MonadReader</span> <span class="dt">Config</span> m )</span>
<span id="parse-markdown-2"><a href="#parse-markdown-2"></a>            <span class="ot">=&gt;</span> [<span class="dt">CodeProperty</span>] <span class="ot">-&gt;</span> m <span class="dt">ProgrammingLanguage</span></span>
<span id="parse-markdown-3"><a href="#parse-markdown-3"></a>getLanguage [] <span class="ot">=</span> <span class="fu">return</span> <span class="dt">NoLanguage</span></span>
<span id="parse-markdown-4"><a href="#parse-markdown-4"></a>getLanguage (<span class="dt">CodeClass</span> cls <span class="op">:</span> _)</span>
<span id="parse-markdown-5"><a href="#parse-markdown-5"></a>    <span class="ot">=</span> <span class="fu">maybe</span> (<span class="dt">UnknownClass</span> cls) </span>
<span id="parse-markdown-6"><a href="#parse-markdown-6"></a>            <span class="dt">KnownLanguage</span></span>
<span id="parse-markdown-7"><a href="#parse-markdown-7"></a>            <span class="op">&lt;$&gt;</span> reader (\cfg <span class="ot">-&gt;</span> lookupLanguage cfg cls)</span>
<span id="parse-markdown-8"><a href="#parse-markdown-8"></a>getLanguage (_ <span class="op">:</span> xs) <span class="ot">=</span> getLanguage xs</span></code></pre></div>
</div>
<p>On the other hand, if an identifyer is left out, the parser should fail, so that the code-block is included as normal markdown. If only a file attribute is given, the filename is also the identifyer. If an id is also given, that takes precedence. We use a <code>StateT ReferenceCount</code> to keep track of the number of references with the same name, so that we can concatenate these code blocks in order.</p>
<div class="annotated-code">
<p><span><em>«parse-markdown»+</em></span></p>
<div class="sourceCode" id="parse-markdown"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-markdown-1"><a href="#parse-markdown-1"></a><span class="ot">getReference ::</span> ( <span class="dt">MonadState</span> <span class="dt">ReferenceCount</span> m )</span>
<span id="parse-markdown-2"><a href="#parse-markdown-2"></a>             <span class="ot">=&gt;</span> [<span class="dt">CodeProperty</span>] <span class="ot">-&gt;</span> m (<span class="dt">Maybe</span> <span class="dt">ReferenceId</span>)</span>
<span id="parse-markdown-3"><a href="#parse-markdown-3"></a>getReference [] <span class="ot">=</span> <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="parse-markdown-4"><a href="#parse-markdown-4"></a>getReference (<span class="dt">CodeId</span> x<span class="op">:</span>_) <span class="ot">=</span> <span class="dt">Just</span> <span class="op">&lt;$&gt;</span> newReference (<span class="dt">ReferenceName</span> x)</span>
<span id="parse-markdown-5"><a href="#parse-markdown-5"></a>getReference (<span class="dt">CodeAttribute</span> k v<span class="op">:</span>xs)</span>
<span id="parse-markdown-6"><a href="#parse-markdown-6"></a>    <span class="op">|</span> k <span class="op">==</span> <span class="st">&quot;file&quot;</span> <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-markdown-7"><a href="#parse-markdown-7"></a>        a <span class="ot">&lt;-</span> getReference xs</span>
<span id="parse-markdown-8"><a href="#parse-markdown-8"></a>        b <span class="ot">&lt;-</span> <span class="dt">Just</span> <span class="op">&lt;$&gt;</span> newReference (<span class="dt">ReferenceName</span> v)</span>
<span id="parse-markdown-9"><a href="#parse-markdown-9"></a>        <span class="fu">return</span> <span class="op">$</span> a <span class="op">&lt;|&gt;</span> b</span>
<span id="parse-markdown-10"><a href="#parse-markdown-10"></a>    <span class="op">|</span> <span class="fu">otherwise</span>   <span class="ot">=</span> getReference xs</span>
<span id="parse-markdown-11"><a href="#parse-markdown-11"></a>getReference (_<span class="op">:</span>xs) <span class="ot">=</span> getReference xs</span></code></pre></div>
</div>
<p>We keep a separate <code>Map</code> to link certain references with top-level files.</p>
<div class="annotated-code">
<p><span><em>«parse-markdown»+</em></span></p>
<div class="sourceCode" id="parse-markdown"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-markdown-1"><a href="#parse-markdown-1"></a><span class="ot">getFilePath ::</span> [<span class="dt">CodeProperty</span>] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">FilePath</span></span>
<span id="parse-markdown-2"><a href="#parse-markdown-2"></a>getFilePath [] <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="parse-markdown-3"><a href="#parse-markdown-3"></a>getFilePath (<span class="dt">CodeAttribute</span> k v<span class="op">:</span>xs)</span>
<span id="parse-markdown-4"><a href="#parse-markdown-4"></a>    <span class="op">|</span> k <span class="op">==</span> <span class="st">&quot;file&quot;</span> <span class="ot">=</span> <span class="dt">Just</span> <span class="op">$</span> T.unpack v</span>
<span id="parse-markdown-5"><a href="#parse-markdown-5"></a>    <span class="op">|</span> <span class="fu">otherwise</span>   <span class="ot">=</span> getFilePath xs</span>
<span id="parse-markdown-6"><a href="#parse-markdown-6"></a>getFilePath (_<span class="op">:</span>xs) <span class="ot">=</span> getFilePath xs</span>
<span id="parse-markdown-7"><a href="#parse-markdown-7"></a></span>
<span id="parse-markdown-8"><a href="#parse-markdown-8"></a><span class="ot">getFileMap ::</span> [<span class="dt">ReferencePair</span>] <span class="ot">-&gt;</span> <span class="dt">FileMap</span></span>
<span id="parse-markdown-9"><a href="#parse-markdown-9"></a>getFileMap <span class="ot">=</span> M.fromList <span class="op">.</span> catMaybes <span class="op">.</span> <span class="fu">map</span> filePair</span>
<span id="parse-markdown-10"><a href="#parse-markdown-10"></a>    <span class="kw">where</span> filePair (ref, <span class="dt">CodeBlock</span>{<span class="op">..</span>}) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-markdown-11"><a href="#parse-markdown-11"></a>              path <span class="ot">&lt;-</span> getFilePath <span class="op">$</span> codeProperties</span>
<span id="parse-markdown-12"><a href="#parse-markdown-12"></a>              <span class="kw">case</span> codeLanguage <span class="kw">of</span></span>
<span id="parse-markdown-13"><a href="#parse-markdown-13"></a>                  <span class="dt">KnownLanguage</span> _ <span class="ot">-&gt;</span> <span class="fu">return</span> (path, referenceName ref)</span>
<span id="parse-markdown-14"><a href="#parse-markdown-14"></a>                  _               <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span></code></pre></div>
</div>
<h3 id="references-1">References</h3>
<p>To build up the <code>ReferenceMap</code> we define <code>ReferenceCount</code>.</p>
<div class="annotated-code">
<p><span><em>«parse-markdown»+</em></span></p>
<div class="sourceCode" id="parse-markdown"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-markdown-1"><a href="#parse-markdown-1"></a><span class="kw">type</span> <span class="dt">ReferenceCount</span> <span class="ot">=</span> <span class="dt">Map</span> <span class="dt">ReferenceName</span> <span class="dt">Int</span></span>
<span id="parse-markdown-2"><a href="#parse-markdown-2"></a></span>
<span id="parse-markdown-3"><a href="#parse-markdown-3"></a><span class="ot">countReference ::</span> ( <span class="dt">MonadState</span> <span class="dt">ReferenceCount</span> m )</span>
<span id="parse-markdown-4"><a href="#parse-markdown-4"></a>               <span class="ot">=&gt;</span> <span class="dt">ReferenceName</span> <span class="ot">-&gt;</span> m <span class="dt">Int</span></span>
<span id="parse-markdown-5"><a href="#parse-markdown-5"></a>countReference r <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-markdown-6"><a href="#parse-markdown-6"></a>    x <span class="ot">&lt;-</span> gets (M.findWithDefault <span class="dv">0</span> r)</span>
<span id="parse-markdown-7"><a href="#parse-markdown-7"></a>    modify (M.insert r (x <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="parse-markdown-8"><a href="#parse-markdown-8"></a>    <span class="fu">return</span> x</span>
<span id="parse-markdown-9"><a href="#parse-markdown-9"></a></span>
<span id="parse-markdown-10"><a href="#parse-markdown-10"></a><span class="ot">newReference ::</span> ( <span class="dt">MonadState</span> <span class="dt">ReferenceCount</span> m )</span>
<span id="parse-markdown-11"><a href="#parse-markdown-11"></a>             <span class="ot">=&gt;</span> <span class="dt">ReferenceName</span> <span class="ot">-&gt;</span> m <span class="dt">ReferenceId</span></span>
<span id="parse-markdown-12"><a href="#parse-markdown-12"></a>newReference n <span class="ot">=</span> <span class="dt">ReferenceId</span> n <span class="op">&lt;$&gt;</span> countReference n</span></code></pre></div>
</div>
<h3 id="parsing-the-document">Parsing the document</h3>
<div class="TODO">
<p>Add Wirth Syntax Notation with all the parsers.</p>
</div>
<p>Using these two parsers, we can create a larger parser that works on a line-by-line basis. We define several helpers to create a parser for <code>ListStream Text</code> using single line parsers for <code>Text</code>.</p>
<div class="annotated-code">
<p><span><em>«tangle-imports»+</em></span></p>
<div class="sourceCode" id="tangle-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="tangle-imports-1"><a href="#tangle-imports-1"></a><span class="kw">import</span> <span class="dt">ListStream</span> (parseLine, parseLineNot, tokenLine)</span></code></pre></div>
</div>
<p>To parse markdown, we first try to parse a code block (as given above), stored in <code>CodeBlock</code>. If that fails lines are interpreted as other markdown, and stored in <code>PlainText</code>.</p>
<div class="annotated-code">
<p><span><em>«parse-markdown»+</em></span></p>
<div class="sourceCode" id="parse-markdown"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-markdown-1"><a href="#parse-markdown-1"></a><span class="kw">type</span> <span class="dt">DocumentParser</span> <span class="ot">=</span> <span class="dt">ReaderT</span> <span class="dt">Config</span> (<span class="dt">StateT</span> <span class="dt">ReferenceCount</span> (<span class="dt">Parsec</span> <span class="dt">Void</span> (<span class="dt">ListStream</span> <span class="dt">Text</span>)))</span>
<span id="parse-markdown-2"><a href="#parse-markdown-2"></a></span>
<span id="parse-markdown-3"><a href="#parse-markdown-3"></a><span class="ot">codeBlock ::</span> ( <span class="dt">MonadParsec</span> e (<span class="dt">ListStream</span> <span class="dt">Text</span>) m</span>
<span id="parse-markdown-4"><a href="#parse-markdown-4"></a>             , <span class="dt">MonadReader</span> <span class="dt">Config</span> m </span>
<span id="parse-markdown-5"><a href="#parse-markdown-5"></a>             , <span class="dt">MonadState</span> <span class="dt">ReferenceCount</span> m )</span>
<span id="parse-markdown-6"><a href="#parse-markdown-6"></a>          <span class="ot">=&gt;</span> m ([<span class="dt">Content</span>], [<span class="dt">ReferencePair</span>])</span>
<span id="parse-markdown-7"><a href="#parse-markdown-7"></a>codeBlock <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-markdown-8"><a href="#parse-markdown-8"></a>    (props, begin) <span class="ot">&lt;-</span> tokenLine (parseLine codeHeader)</span>
<span id="parse-markdown-9"><a href="#parse-markdown-9"></a>    code           <span class="ot">&lt;-</span> unlines&#39; </span>
<span id="parse-markdown-10"><a href="#parse-markdown-10"></a>                   <span class="op">&lt;$&gt;</span> manyTill (anySingle <span class="op">&lt;?&gt;</span> <span class="st">&quot;code line&quot;</span>)</span>
<span id="parse-markdown-11"><a href="#parse-markdown-11"></a>                                (try <span class="op">$</span> lookAhead <span class="op">$</span> tokenLine (parseLine codeFooter))</span>
<span id="parse-markdown-12"><a href="#parse-markdown-12"></a>    (_, end)       <span class="ot">&lt;-</span> tokenLine (parseLine codeFooter)</span>
<span id="parse-markdown-13"><a href="#parse-markdown-13"></a>    language       <span class="ot">&lt;-</span> getLanguage props</span>
<span id="parse-markdown-14"><a href="#parse-markdown-14"></a>    ref&#39;           <span class="ot">&lt;-</span> getReference props</span>
<span id="parse-markdown-15"><a href="#parse-markdown-15"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="kw">case</span> ref&#39; <span class="kw">of</span></span>
<span id="parse-markdown-16"><a href="#parse-markdown-16"></a>        <span class="dt">Nothing</span>  <span class="ot">-&gt;</span> ( [ <span class="dt">PlainText</span> <span class="op">$</span> unlines&#39; [begin, code, end] ], [] )</span>
<span id="parse-markdown-17"><a href="#parse-markdown-17"></a>        <span class="dt">Just</span> ref <span class="ot">-&gt;</span> ( [ <span class="dt">PlainText</span> begin, <span class="dt">Reference</span> ref, <span class="dt">PlainText</span> end ]</span>
<span id="parse-markdown-18"><a href="#parse-markdown-18"></a>                    , [ ( ref, <span class="dt">CodeBlock</span> language props code ) ] )</span>
<span id="parse-markdown-19"><a href="#parse-markdown-19"></a></span>
<span id="parse-markdown-20"><a href="#parse-markdown-20"></a><span class="ot">normalText ::</span> ( <span class="dt">MonadParsec</span> e (<span class="dt">ListStream</span> <span class="dt">Text</span>) m )</span>
<span id="parse-markdown-21"><a href="#parse-markdown-21"></a>           <span class="ot">=&gt;</span> m ([<span class="dt">Content</span>], [<span class="dt">ReferencePair</span>])</span>
<span id="parse-markdown-22"><a href="#parse-markdown-22"></a>normalText <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-markdown-23"><a href="#parse-markdown-23"></a>    text <span class="ot">&lt;-</span> unlines&#39; <span class="op">&lt;$&gt;</span> some (tokenLine (parseLineNot codeHeader))</span>
<span id="parse-markdown-24"><a href="#parse-markdown-24"></a>    <span class="fu">return</span> ( [ <span class="dt">PlainText</span> text ], [] )</span>
<span id="parse-markdown-25"><a href="#parse-markdown-25"></a></span>
<span id="parse-markdown-26"><a href="#parse-markdown-26"></a><span class="ot">markdown ::</span> <span class="dt">DocumentParser</span> ([<span class="dt">Content</span>], [<span class="dt">ReferencePair</span>])</span>
<span id="parse-markdown-27"><a href="#parse-markdown-27"></a>markdown <span class="ot">=</span> <span class="fu">mconcat</span> <span class="op">&lt;$&gt;</span> many (codeBlock <span class="op">&lt;|&gt;</span> normalText)</span>
<span id="parse-markdown-28"><a href="#parse-markdown-28"></a></span>
<span id="parse-markdown-29"><a href="#parse-markdown-29"></a><span class="ot">parseMarkdown ::</span> ( <span class="dt">MonadReader</span> <span class="dt">Config</span> m )</span>
<span id="parse-markdown-30"><a href="#parse-markdown-30"></a>              <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> m (<span class="dt">Either</span> <span class="dt">EntangledError</span> <span class="dt">Document</span>)</span>
<span id="parse-markdown-31"><a href="#parse-markdown-31"></a>parseMarkdown f t <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-markdown-32"><a href="#parse-markdown-32"></a>    cfg <span class="ot">&lt;-</span> ask</span>
<span id="parse-markdown-33"><a href="#parse-markdown-33"></a>    <span class="kw">let</span> result&#39; <span class="ot">=</span> parse (evalStateT (runReaderT markdown cfg) <span class="fu">mempty</span>)</span>
<span id="parse-markdown-34"><a href="#parse-markdown-34"></a>                        f (<span class="dt">ListStream</span> <span class="op">$</span> T.lines t)</span>
<span id="parse-markdown-35"><a href="#parse-markdown-35"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="kw">case</span> result&#39; <span class="kw">of</span></span>
<span id="parse-markdown-36"><a href="#parse-markdown-36"></a>        <span class="dt">Left</span> err              <span class="ot">-&gt;</span> <span class="dt">Left</span> (<span class="dt">TangleError</span> <span class="op">$</span> T.pack <span class="op">$</span> <span class="fu">show</span> err)</span>
<span id="parse-markdown-37"><a href="#parse-markdown-37"></a>        <span class="dt">Right</span> (content, refs) <span class="ot">-&gt;</span> <span class="dt">Right</span> <span class="op">$</span></span>
<span id="parse-markdown-38"><a href="#parse-markdown-38"></a>            <span class="dt">Document</span> (M.fromList refs)</span>
<span id="parse-markdown-39"><a href="#parse-markdown-39"></a>                     content</span>
<span id="parse-markdown-40"><a href="#parse-markdown-40"></a>                     (getFileMap refs)</span></code></pre></div>
</div>
<h2 id="generating-output-files">Generating output files</h2>
<h3 id="indentation">Indentation</h3>
<p>Tangling is indentation sensitive. Given two code blocks</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb25-1"><a href="#cb25-1"></a> <span class="bn">``` {.python #multiply}</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="bn"> x *= i</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="bn"> ```</span></span>
<span id="cb25-4"><a href="#cb25-4"></a></span>
<span id="cb25-5"><a href="#cb25-5"></a> <span class="bn">``` {.python #factorial}</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="bn"> x = 1</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="bn"> for i in range(n):</span></span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="bn">    &lt;&lt;multiply&gt;&gt;</span></span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="bn"> ```</span></span></code></pre></div>
<p>We should get the code</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a>x <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb26-3"><a href="#cb26-3"></a>    x <span class="op">*=</span> i</span></code></pre></div>
<p>Indentation is done by <code>lines</code> <span class="math inline">\(\to\)</span> <code>map (append indent)</code> <span class="math inline">\(\to\)</span> <code>unlines</code>, with the distinction that empty lines are not indented, and that the inverse of <code>lines</code> is <code>unlines'</code>, which doesn’t append a final newline.</p>
<div class="annotated-code">
<p><span><em>«tangle-imports»+</em></span></p>
<div class="sourceCode" id="tangle-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="tangle-imports-1"><a href="#tangle-imports-1"></a><span class="kw">import</span> <span class="dt">TextUtil</span> (indent, unlines&#39;)</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«generate-code»=</em></span></p>
<div class="sourceCode" id="generate-code"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="generate-code-1"><a href="#generate-code-1"></a><span class="kw">data</span> <span class="dt">CodeLine</span> <span class="ot">=</span> <span class="dt">PlainCode</span> <span class="dt">Text</span></span>
<span id="generate-code-2"><a href="#generate-code-2"></a>              <span class="op">|</span> <span class="dt">NowebReference</span> <span class="dt">ReferenceName</span> <span class="dt">Text</span></span>
<span id="generate-code-3"><a href="#generate-code-3"></a>              <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>)</span>
<span id="generate-code-4"><a href="#generate-code-4"></a></span>
<span id="generate-code-5"><a href="#generate-code-5"></a><span class="kw">type</span> <span class="dt">CodeParser</span> <span class="ot">=</span> <span class="dt">Parsec</span> <span class="dt">Void</span> <span class="dt">Text</span></span></code></pre></div>
</div>
<p>We try to parse every line in a code block as a <em>noweb</em> reference. If that fails, the line is accepted as normal source text. A <em>noweb</em> reference should stand alone on a line, maybe indented with white space. Space at the end of the line is ignored.</p>
<pre><code>+--- indentation ---+--- reference  ----+--- possible space ---+
                    &lt;&lt;no-spaces-alowed&gt;&gt;</code></pre>
<p>The function <code>parseCode</code> takes the <code>Text</code> from a code block and generates a list of <code>CodeLine</code>, being either <code>PlainCode</code> or <code>NowebReference</code>.</p>
<div class="annotated-code">
<p><span><em>«generate-code»+</em></span></p>
<div class="sourceCode" id="generate-code"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="generate-code-1"><a href="#generate-code-1"></a><span class="ot">nowebReference ::</span> <span class="dt">CodeParser</span> <span class="dt">CodeLine</span></span>
<span id="generate-code-2"><a href="#generate-code-2"></a>nowebReference <span class="ot">=</span> <span class="kw">do</span></span>
<span id="generate-code-3"><a href="#generate-code-3"></a>    indent <span class="ot">&lt;-</span> takeWhileP <span class="dt">Nothing</span> (<span class="ot">`elem`</span> (<span class="st">&quot; \t&quot;</span><span class="ot"> ::</span> [<span class="dt">Char</span>]))</span>
<span id="generate-code-4"><a href="#generate-code-4"></a>    chunk <span class="st">&quot;&lt;&lt;&quot;</span></span>
<span id="generate-code-5"><a href="#generate-code-5"></a>    <span class="fu">id</span> <span class="ot">&lt;-</span> takeWhile1P <span class="dt">Nothing</span> (<span class="ot">`notElem`</span> (<span class="st">&quot; \t&lt;&gt;&quot;</span><span class="ot"> ::</span> [<span class="dt">Char</span>]))</span>
<span id="generate-code-6"><a href="#generate-code-6"></a>    chunk <span class="st">&quot;&gt;&gt;&quot;</span></span>
<span id="generate-code-7"><a href="#generate-code-7"></a>    space <span class="op">&gt;&gt;</span> eof</span>
<span id="generate-code-8"><a href="#generate-code-8"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="dt">NowebReference</span> (<span class="dt">ReferenceName</span> <span class="fu">id</span>) indent</span>
<span id="generate-code-9"><a href="#generate-code-9"></a></span>
<span id="generate-code-10"><a href="#generate-code-10"></a><span class="ot">parseCode ::</span> <span class="dt">ReferenceName</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> [<span class="dt">CodeLine</span>]</span>
<span id="generate-code-11"><a href="#generate-code-11"></a>parseCode name <span class="ot">=</span> <span class="fu">map</span> parseLine <span class="op">.</span> T.lines</span>
<span id="generate-code-12"><a href="#generate-code-12"></a>    <span class="kw">where</span> parseLine l <span class="ot">=</span> <span class="fu">either</span> (<span class="fu">const</span> <span class="op">$</span> <span class="dt">PlainCode</span> l) <span class="fu">id</span></span>
<span id="generate-code-13"><a href="#generate-code-13"></a>                      <span class="op">$</span> parse nowebReference</span>
<span id="generate-code-14"><a href="#generate-code-14"></a>                              (T.unpack <span class="op">$</span> unReferenceName name)</span>
<span id="generate-code-15"><a href="#generate-code-15"></a>                              l</span></code></pre></div>
</div>
<h2 id="code-expansion">Code expansion</h2>
<p>We don’t want code blocks refering to themselves. I used to keep a history of visited <code>ReferenceId</code>s to prevent circular dependencies. This part will be moved to a validation stage. I now use a lazy map to provide the recursion, which becomes cumbersome if we also have to detect cycles in the dependency graph.</p>
<div class="annotated-code">
<p><span><em>«generate-code»+</em></span></p>
<div class="sourceCode" id="generate-code"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="generate-code-1"><a href="#generate-code-1"></a><span class="kw">type</span> <span class="dt">ExpandedCode</span> <span class="ot">=</span> <span class="dt">LM.Map</span> <span class="dt">ReferenceName</span> (<span class="dt">Either</span> <span class="dt">EntangledError</span> <span class="dt">Text</span>)</span>
<span id="generate-code-2"><a href="#generate-code-2"></a><span class="kw">type</span> <span class="dt">Annotator</span> <span class="ot">=</span> <span class="dt">ReferenceMap</span> <span class="ot">-&gt;</span> <span class="dt">ReferenceId</span> <span class="ot">-&gt;</span> (<span class="dt">Either</span> <span class="dt">EntangledError</span> <span class="dt">Text</span>)</span></code></pre></div>
</div>
<p>The map of expanded code blocks is generated using an induction pattern here illustrated on lists. Suppose we already have the resulting <code>output</code> and a function <code>g :: [Output] -&gt; Input -&gt; Output</code> that generates any element in <code>output</code> given an input and the rest of all <code>output</code>, then <code>f</code> generates <code>output</code> as follows.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1"></a><span class="ot">f ::</span> [<span class="dt">Input</span>] <span class="ot">-&gt;</span> [<span class="dt">Output</span>]</span>
<span id="cb28-2"><a href="#cb28-2"></a>f input <span class="ot">=</span> output</span>
<span id="cb28-3"><a href="#cb28-3"></a>    <span class="kw">where</span> output <span class="ot">=</span> <span class="fu">map</span> generate input</span>
<span id="cb28-4"><a href="#cb28-4"></a>          generate <span class="ot">=</span> g output</span></code></pre></div>
<p>Lazy evaluation does the rest.</p>
<div class="annotated-code">
<p><span><em>«generate-code»+</em></span></p>
<div class="sourceCode" id="generate-code"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="generate-code-1"><a href="#generate-code-1"></a><span class="ot">expandedCode ::</span> <span class="dt">Annotator</span> <span class="ot">-&gt;</span> <span class="dt">ReferenceMap</span> <span class="ot">-&gt;</span> <span class="dt">ExpandedCode</span></span>
<span id="generate-code-2"><a href="#generate-code-2"></a>expandedCode annotate refs <span class="ot">=</span> result</span>
<span id="generate-code-3"><a href="#generate-code-3"></a>    <span class="kw">where</span> result <span class="ot">=</span> LM.fromSet expand (referenceNames refs)</span>
<span id="generate-code-4"><a href="#generate-code-4"></a>          expand name <span class="ot">=</span> unlines&#39; <span class="op">&lt;$&gt;</span> (<span class="fu">sequence</span></span>
<span id="generate-code-5"><a href="#generate-code-5"></a>                        <span class="op">$</span> <span class="fu">map</span> (annotate refs <span class="op">&gt;=&gt;</span> expandCodeSource result name)</span>
<span id="generate-code-6"><a href="#generate-code-6"></a>                        <span class="op">$</span> referencesByName refs name)</span>
<span id="generate-code-7"><a href="#generate-code-7"></a></span>
<span id="generate-code-8"><a href="#generate-code-8"></a><span class="ot">expandCodeSource ::</span> <span class="dt">ExpandedCode</span> <span class="ot">-&gt;</span> <span class="dt">ReferenceName</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="generate-code-9"><a href="#generate-code-9"></a>                 <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">EntangledError</span> <span class="dt">Text</span></span>
<span id="generate-code-10"><a href="#generate-code-10"></a>expandCodeSource result name t</span>
<span id="generate-code-11"><a href="#generate-code-11"></a>    <span class="ot">=</span> unlines&#39; <span class="op">&lt;$&gt;</span> <span class="fu">sequence</span> (<span class="fu">map</span> codeLineToText <span class="op">$</span> parseCode name t)</span>
<span id="generate-code-12"><a href="#generate-code-12"></a>    <span class="kw">where</span> codeLineToText (<span class="dt">PlainCode</span> x) <span class="ot">=</span> <span class="dt">Right</span> x</span>
<span id="generate-code-13"><a href="#generate-code-13"></a>          codeLineToText (<span class="dt">NowebReference</span> name i)</span>
<span id="generate-code-14"><a href="#generate-code-14"></a>              <span class="ot">=</span> indent i <span class="op">&lt;$&gt;</span> result <span class="op">LM.!</span> name</span></code></pre></div>
</div>
<p>We have two types of annotators:</p>
<ul>
<li>Naked annotator: creates the output code without annotation. From such an expansion it is not possible to untangle.</li>
</ul>
<div class="annotated-code">
<p><span><em>«generate-code»+</em></span></p>
<div class="sourceCode" id="generate-code"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="generate-code-1"><a href="#generate-code-1"></a><span class="ot">annotateNaked ::</span> <span class="dt">ReferenceMap</span> <span class="ot">-&gt;</span> <span class="dt">ReferenceId</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">EntangledError</span> <span class="dt">Text</span></span>
<span id="generate-code-2"><a href="#generate-code-2"></a>annotateNaked refs ref <span class="ot">=</span> <span class="dt">Right</span> <span class="op">$</span> codeSource <span class="op">$</span> refs <span class="op">M.!</span> ref</span></code></pre></div>
</div>
<ul>
<li>Commenting annotator: adds annotations in comments, from which we can locate the original code block.</li>
</ul>
<p>We put comments in a separate module, where we also address parsing back the generated comments.</p>
<div class="annotated-code">
<p><span><em>«tangle-imports»+</em></span></p>
<div class="sourceCode" id="tangle-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="tangle-imports-1"><a href="#tangle-imports-1"></a><span class="co">-- import Comment (annotateComment)</span></span></code></pre></div>
</div>
<h2 id="entangled-comments">Entangled comments</h2>
<div class="annotated-code">
<p><span><em>«src/Comment.hs»=</em></span></p>
<div class="sourceCode" id="cb29" data-file="src/Comment.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw">module</span> <span class="dt">Comment</span> <span class="kw">where</span></span>
<span id="cb29-2"><a href="#cb29-2"></a></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="op">&lt;&lt;</span>comment<span class="op">-</span>imports<span class="op">&gt;&gt;</span></span>
<span id="cb29-4"><a href="#cb29-4"></a></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="op">&lt;&lt;</span>generate<span class="op">-</span>comment<span class="op">&gt;&gt;</span></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="op">&lt;&lt;</span>parse<span class="op">-</span>comment<span class="op">&gt;&gt;</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«comment-imports»=</em></span></p>
<div class="sourceCode" id="comment-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="comment-imports-1"><a href="#comment-imports-1"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span></code></pre></div>
</div>
<p>Tangled files start with a single line header comment, followed by nested blocks of (possibly indented) code delimeted by lines:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb30-1"><a href="#cb30-1"></a>\\ -#- entangled -#- begin &lt;&lt;reference-name&gt;&gt;[<span class="dv">3</span>]</span>
<span id="cb30-2"><a href="#cb30-2"></a>code content;</span>
<span id="cb30-3"><a href="#cb30-3"></a>\\ -#- entangled -#- end</span></code></pre></div>
<p>The <code>-#- entangled -#-</code> bit is stored in <code>delim</code>.</p>
<div class="annotated-code">
<p><span><em>«generate-comment»=</em></span></p>
<div class="sourceCode" id="generate-comment"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="generate-comment-1"><a href="#generate-comment-1"></a><span class="ot">delim ::</span> <span class="dt">Text</span></span>
<span id="generate-comment-2"><a href="#generate-comment-2"></a>delim <span class="ot">=</span> <span class="st">&quot; ~\\~ &quot;</span></span></code></pre></div>
</div>
<p>Given any content, the <code>comment</code> function generates a commented line following the above prescription.</p>
<div class="annotated-code">
<p><span><em>«comment-imports»+</em></span></p>
<div class="sourceCode" id="comment-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="comment-imports-1"><a href="#comment-imports-1"></a><span class="kw">import</span> <span class="dt">Document</span></span>
<span id="comment-imports-2"><a href="#comment-imports-2"></a>    ( <span class="dt">ProgrammingLanguage</span>(<span class="op">..</span>)</span>
<span id="comment-imports-3"><a href="#comment-imports-3"></a>    , <span class="dt">EntangledError</span>(<span class="op">..</span>) )</span>
<span id="comment-imports-4"><a href="#comment-imports-4"></a><span class="kw">import</span> <span class="dt">Config</span></span>
<span id="comment-imports-5"><a href="#comment-imports-5"></a>    ( <span class="dt">Language</span>(<span class="op">..</span>) )</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«generate-comment»+</em></span></p>
<div class="sourceCode" id="generate-comment"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="generate-comment-1"><a href="#generate-comment-1"></a><span class="ot">comment ::</span> <span class="dt">ProgrammingLanguage</span></span>
<span id="generate-comment-2"><a href="#generate-comment-2"></a>        <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="generate-comment-3"><a href="#generate-comment-3"></a>        <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">EntangledError</span> <span class="dt">Text</span></span>
<span id="generate-comment-4"><a href="#generate-comment-4"></a>comment (<span class="dt">UnknownClass</span> cls) _ <span class="ot">=</span> <span class="dt">Left</span> <span class="op">$</span> <span class="dt">UnknownLanguageClass</span> cls</span>
<span id="generate-comment-5"><a href="#generate-comment-5"></a>comment <span class="dt">NoLanguage</span>         _ <span class="ot">=</span> <span class="dt">Left</span> <span class="op">$</span> <span class="dt">MissingLanguageClass</span></span>
<span id="generate-comment-6"><a href="#generate-comment-6"></a>comment (<span class="dt">KnownLanguage</span> lang) text <span class="ot">=</span> <span class="dt">Right</span> <span class="op">$</span> formatComment lang text</span>
<span id="generate-comment-7"><a href="#generate-comment-7"></a></span>
<span id="generate-comment-8"><a href="#generate-comment-8"></a><span class="ot">formatComment ::</span> <span class="dt">Language</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="generate-comment-9"><a href="#generate-comment-9"></a>formatComment lang text <span class="ot">=</span> pre <span class="op">&lt;&gt;</span> text <span class="op">&lt;&gt;</span> post</span>
<span id="generate-comment-10"><a href="#generate-comment-10"></a>    <span class="kw">where</span> pre  <span class="ot">=</span> languageStartComment lang <span class="op">&lt;&gt;</span> delim</span>
<span id="generate-comment-11"><a href="#generate-comment-11"></a>          post <span class="ot">=</span> <span class="fu">maybe</span> <span class="st">&quot;&quot;</span> (<span class="st">&quot; &quot;</span> <span class="op">&lt;&gt;</span>) <span class="op">$</span> languageCloseComment lang</span></code></pre></div>
</div>
<p>Using this we can write the <code>annotateComment</code> function. Given a <code>ReferenceId</code> this retrieves the code text and annotates it with a begin and end comment line.</p>
<div class="annotated-code">
<p><span><em>«comment-imports»+</em></span></p>
<div class="sourceCode" id="comment-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="comment-imports-1"><a href="#comment-imports-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Strict</span> <span class="kw">as</span> <span class="dt">M</span></span>
<span id="comment-imports-2"><a href="#comment-imports-2"></a></span>
<span id="comment-imports-3"><a href="#comment-imports-3"></a><span class="kw">import</span> <span class="dt">Document</span></span>
<span id="comment-imports-4"><a href="#comment-imports-4"></a><span class="kw">import</span> <span class="dt">TextUtil</span> (unlines&#39;)</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«generate-comment»+</em></span></p>
<div class="sourceCode" id="generate-comment"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="generate-comment-1"><a href="#generate-comment-1"></a><span class="ot">annotateComment ::</span> <span class="dt">ReferenceMap</span> <span class="ot">-&gt;</span> <span class="dt">ReferenceId</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">EntangledError</span> <span class="dt">Text</span></span>
<span id="generate-comment-2"><a href="#generate-comment-2"></a>annotateComment refs ref <span class="ot">=</span> <span class="kw">do</span></span>
<span id="generate-comment-3"><a href="#generate-comment-3"></a>    <span class="kw">let</span> code <span class="ot">=</span> refs <span class="op">M.!</span> ref</span>
<span id="generate-comment-4"><a href="#generate-comment-4"></a>    pre <span class="ot">&lt;-</span> comment (codeLanguage code)</span>
<span id="generate-comment-5"><a href="#generate-comment-5"></a>           <span class="op">$</span> <span class="st">&quot;begin &lt;&lt;&quot;</span> <span class="op">&lt;&gt;</span> (unReferenceName <span class="op">$</span> referenceName ref) <span class="op">&lt;&gt;</span> <span class="st">&quot;&gt;&gt;[&quot;</span></span>
<span id="generate-comment-6"><a href="#generate-comment-6"></a>           <span class="op">&lt;&gt;</span> T.pack (<span class="fu">show</span> <span class="op">$</span> referenceCount ref) <span class="op">&lt;&gt;</span> <span class="st">&quot;]&quot;</span></span>
<span id="generate-comment-7"><a href="#generate-comment-7"></a>    post <span class="ot">&lt;-</span> comment (codeLanguage code) <span class="st">&quot;end&quot;</span></span>
<span id="generate-comment-8"><a href="#generate-comment-8"></a>    <span class="fu">return</span> <span class="op">$</span> unlines&#39; [pre, (codeSource code), post]</span>
<span id="generate-comment-9"><a href="#generate-comment-9"></a></span>
<span id="generate-comment-10"><a href="#generate-comment-10"></a><span class="ot">headerComment ::</span> <span class="dt">Language</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="generate-comment-11"><a href="#generate-comment-11"></a>headerComment lang path <span class="ot">=</span> formatComment lang</span>
<span id="generate-comment-12"><a href="#generate-comment-12"></a>    <span class="op">$</span> <span class="st">&quot;language=&quot;</span> <span class="op">&lt;&gt;</span> languageName lang <span class="op">&lt;&gt;</span> <span class="st">&quot; filename=&quot;</span> <span class="op">&lt;&gt;</span> T.pack path</span></code></pre></div>
</div>
<h3 id="parsing-comments">Parsing comments</h3>
<div class="annotated-code">
<p><span><em>«comment-imports»+</em></span></p>
<div class="sourceCode" id="comment-imports"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="comment-imports-1"><a href="#comment-imports-1"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec</span></span>
<span id="comment-imports-2"><a href="#comment-imports-2"></a>    ( <span class="dt">MonadParsec</span>, chunk, skipManyTill, anySingle, (<span class="op">&lt;?&gt;</span>), takeWhileP, eof )</span>
<span id="comment-imports-3"><a href="#comment-imports-3"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec.Char</span> (space)</span>
<span id="comment-imports-4"><a href="#comment-imports-4"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec.Char.Lexer</span></span>
<span id="comment-imports-5"><a href="#comment-imports-5"></a>    ( decimal )</span>
<span id="comment-imports-6"><a href="#comment-imports-6"></a></span>
<span id="comment-imports-7"><a href="#comment-imports-7"></a><span class="kw">import</span> <span class="dt">Document</span> (<span class="dt">CodeProperty</span>)</span>
<span id="comment-imports-8"><a href="#comment-imports-8"></a><span class="kw">import</span> <span class="dt">Attributes</span> (attributes, cssIdentifier)</span></code></pre></div>
</div>
<p>The same comment lines have to be parsed back when we untangle. The first line is the top header comment. We don’t know yet what the language is going to be, so we <code>skipManyTill</code> we find the <code>delim</code> text.</p>
<div class="annotated-code">
<p><span><em>«parse-comment»=</em></span></p>
<div class="sourceCode" id="parse-comment"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-comment-1"><a href="#parse-comment-1"></a><span class="ot">topHeader ::</span> ( <span class="dt">MonadParsec</span> e <span class="dt">Text</span> m )</span>
<span id="parse-comment-2"><a href="#parse-comment-2"></a>          <span class="ot">=&gt;</span> m [<span class="dt">CodeProperty</span>]</span>
<span id="parse-comment-3"><a href="#parse-comment-3"></a>topHeader <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-comment-4"><a href="#parse-comment-4"></a>    skipManyTill (anySingle <span class="op">&lt;?&gt;</span> <span class="st">&quot;open comment&quot;</span>)</span>
<span id="parse-comment-5"><a href="#parse-comment-5"></a>                 (chunk delim)</span>
<span id="parse-comment-6"><a href="#parse-comment-6"></a>    attributes</span></code></pre></div>
</div>
<p>Other parsers will always be combined with <code>commented</code>, giving the value of the original parser and a <code>Text</code> that gives the indentation level of the parsed comment.</p>
<div class="annotated-code">
<p><span><em>«parse-comment»+</em></span></p>
<div class="sourceCode" id="parse-comment"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-comment-1"><a href="#parse-comment-1"></a><span class="ot">commented ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-comment-2"><a href="#parse-comment-2"></a>          <span class="ot">=&gt;</span> <span class="dt">Language</span> <span class="ot">-&gt;</span> m a <span class="ot">-&gt;</span> m (a, <span class="dt">Text</span>)</span>
<span id="parse-comment-3"><a href="#parse-comment-3"></a>commented lang p <span class="ot">=</span> <span class="kw">do</span> </span>
<span id="parse-comment-4"><a href="#parse-comment-4"></a>    indent <span class="ot">&lt;-</span> takeWhileP (<span class="dt">Just</span> <span class="st">&quot;initial indent&quot;</span>) (<span class="ot">`elem`</span> (<span class="st">&quot; \t&quot;</span><span class="ot"> ::</span> [<span class="dt">Char</span>]))</span>
<span id="parse-comment-5"><a href="#parse-comment-5"></a>    pre <span class="ot">&lt;-</span> chunk <span class="op">$</span> (languageStartComment lang) <span class="op">&lt;&gt;</span> delim</span>
<span id="parse-comment-6"><a href="#parse-comment-6"></a>    x <span class="ot">&lt;-</span> p</span>
<span id="parse-comment-7"><a href="#parse-comment-7"></a>    post <span class="ot">&lt;-</span> chunk <span class="op">$</span> (<span class="fu">maybe</span> <span class="st">&quot;&quot;</span> <span class="fu">id</span> <span class="op">$</span> languageCloseComment lang)</span>
<span id="parse-comment-8"><a href="#parse-comment-8"></a>    space</span>
<span id="parse-comment-9"><a href="#parse-comment-9"></a>    eof</span>
<span id="parse-comment-10"><a href="#parse-comment-10"></a>    <span class="fu">return</span> (x, indent)</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«parse-comment»+</em></span></p>
<div class="sourceCode" id="parse-comment"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="parse-comment-1"><a href="#parse-comment-1"></a><span class="ot">beginBlock ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-comment-2"><a href="#parse-comment-2"></a>           <span class="ot">=&gt;</span> m <span class="dt">ReferenceId</span></span>
<span id="parse-comment-3"><a href="#parse-comment-3"></a>beginBlock <span class="ot">=</span> <span class="kw">do</span></span>
<span id="parse-comment-4"><a href="#parse-comment-4"></a>    chunk <span class="st">&quot;begin &lt;&lt;&quot;</span></span>
<span id="parse-comment-5"><a href="#parse-comment-5"></a>    name <span class="ot">&lt;-</span> cssIdentifier</span>
<span id="parse-comment-6"><a href="#parse-comment-6"></a>    chunk <span class="st">&quot;&gt;&gt;[&quot;</span></span>
<span id="parse-comment-7"><a href="#parse-comment-7"></a>    count <span class="ot">&lt;-</span> decimal</span>
<span id="parse-comment-8"><a href="#parse-comment-8"></a>    chunk <span class="st">&quot;]&quot;</span></span>
<span id="parse-comment-9"><a href="#parse-comment-9"></a>    <span class="fu">return</span> <span class="op">$</span> <span class="dt">ReferenceId</span> (<span class="dt">ReferenceName</span> name) count</span>
<span id="parse-comment-10"><a href="#parse-comment-10"></a></span>
<span id="parse-comment-11"><a href="#parse-comment-11"></a><span class="ot">endBlock ::</span> (<span class="dt">MonadParsec</span> e <span class="dt">Text</span> m)</span>
<span id="parse-comment-12"><a href="#parse-comment-12"></a>         <span class="ot">=&gt;</span> m ()</span>
<span id="parse-comment-13"><a href="#parse-comment-13"></a>endBlock <span class="ot">=</span> chunk <span class="st">&quot;end&quot;</span> <span class="op">&gt;&gt;</span> <span class="fu">return</span> ()</span></code></pre></div>
</div>
<h2 id="testing">Testing</h2>
<div class="annotated-code">
<p><span><em>«test/TangleSpec.hs»=</em></span></p>
<div class="sourceCode" id="cb31" data-file="test/TangleSpec.hs"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">module</span> <span class="dt">TangleSpec</span> <span class="kw">where</span></span>
<span id="cb31-2"><a href="#cb31-2"></a></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="kw">import</span> <span class="dt">Test.Hspec</span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="kw">import</span> <span class="dt">Test.Hspec.Megaparsec</span></span>
<span id="cb31-5"><a href="#cb31-5"></a></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="op">&lt;&lt;</span><span class="kw">import</span>-text&gt;&gt;</span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text.IO</span> <span class="kw">as</span> <span class="dt">T.IO</span></span>
<span id="cb31-8"><a href="#cb31-8"></a></span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Lazy</span> <span class="kw">as</span> <span class="dt">LM</span></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="kw">import</span> <span class="dt">Data.List</span> ((!!))</span>
<span id="cb31-11"><a href="#cb31-11"></a></span>
<span id="cb31-12"><a href="#cb31-12"></a><span class="kw">import</span> <span class="dt">Tangle</span></span>
<span id="cb31-13"><a href="#cb31-13"></a><span class="kw">import</span> <span class="dt">Attributes</span></span>
<span id="cb31-14"><a href="#cb31-14"></a><span class="kw">import</span> <span class="dt">Document</span></span>
<span id="cb31-15"><a href="#cb31-15"></a><span class="kw">import</span> <span class="dt">Config</span> (<span class="dt">Config</span>, defaultConfig, languageFromName)</span>
<span id="cb31-16"><a href="#cb31-16"></a><span class="kw">import</span> <span class="dt">ListStream</span></span>
<span id="cb31-17"><a href="#cb31-17"></a></span>
<span id="cb31-18"><a href="#cb31-18"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec</span> (parse, <span class="dt">Parsec</span>)</span>
<span id="cb31-19"><a href="#cb31-19"></a><span class="kw">import</span> <span class="dt">Text.Megaparsec.Error</span> (<span class="dt">ParseErrorBundle</span>)</span>
<span id="cb31-20"><a href="#cb31-20"></a><span class="kw">import</span> <span class="dt">Data.Void</span> (<span class="dt">Void</span>)</span>
<span id="cb31-21"><a href="#cb31-21"></a><span class="kw">import</span> <span class="dt">Control.Monad.Reader</span> (<span class="dt">ReaderT</span>, runReaderT, runReader)</span>
<span id="cb31-22"><a href="#cb31-22"></a><span class="kw">import</span> <span class="dt">Control.Monad.State</span> (<span class="dt">StateT</span>, evalStateT)</span>
<span id="cb31-23"><a href="#cb31-23"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span> (liftIO)</span>
<span id="cb31-24"><a href="#cb31-24"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> ((&lt;=&lt;))</span>
<span id="cb31-25"><a href="#cb31-25"></a></span>
<span id="cb31-26"><a href="#cb31-26"></a><span class="kw">import</span> <span class="dt">Data.Maybe</span> (fromJust)</span>
<span id="cb31-27"><a href="#cb31-27"></a><span class="kw">import</span> <span class="dt">Data.Either</span> (fromRight, rights)</span>
<span id="cb31-28"><a href="#cb31-28"></a></span>
<span id="cb31-29"><a href="#cb31-29"></a><span class="kw">type</span> <span class="dt">Parser</span> <span class="ot">=</span> <span class="dt">Parsec</span> <span class="dt">Void</span> <span class="dt">Text</span></span>
<span id="cb31-30"><a href="#cb31-30"></a></span>
<span id="cb31-31"><a href="#cb31-31"></a><span class="ot">p ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> (<span class="dt">ParseErrorBundle</span> <span class="dt">Text</span> <span class="dt">Void</span>) a</span>
<span id="cb31-32"><a href="#cb31-32"></a>p x t <span class="ot">=</span> parse x <span class="st">&quot;&quot;</span> t</span>
<span id="cb31-33"><a href="#cb31-33"></a></span>
<span id="cb31-34"><a href="#cb31-34"></a><span class="kw">type</span> <span class="dt">ParserC</span> <span class="ot">=</span> <span class="dt">StateT</span> <span class="dt">ReferenceCount</span> (<span class="dt">ReaderT</span> <span class="dt">Config</span> (<span class="dt">Parsec</span> <span class="dt">Void</span> (<span class="dt">ListStream</span> <span class="dt">Text</span>)))</span>
<span id="cb31-35"><a href="#cb31-35"></a></span>
<span id="cb31-36"><a href="#cb31-36"></a><span class="ot">pc ::</span> <span class="dt">ParserC</span> a <span class="ot">-&gt;</span> <span class="dt">ListStream</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> (<span class="dt">ParseErrorBundle</span> (<span class="dt">ListStream</span> <span class="dt">Text</span>) <span class="dt">Void</span>) a</span>
<span id="cb31-37"><a href="#cb31-37"></a>pc x t <span class="ot">=</span> parse (runReaderT (evalStateT x <span class="fu">mempty</span>) defaultConfig) <span class="st">&quot;&quot;</span> t</span>
<span id="cb31-38"><a href="#cb31-38"></a></span>
<span id="cb31-39"><a href="#cb31-39"></a><span class="ot">pd ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">EntangledError</span> <span class="dt">Document</span></span>
<span id="cb31-40"><a href="#cb31-40"></a>pd t <span class="ot">=</span> runReader (parseMarkdown <span class="st">&quot;&quot;</span> t) defaultConfig</span>
<span id="cb31-41"><a href="#cb31-41"></a></span>
<span id="cb31-42"><a href="#cb31-42"></a><span class="ot">tangleSpec ::</span> <span class="dt">Spec</span></span>
<span id="cb31-43"><a href="#cb31-43"></a>tangleSpec <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-44"><a href="#cb31-44"></a>    describe <span class="st">&quot;Parsing fenced code attributes&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-45"><a href="#cb31-45"></a>        it <span class="st">&quot;parses a class&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-46"><a href="#cb31-46"></a>            p codeClass <span class="st">&quot;.hello&quot;</span> <span class="ot">`shouldParse`</span> <span class="dt">CodeClass</span> <span class="st">&quot;hello&quot;</span></span>
<span id="cb31-47"><a href="#cb31-47"></a>            p codeClass <span class="ot">`shouldFailOn`</span> <span class="st">&quot;nodot&quot;</span></span>
<span id="cb31-48"><a href="#cb31-48"></a>            p codeClass <span class="ot">`shouldFailOn`</span> <span class="st">&quot;.====&quot;</span></span>
<span id="cb31-49"><a href="#cb31-49"></a>        it <span class="st">&quot;parses an id&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-50"><a href="#cb31-50"></a>            p codeId <span class="st">&quot;#world&quot;</span> <span class="ot">`shouldParse`</span> <span class="dt">CodeId</span> <span class="st">&quot;world&quot;</span></span>
<span id="cb31-51"><a href="#cb31-51"></a>            p codeId <span class="ot">`shouldFailOn`</span> <span class="st">&quot;nosharp&quot;</span></span>
<span id="cb31-52"><a href="#cb31-52"></a>            p codeId <span class="ot">`shouldFailOn`</span> <span class="st">&quot;#{}{}{&quot;</span></span>
<span id="cb31-53"><a href="#cb31-53"></a>        it <span class="st">&quot;parses an attribute&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-54"><a href="#cb31-54"></a>            p codeAttribute <span class="st">&quot;file=hello.c&quot;</span> <span class="ot">`shouldParse`</span> <span class="dt">CodeAttribute</span> <span class="st">&quot;file&quot;</span> <span class="st">&quot;hello.c&quot;</span></span>
<span id="cb31-55"><a href="#cb31-55"></a>            p codeAttribute <span class="st">&quot;empty= value&quot;</span> <span class="ot">`shouldParse`</span> <span class="dt">CodeAttribute</span> <span class="st">&quot;empty&quot;</span> <span class="st">&quot;&quot;</span></span>
<span id="cb31-56"><a href="#cb31-56"></a>            p codeAttribute <span class="ot">`shouldFailOn`</span> <span class="st">&quot;{}=&quot;</span></span>
<span id="cb31-57"><a href="#cb31-57"></a>        it <span class="st">&quot;parses a header&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-58"><a href="#cb31-58"></a>            p codeHeader <span class="st">&quot;``` {.class #id key=value}&quot;</span> <span class="ot">`shouldParse`</span></span>
<span id="cb31-59"><a href="#cb31-59"></a>                [<span class="dt">CodeClass</span> <span class="st">&quot;class&quot;</span>, <span class="dt">CodeId</span> <span class="st">&quot;id&quot;</span>, <span class="dt">CodeAttribute</span> <span class="st">&quot;key&quot;</span> <span class="st">&quot;value&quot;</span>]</span>
<span id="cb31-60"><a href="#cb31-60"></a>            p codeHeader <span class="ot">`shouldFailOn`</span> <span class="st">&quot;``` {key==blah}&quot;</span></span>
<span id="cb31-61"><a href="#cb31-61"></a>            p codeHeader <span class="ot">`shouldFailOn`</span> <span class="st">&quot;``` {key}&quot;</span></span>
<span id="cb31-62"><a href="#cb31-62"></a>        it <span class="st">&quot;respects and disrespects whitespace where needed&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-63"><a href="#cb31-63"></a>            p codeHeader <span class="st">&quot;```{}&quot;</span> <span class="ot">`shouldParse`</span> []</span>
<span id="cb31-64"><a href="#cb31-64"></a>            p codeHeader <span class="st">&quot;```   {}  &quot;</span> <span class="ot">`shouldParse`</span> []</span>
<span id="cb31-65"><a href="#cb31-65"></a>            p codeHeader <span class="ot">`shouldFailOn`</span> <span class="st">&quot;   ```{}&quot;</span></span>
<span id="cb31-66"><a href="#cb31-66"></a></span>
<span id="cb31-67"><a href="#cb31-67"></a>    describe <span class="st">&quot;Parsing a code block&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-68"><a href="#cb31-68"></a>        <span class="kw">let</span> test1 <span class="ot">=</span> <span class="dt">ListStream</span></span>
<span id="cb31-69"><a href="#cb31-69"></a>                    [ <span class="st">&quot;``` {.python #hello-world}&quot;</span></span>
<span id="cb31-70"><a href="#cb31-70"></a>                    , <span class="st">&quot;print(\&quot;Hello, World!\&quot;)&quot;</span></span>
<span id="cb31-71"><a href="#cb31-71"></a>                    , <span class="st">&quot;```&quot;</span> ]</span>
<span id="cb31-72"><a href="#cb31-72"></a>            python <span class="ot">=</span> fromJust <span class="op">$</span> languageFromName defaultConfig <span class="st">&quot;Python&quot;</span></span>
<span id="cb31-73"><a href="#cb31-73"></a>        it <span class="st">&quot;parses a code block&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-74"><a href="#cb31-74"></a>            pc codeBlock test1 <span class="ot">`shouldParse`</span></span>
<span id="cb31-75"><a href="#cb31-75"></a>                ( [ <span class="dt">PlainText</span> <span class="st">&quot;``` {.python #hello-world}&quot;</span></span>
<span id="cb31-76"><a href="#cb31-76"></a>                  , <span class="dt">Reference</span> <span class="op">$</span> <span class="dt">ReferenceId</span> (<span class="dt">ReferenceName</span> <span class="st">&quot;hello-world&quot;</span>) <span class="dv">0</span></span>
<span id="cb31-77"><a href="#cb31-77"></a>                  , <span class="dt">PlainText</span> <span class="st">&quot;```&quot;</span> ]</span>
<span id="cb31-78"><a href="#cb31-78"></a>                , [ ( <span class="dt">ReferenceId</span> (<span class="dt">ReferenceName</span> <span class="st">&quot;hello-world&quot;</span>) <span class="dv">0</span></span>
<span id="cb31-79"><a href="#cb31-79"></a>                    , <span class="dt">CodeBlock</span> (<span class="dt">KnownLanguage</span> python)</span>
<span id="cb31-80"><a href="#cb31-80"></a>                                [<span class="dt">CodeClass</span> <span class="st">&quot;python&quot;</span>, <span class="dt">CodeId</span> <span class="st">&quot;hello-world&quot;</span>]</span>
<span id="cb31-81"><a href="#cb31-81"></a>                                <span class="st">&quot;print(\&quot;Hello, World!\&quot;)&quot;</span></span>
<span id="cb31-82"><a href="#cb31-82"></a>                    ) ]</span>
<span id="cb31-83"><a href="#cb31-83"></a>                )</span>
<span id="cb31-84"><a href="#cb31-84"></a></span>
<span id="cb31-85"><a href="#cb31-85"></a><span class="ot">tangleEqualSpec ::</span> <span class="dt">Spec</span></span>
<span id="cb31-86"><a href="#cb31-86"></a>tangleEqualSpec <span class="ot">=</span> before (<span class="fu">sequence</span> <span class="op">$</span> <span class="fu">map</span> T.IO.readFile testFiles) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-87"><a href="#cb31-87"></a>    describe <span class="st">&quot;Code expansion on test0[1-3].md&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb31-88"><a href="#cb31-88"></a>        it <span class="st">&quot;expands to identical code&quot;</span> <span class="op">$</span> \files <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb31-89"><a href="#cb31-89"></a>            <span class="kw">let</span> docs <span class="ot">=</span> rights <span class="op">$</span> <span class="fu">map</span> pd files</span>
<span id="cb31-90"><a href="#cb31-90"></a>                codes <span class="ot">=</span> <span class="fu">map</span> (expandedCode annotateNaked) docs</span>
<span id="cb31-91"><a href="#cb31-91"></a>                hellos <span class="ot">=</span> <span class="fu">map</span> (<span class="op">LM.!</span> (<span class="dt">ReferenceName</span> <span class="st">&quot;hello.cc&quot;</span>)) codes</span>
<span id="cb31-92"><a href="#cb31-92"></a>            hellos <span class="ot">`shouldBe`</span> (<span class="fu">replicate</span> <span class="dv">3</span> (hellos <span class="op">!!</span> <span class="dv">0</span>))</span>
<span id="cb31-93"><a href="#cb31-93"></a>    <span class="kw">where</span> testFiles <span class="ot">=</span> [<span class="st">&quot;test/test01.md&quot;</span>, <span class="st">&quot;test/test02.md&quot;</span>, <span class="st">&quot;test/test03.md&quot;</span>]</span></code></pre></div>
</div>
</div>
</html>
